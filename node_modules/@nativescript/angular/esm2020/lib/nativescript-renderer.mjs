import { __decorate, __metadata, __param } from "tslib";
import { Inject, Injectable, Optional, RendererStyleFlags2, ViewEncapsulation } from '@angular/core';
import { addTaggedAdditionalCSS, Application, ContentView, getViewById, Observable, profile, View } from '@nativescript/core';
import { isKnownView } from './element-registry';
import { getFirstNativeLikeView } from './views';
import { NAMESPACE_FILTERS } from './property-filter';
import { APP_ROOT_VIEW, ENABLE_REUSABE_VIEWS, NATIVESCRIPT_ROOT_MODULE_ID } from './tokens';
import { NativeScriptDebug } from './trace';
import { ViewUtil } from './view-util';
import * as i0 from "@angular/core";
import * as i1 from "@nativescript/core";
const addStyleToCss = profile('"renderer".addStyleToCss', function addStyleToCss(style, tag) {
    if (tag) {
        addTaggedAdditionalCSS(style, tag);
    }
    else {
        Application.addCss(style);
    }
});
function runInRootZone(fn) {
    if (typeof Zone === 'undefined') {
        return fn();
    }
    return Zone.root.run(fn);
}
function inRootZone() {
    return function (target, key, descriptor) {
        const childFunction = descriptor.value;
        descriptor.value = function (...args) {
            const fn = childFunction.bind(this);
            return runInRootZone(() => fn(...args));
        };
        return descriptor;
    };
}
let NativeScriptRendererFactory = class NativeScriptRendererFactory {
    constructor(rootView, namespaceFilters, rootModuleID, reuseViews) {
        this.rootView = rootView;
        this.namespaceFilters = namespaceFilters;
        this.rootModuleID = rootModuleID;
        this.reuseViews = reuseViews;
        this.componentRenderers = new Map();
        // backwards compatibility with RadListView
        this.viewUtil = new ViewUtil(this.namespaceFilters, this.reuseViews);
        if (typeof this.reuseViews !== 'boolean') {
            this.reuseViews = false; // default to false
        }
        this.defaultRenderer = new NativeScriptRenderer(rootView, namespaceFilters, this.reuseViews);
    }
    createRenderer(hostElement, type) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRendererFactory.createRenderer ${hostElement}. type.id: ${type.id} type.encapsulation: ${type.encapsulation}`);
        }
        if (!hostElement || !type) {
            return this.defaultRenderer;
        }
        let renderer = this.componentRenderers.get(type.id);
        /**
         *! WARNING
         *! We're reusing the renderer for the components
         *! this might cause unexpected behavior as the "rootView" is an arbitrary hostElement
         *! also, the renderer has it's .destroy() called!
         *! might be useful to create a BaseEmulatedRender and a ProxyEmulatedRender
         *! every component type gets a BaseEmulatedRender (singleton) which is passed to ProxyEmulatedRender
         *! ProxyEmulatedRenderer registers with BaseEmulatedRender so we can clean up things like CSS when it's not needed
         *! this might be useful if we find a way to HMR component styling without a full rebootstrap
         */
        if (renderer) {
            if (renderer instanceof EmulatedRenderer) {
                renderer.applyToHost(hostElement);
            }
            return renderer;
        }
        if (type.encapsulation === ViewEncapsulation.None) {
            type.styles.map((s) => s.toString()).forEach((v) => addStyleToCss(v, this.rootModuleID));
            renderer = this.defaultRenderer;
        }
        else {
            renderer = new EmulatedRenderer(type, hostElement, this.namespaceFilters, this.rootModuleID, this.reuseViews);
            renderer.applyToHost(hostElement);
        }
        this.componentRenderers.set(type.id, renderer);
        return renderer;
    }
    // begin?(): void {
    //     throw new Error("Method not implemented.");
    // }
    // end?(): void {
    //     throw new Error("Method not implemented.");
    // }
    whenRenderingDone() {
        if (!this.rootView) {
            return Promise.resolve();
        }
        return new Promise((resolve) => {
            let interval = 0;
            function scheduleResolve() {
                // iOS really hates synchronous things...
                // Utils.queueMacrotask(resolve);
                setTimeout(resolve, 15);
            }
            function fireWhenLoaded() {
                const view = rootFactory();
                if (view.isLoaded) {
                    scheduleResolve();
                }
                else {
                    view.once('loaded', scheduleResolve);
                }
            }
            const rootFactory = () => (this.rootView instanceof ContentView ? this.rootView.content : this.rootView);
            if (!rootFactory()) {
                interval = setInterval(() => {
                    if (rootFactory()) {
                        clearInterval(interval);
                        fireWhenLoaded();
                    }
                }, 10);
            }
            else {
                fireWhenLoaded();
            }
        });
        // throw new Error("Method not implemented.");
    }
};
NativeScriptRendererFactory = __decorate([
    __param(0, Inject(APP_ROOT_VIEW)),
    __param(1, Inject(NAMESPACE_FILTERS)),
    __param(2, Inject(NATIVESCRIPT_ROOT_MODULE_ID)),
    __param(3, Optional()),
    __param(3, Inject(ENABLE_REUSABE_VIEWS)),
    __metadata("design:paramtypes", [View, Array, Object, Object])
], NativeScriptRendererFactory);
export { NativeScriptRendererFactory };
class NativeScriptRenderer {
    constructor(rootView, namespaceFilters, reuseViews) {
        this.rootView = rootView;
        this.namespaceFilters = namespaceFilters;
        this.reuseViews = reuseViews;
        this.viewUtil = new ViewUtil(this.namespaceFilters, this.reuseViews);
        this.destroyNode = (node) => runInRootZone(() => {
            if (NativeScriptDebug.enabled) {
                NativeScriptDebug.rendererLog(`NativeScriptRenderer.destroyNode node: ${node}`);
            }
            if (node?.destroyNode) {
                node?.destroyNode();
            }
        });
    }
    get data() {
        throw new Error('Method not implemented.');
    }
    destroy() {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog('NativeScriptRenderer.destroy');
        }
    }
    createElement(name, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createElement: ${name}`);
        }
        let oldName;
        if (!isKnownView(name)) {
            oldName = name;
            name = 'ProxyViewContainer';
        }
        const view = this.viewUtil.createView(name);
        if (oldName) {
            view.customCSSName = oldName;
        }
        return view;
    }
    createComment(value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createComment ${value}`);
        }
        return this.viewUtil.createComment(value);
    }
    createText(value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createText ${value}`);
        }
        return this.viewUtil.createText(value);
    }
    appendChild(parent, newChild) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.appendChild child: ${newChild} parent: ${parent}`);
        }
        this.viewUtil.appendChild(parent, newChild);
    }
    insertBefore(parent, newChild, refChild) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.insertBefore child: ${newChild} ` + `parent: ${parent} refChild: ${refChild}`);
        }
        this.viewUtil.insertBefore(parent, newChild, refChild);
    }
    removeChild(parent, oldChild, isHostElement) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeChild child: ${oldChild} parent: ${parent}`);
        }
        this.viewUtil.removeChild(parent, oldChild);
    }
    selectRootElement(selectorOrNode, preserveContent) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.selectRootElement: ${selectorOrNode}`);
        }
        if (selectorOrNode instanceof View) {
            return selectorOrNode;
        }
        if (selectorOrNode && selectorOrNode[0] === '#') {
            const result = getViewById(this.rootView, selectorOrNode.slice(1));
            return (result || this.rootView);
        }
        if (typeof selectorOrNode === 'string') {
            const view = this.viewUtil.createView(selectorOrNode);
            if (getFirstNativeLikeView(view) === view) {
                // view is nativelike!
                this.appendChild(this.rootView, view);
                return view;
            }
        }
        return this.rootView;
    }
    parentNode(node) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.parentNode for node: ${node} is ${node.parentNode}`);
        }
        return node.parentNode;
    }
    nextSibling(node) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.nextSibling of ${node} is ${node.nextSibling}`);
        }
        return node.nextSibling;
    }
    setAttribute(el, name, value, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setAttribute ${namespace ? namespace + ':' : ''}${el}.${name} = ${value}`);
        }
        this.viewUtil.setProperty(el, name, value, namespace);
    }
    removeAttribute(el, name, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeAttribute ${namespace ? namespace + ':' : ''}${el}.${name}`);
        }
    }
    addClass(el, name) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.addClass ${name}`);
        }
        this.viewUtil.addClass(el, name);
    }
    removeClass(el, name) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeClass ${name}`);
        }
        this.viewUtil.removeClass(el, name);
    }
    setStyle(el, style, value, flags) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setStyle: ${el}, ${style} = ${value}`);
        }
        this.viewUtil.setStyle(el, style, value);
    }
    removeStyle(el, style, flags) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog('NativeScriptRenderer.removeStyle: ${styleName}');
        }
        this.viewUtil.removeStyle(el, style);
    }
    setProperty(el, name, value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setProperty ${el}.${name} = ${value}`);
        }
        this.viewUtil.setProperty(el, name, value);
    }
    setValue(node, value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setValue renderNode: ${node}, value: ${value}`);
        }
        // throw new Error("Method not implemented.");
    }
    listen(target, eventName, callback) {
        // throw new Error("Method not implemented.");
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.listen: ${eventName}`);
        }
        target.on(eventName, callback);
        if (eventName === View.loadedEvent && target.isLoaded) {
            // we must create a new obervable here to ensure that the event goes through whatever zone patches are applied
            const obs = new Observable();
            obs.once(eventName, callback);
            obs.notify({
                eventName,
                object: target,
            });
        }
        return () => target.off(eventName, callback);
    }
}
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createElement", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createComment", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createText", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [View, View]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "appendChild", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, Object]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "insertBefore", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, Boolean]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeChild", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setAttribute", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "addClass", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeClass", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Object, Number]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setStyle", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Number]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeStyle", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Object]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setProperty", null);
// CONTENT_ATTR not exported from nativescript-renderer - we need it for styles application.
const COMPONENT_REGEX = /%COMP%/g;
const ATTR_SANITIZER = /-/g;
export const COMPONENT_VARIABLE = '%COMP%';
export const HOST_ATTR = `_nghost-${COMPONENT_VARIABLE}`;
export const CONTENT_ATTR = `_ngcontent-${COMPONENT_VARIABLE}`;
const replaceNgAttribute = function (input, componentId) {
    return input.replace(COMPONENT_REGEX, componentId);
};
const addScopedStyleToCss = profile(`"renderer".addScopedStyleToCss`, function addScopedStyleToCss(style, tag) {
    if (tag) {
        addTaggedAdditionalCSS(style, tag);
    }
    else {
        Application.addCss(style);
    }
});
export class EmulatedRenderer extends NativeScriptRenderer {
    constructor(component, rootView, namespaceFilters, rootModuleId, reuseViews) {
        super(rootView, namespaceFilters, reuseViews);
        this.rootModuleId = rootModuleId;
        const componentId = component.id.replace(ATTR_SANITIZER, '_');
        this.contentAttr = replaceNgAttribute(CONTENT_ATTR, componentId);
        this.hostAttr = replaceNgAttribute(HOST_ATTR, componentId);
        this.addStyles(component.styles, componentId);
    }
    applyToHost(view) {
        super.setAttribute(view, this.hostAttr, '');
    }
    appendChild(parent, newChild) {
        super.appendChild(parent, newChild);
    }
    createElement(parent, name) {
        const view = super.createElement(parent, name);
        // Set an attribute to the view to scope component-specific css.
        // The property name is pre-generated by Angular.
        super.setAttribute(view, this.contentAttr, '');
        return view;
    }
    addStyles(styles, componentId) {
        styles
            .map((s) => s.toString())
            .map((s) => replaceNgAttribute(s, componentId))
            .forEach((s) => addScopedStyleToCss(s, this.rootModuleId));
    }
}
EmulatedRenderer.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: EmulatedRenderer, deps: "invalid", target: i0.ɵɵFactoryTarget.Injectable });
EmulatedRenderer.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: EmulatedRenderer });
__decorate([
    profile,
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Array, String]),
    __metadata("design:returntype", void 0)
], EmulatedRenderer.prototype, "addStyles", null);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: EmulatedRenderer, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined }, { type: i1.View }, { type: undefined }, { type: undefined }, { type: undefined }]; }, propDecorators: { addStyles: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlc2NyaXB0LXJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL25hdGl2ZXNjcmlwdC1yZW5kZXJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQVUsUUFBUSxFQUErQixtQkFBbUIsRUFBaUIsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekosT0FBTyxFQUFFLHNCQUFzQixFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQVUsV0FBVyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQVMsSUFBSSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDN0ksT0FBTyxFQUFnQixXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsc0JBQXNCLEVBQVUsTUFBTSxTQUFTLENBQUM7QUFFekQsT0FBTyxFQUFtQixpQkFBaUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxhQUFhLEVBQUUsb0JBQW9CLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDNUYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzVDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7OztBQUV2QyxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsMEJBQTBCLEVBQUUsU0FBUyxhQUFhLENBQUMsS0FBYSxFQUFFLEdBQXFCO0lBQ25ILElBQUksR0FBRyxFQUFFO1FBQ1Asc0JBQXNCLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0tBQ3BDO1NBQU07UUFDTCxXQUFXLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQzNCO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCxTQUFTLGFBQWEsQ0FBSSxFQUFXO0lBQ25DLElBQUksT0FBTyxJQUFJ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b25hbCwgUmVuZGVyZXIyLCBSZW5kZXJlckZhY3RvcnkyLCBSZW5kZXJlclN0eWxlRmxhZ3MyLCBSZW5kZXJlclR5cGUyLCBWaWV3RW5jYXBzdWxhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgYWRkVGFnZ2VkQWRkaXRpb25hbENTUywgQXBwbGljYXRpb24sIENvbnRlbnRWaWV3LCBEZXZpY2UsIGdldFZpZXdCeUlkLCBPYnNlcnZhYmxlLCBwcm9maWxlLCBVdGlscywgVmlldyB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBnZXRWaWV3Q2xhc3MsIGlzS25vd25WaWV3IH0gZnJvbSAnLi9lbGVtZW50LXJlZ2lzdHJ5JztcbmltcG9ydCB7IGdldEZpcnN0TmF0aXZlTGlrZVZpZXcsIE5nVmlldyB9IGZyb20gJy4vdmlld3MnO1xuXG5pbXBvcnQgeyBOYW1lc3BhY2VGaWx0ZXIsIE5BTUVTUEFDRV9GSUxURVJTIH0gZnJvbSAnLi9wcm9wZXJ0eS1maWx0ZXInO1xuaW1wb3J0IHsgQVBQX1JPT1RfVklFVywgRU5BQkxFX1JFVVNBQkVfVklFV1MsIE5BVElWRVNDUklQVF9ST09UX01PRFVMRV9JRCB9IGZyb20gJy4vdG9rZW5zJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi90cmFjZSc7XG5pbXBvcnQgeyBWaWV3VXRpbCB9IGZyb20gJy4vdmlldy11dGlsJztcblxuY29uc3QgYWRkU3R5bGVUb0NzcyA9IHByb2ZpbGUoJ1wicmVuZGVyZXJcIi5hZGRTdHlsZVRvQ3NzJywgZnVuY3Rpb24gYWRkU3R5bGVUb0NzcyhzdHlsZTogc3RyaW5nLCB0YWc/OiBzdHJpbmcgfCBudW1iZXIpOiB2b2lkIHtcbiAgaWYgKHRhZykge1xuICAgIGFkZFRhZ2dlZEFkZGl0aW9uYWxDU1Moc3R5bGUsIHRhZyk7XG4gIH0gZWxzZSB7XG4gICAgQXBwbGljYXRpb24uYWRkQ3NzKHN0eWxlKTtcbiAgfVxufSk7XG5cbmZ1bmN0aW9uIHJ1bkluUm9vdFpvbmU8VD4oZm46ICgpID0+IFQpOiBUIHtcbiAgaWYgKHR5cGVvZiBab25lID09PSAndW5kZWZpbmVkJykge1xuICAgIHJldHVybiBmbigpO1xuICB9XG4gIHJldHVybiBab25lLnJvb3QucnVuKGZuKTtcbn1cblxuZnVuY3Rpb24gaW5Sb290Wm9uZSgpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQ6IE9iamVjdCwga2V5OiBzdHJpbmcgfCBzeW1ib2wsIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcikge1xuICAgIGNvbnN0IGNoaWxkRnVuY3Rpb24gPSBkZXNjcmlwdG9yLnZhbHVlO1xuICAgIGRlc2NyaXB0b3IudmFsdWUgPSBmdW5jdGlvbiAoLi4uYXJnczogYW55W10pIHtcbiAgICAgIGNvbnN0IGZuID0gY2hpbGRGdW5jdGlvbi5iaW5kKHRoaXMpO1xuICAgICAgcmV0dXJuIHJ1bkluUm9vdFpvbmUoKCkgPT4gZm4oLi4uYXJncykpO1xuICAgIH07XG4gICAgcmV0dXJuIGRlc2NyaXB0b3I7XG4gIH07XG59XG5cbmV4cG9ydCBjbGFzcyBOYXRpdmVTY3JpcHRSZW5kZXJlckZhY3RvcnkgaW1wbGVtZW50cyBSZW5kZXJlckZhY3RvcnkyIHtcbiAgcHJpdmF0ZSBjb21wb25lbnRSZW5kZXJlcnMgPSBuZXcgTWFwPHN0cmluZywgUmVuZGVyZXIyPigpO1xuICBwcml2YXRlIGRlZmF1bHRSZW5kZXJlcjogUmVuZGVyZXIyO1xuICAvLyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIFJhZExpc3RWaWV3XG4gIHByaXZhdGUgdmlld1V0aWwgPSBuZXcgVmlld1V0aWwodGhpcy5uYW1lc3BhY2VGaWx0ZXJzLCB0aGlzLnJldXNlVmlld3MpO1xuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoQVBQX1JPT1RfVklFVykgcHJpdmF0ZSByb290VmlldzogVmlldywgQEluamVjdChOQU1FU1BBQ0VfRklMVEVSUykgcHJpdmF0ZSBuYW1lc3BhY2VGaWx0ZXJzOiBOYW1lc3BhY2VGaWx0ZXJbXSwgQEluamVjdChOQVRJVkVTQ1JJUFRfUk9PVF9NT0RVTEVfSUQpIHByaXZhdGUgcm9vdE1vZHVsZUlEOiBzdHJpbmcgfCBudW1iZXIsIEBPcHRpb25hbCgpIEBJbmplY3QoRU5BQkxFX1JFVVNBQkVfVklFV1MpIHByaXZhdGUgcmV1c2VWaWV3cykge1xuICAgIGlmICh0eXBlb2YgdGhpcy5yZXVzZVZpZXdzICE9PSAnYm9vbGVhbicpIHtcbiAgICAgIHRoaXMucmV1c2VWaWV3cyA9IGZhbHNlOyAvLyBkZWZhdWx0IHRvIGZhbHNlXG4gICAgfVxuICAgIHRoaXMuZGVmYXVsdFJlbmRlcmVyID0gbmV3IE5hdGl2ZVNjcmlwdFJlbmRlcmVyKHJvb3RWaWV3LCBuYW1lc3BhY2VGaWx0ZXJzLCB0aGlzLnJldXNlVmlld3MpO1xuICB9XG4gIGNyZWF0ZVJlbmRlcmVyKGhvc3RFbGVtZW50OiBhbnksIHR5cGU6IFJlbmRlcmVyVHlwZTIpOiBSZW5kZXJlcjIge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXJGYWN0b3J5LmNyZWF0ZVJlbmRlcmVyICR7aG9zdEVsZW1lbnR9LiB0eXBlLmlkOiAke3R5cGUuaWR9IHR5cGUuZW5jYXBzdWxhdGlvbjogJHt0eXBlLmVuY2Fwc3VsYXRpb259YCk7XG4gICAgfVxuICAgIGlmICghaG9zdEVsZW1lbnQgfHwgIXR5cGUpIHtcbiAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRSZW5kZXJlcjtcbiAgICB9XG5cbiAgICBsZXQgcmVuZGVyZXIgPSB0aGlzLmNvbXBvbmVudFJlbmRlcmVycy5nZXQodHlwZS5pZCk7XG4gICAgLyoqXG4gICAgICohIFdBUk5JTkdcbiAgICAgKiEgV2UncmUgcmV1c2luZyB0aGUgcmVuZGVyZXIgZm9yIHRoZSBjb21wb25lbnRzXG4gICAgICohIHRoaXMgbWlnaHQgY2F1c2UgdW5leHBlY3RlZCBiZWhhdmlvciBhcyB0aGUgXCJyb290Vmlld1wiIGlzIGFuIGFyYml0cmFyeSBob3N0RWxlbWVudFxuICAgICAqISBhbHNvLCB0aGUgcmVuZGVyZXIgaGFzIGl0J3MgLmRlc3Ryb3koKSBjYWxsZWQhXG4gICAgICohIG1pZ2h0IGJlIHVzZWZ1bCB0byBjcmVhdGUgYSBCYXNlRW11bGF0ZWRSZW5kZXIgYW5kIGEgUHJveHlFbXVsYXRlZFJlbmRlclxuICAgICAqISBldmVyeSBjb21wb25lbnQgdHlwZSBnZXRzIGEgQmFzZUVtdWxhdGVkUmVuZGVyIChzaW5nbGV0b24pIHdoaWNoIGlzIHBhc3NlZCB0byBQcm94eUVtdWxhdGVkUmVuZGVyXG4gICAgICohIFByb3h5RW11bGF0ZWRSZW5kZXJlciByZWdpc3RlcnMgd2l0aCBCYXNlRW11bGF0ZWRSZW5kZXIgc28gd2UgY2FuIGNsZWFuIHVwIHRoaW5ncyBsaWtlIENTUyB3aGVuIGl0J3Mgbm90IG5lZWRlZFxuICAgICAqISB0aGlzIG1pZ2h0IGJlIHVzZWZ1bCBpZiB3ZSBmaW5kIGEgd2F5IHRvIEhNUiBjb21wb25lbnQgc3R5bGluZyB3aXRob3V0IGEgZnVsbCByZWJvb3RzdHJhcFxuICAgICAqL1xuICAgIGlmIChyZW5kZXJlcikge1xuICAgICAgaWYgKHJlbmRlcmVyIGluc3RhbmNlb2YgRW11bGF0ZWRSZW5kZXJlcikge1xuICAgICAgICByZW5kZXJlci5hcHBseVRvSG9zdChob3N0RWxlbWVudCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZW5kZXJlcjtcbiAgICB9XG5cbiAgICBpZiAodHlwZS5lbmNhcHN1bGF0aW9uID09PSBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lKSB7XG4gICAgICB0eXBlLnN0eWxlcy5tYXAoKHMpID0+IHMudG9TdHJpbmcoKSkuZm9yRWFjaCgodikgPT4gYWRkU3R5bGVUb0Nzcyh2LCB0aGlzLnJvb3RNb2R1bGVJRCkpO1xuICAgICAgcmVuZGVyZXIgPSB0aGlzLmRlZmF1bHRSZW5kZXJlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVuZGVyZXIgPSBuZXcgRW11bGF0ZWRSZW5kZXJlcih0eXBlLCBob3N0RWxlbWVudCwgdGhpcy5uYW1lc3BhY2VGaWx0ZXJzLCB0aGlzLnJvb3RNb2R1bGVJRCwgdGhpcy5yZXVzZVZpZXdzKTtcbiAgICAgICg8RW11bGF0ZWRSZW5kZXJlcj5yZW5kZXJlcikuYXBwbHlUb0hvc3QoaG9zdEVsZW1lbnQpO1xuICAgIH1cblxuICAgIHRoaXMuY29tcG9uZW50UmVuZGVyZXJzLnNldCh0eXBlLmlkLCByZW5kZXJlcik7XG4gICAgcmV0dXJuIHJlbmRlcmVyO1xuICB9XG4gIC8vIGJlZ2luPygpOiB2b2lkIHtcbiAgLy8gICAgIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xuICAvLyB9XG4gIC8vIGVuZD8oKTogdm9pZCB7XG4gIC8vICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcbiAgLy8gfVxuICB3aGVuUmVuZGVyaW5nRG9uZSgpOiBQcm9taXNlPGFueT4ge1xuICAgIGlmICghdGhpcy5yb290Vmlldykge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcbiAgICAgIGxldCBpbnRlcnZhbDogYW55ID0gMDtcbiAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlUmVzb2x2ZSgpIHtcbiAgICAgICAgLy8gaU9TIHJlYWxseSBoYXRlcyBzeW5jaHJvbm91cyB0aGluZ3MuLi5cbiAgICAgICAgLy8gVXRpbHMucXVldWVNYWNyb3Rhc2socmVzb2x2ZSk7XG4gICAgICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgMTUpO1xuICAgICAgfVxuICAgICAgZnVuY3Rpb24gZmlyZVdoZW5Mb2FkZWQoKSB7XG4gICAgICAgIGNvbnN0IHZpZXcgPSByb290RmFjdG9yeSgpO1xuICAgICAgICBpZiAodmlldy5pc0xvYWRlZCkge1xuICAgICAgICAgIHNjaGVkdWxlUmVzb2x2ZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHZpZXcub25jZSgnbG9hZGVkJywgc2NoZWR1bGVSZXNvbHZlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3Qgcm9vdEZhY3RvcnkgPSAoKSA9PiAodGhpcy5yb290VmlldyBpbnN0YW5jZW9mIENvbnRlbnRWaWV3ID8gdGhpcy5yb290Vmlldy5jb250ZW50IDogdGhpcy5yb290Vmlldyk7XG4gICAgICBpZiAoIXJvb3RGYWN0b3J5KCkpIHtcbiAgICAgICAgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgaWYgKHJvb3RGYWN0b3J5KCkpIHtcbiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpO1xuICAgICAgICAgICAgZmlyZVdoZW5Mb2FkZWQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIDEwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpcmVXaGVuTG9hZGVkKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gIH1cbn1cblxuY2xhc3MgTmF0aXZlU2NyaXB0UmVuZGVyZXIgaW1wbGVtZW50cyBSZW5kZXJlcjIge1xuICBwcml2YXRlIHZpZXdVdGlsID0gbmV3IFZpZXdVdGlsKHRoaXMubmFtZXNwYWNlRmlsdGVycywgdGhpcy5yZXVzZVZpZXdzKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJvb3RWaWV3OiBWaWV3LCBwcml2YXRlIG5hbWVzcGFjZUZpbHRlcnM/OiBOYW1lc3BhY2VGaWx0ZXJbXSwgcHJpdmF0ZSByZXVzZVZpZXdzPzogYm9vbGVhbikge31cbiAgZ2V0IGRhdGEoKTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpO1xuICB9XG4gIGRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKCdOYXRpdmVTY3JpcHRSZW5kZXJlci5kZXN0cm95Jyk7XG4gICAgfVxuICB9XG4gIEBpblJvb3Rab25lKClcbiAgY3JlYXRlRWxlbWVudChuYW1lOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuY3JlYXRlRWxlbWVudDogJHtuYW1lfWApO1xuICAgIH1cbiAgICBsZXQgb2xkTmFtZTtcbiAgICBpZiAoIWlzS25vd25WaWV3KG5hbWUpKSB7XG4gICAgICBvbGROYW1lID0gbmFtZTtcbiAgICAgIG5hbWUgPSAnUHJveHlWaWV3Q29udGFpbmVyJztcbiAgICB9XG4gICAgY29uc3QgdmlldyA9IHRoaXMudmlld1V0aWwuY3JlYXRlVmlldyhuYW1lKTtcbiAgICBpZiAob2xkTmFtZSkge1xuICAgICAgKHZpZXcgYXMgYW55KS5jdXN0b21DU1NOYW1lID0gb2xkTmFtZTtcbiAgICB9XG4gICAgcmV0dXJuIHZpZXc7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBjcmVhdGVDb21tZW50KHZhbHVlOiBzdHJpbmcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmNyZWF0ZUNvbW1lbnQgJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudmlld1V0aWwuY3JlYXRlQ29tbWVudCh2YWx1ZSk7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBjcmVhdGVUZXh0KHZhbHVlOiBzdHJpbmcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmNyZWF0ZVRleHQgJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudmlld1V0aWwuY3JlYXRlVGV4dCh2YWx1ZSk7XG4gIH1cbiAgZGVzdHJveU5vZGU6IChub2RlOiBhbnkpID0+IHZvaWQgPSAobm9kZTogVmlldykgPT5cbiAgICBydW5JblJvb3Rab25lKCgpID0+IHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5kZXN0cm95Tm9kZSBub2RlOiAke25vZGV9YCk7XG4gICAgICB9XG4gICAgICBpZiAobm9kZT8uZGVzdHJveU5vZGUpIHtcbiAgICAgICAgbm9kZT8uZGVzdHJveU5vZGUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgQGluUm9vdFpvbmUoKVxuICBhcHBlbmRDaGlsZChwYXJlbnQ6IFZpZXcsIG5ld0NoaWxkOiBWaWV3KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5hcHBlbmRDaGlsZCBjaGlsZDogJHtuZXdDaGlsZH0gcGFyZW50OiAke3BhcmVudH1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5hcHBlbmRDaGlsZChwYXJlbnQsIG5ld0NoaWxkKTtcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIGluc2VydEJlZm9yZShwYXJlbnQ6IGFueSwgbmV3Q2hpbGQ6IGFueSwgcmVmQ2hpbGQ6IGFueSk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuaW5zZXJ0QmVmb3JlIGNoaWxkOiAke25ld0NoaWxkfSBgICsgYHBhcmVudDogJHtwYXJlbnR9IHJlZkNoaWxkOiAke3JlZkNoaWxkfWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLmluc2VydEJlZm9yZShwYXJlbnQsIG5ld0NoaWxkLCByZWZDaGlsZCk7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICByZW1vdmVDaGlsZChwYXJlbnQ6IGFueSwgb2xkQ2hpbGQ6IGFueSwgaXNIb3N0RWxlbWVudD86IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnJlbW92ZUNoaWxkIGNoaWxkOiAke29sZENoaWxkfSBwYXJlbnQ6ICR7cGFyZW50fWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLnJlbW92ZUNoaWxkKHBhcmVudCwgb2xkQ2hpbGQpO1xuICB9XG4gIHNlbGVjdFJvb3RFbGVtZW50KHNlbGVjdG9yT3JOb2RlOiBhbnksIHByZXNlcnZlQ29udGVudD86IGJvb2xlYW4pIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnNlbGVjdFJvb3RFbGVtZW50OiAke3NlbGVjdG9yT3JOb2RlfWApO1xuICAgIH1cbiAgICBpZiAoc2VsZWN0b3JPck5vZGUgaW5zdGFuY2VvZiBWaWV3KSB7XG4gICAgICByZXR1cm4gc2VsZWN0b3JPck5vZGU7XG4gICAgfVxuICAgIGlmIChzZWxlY3Rvck9yTm9kZSAmJiBzZWxlY3Rvck9yTm9kZVswXSA9PT0gJyMnKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBnZXRWaWV3QnlJZCh0aGlzLnJvb3RWaWV3LCBzZWxlY3Rvck9yTm9kZS5zbGljZSgxKSk7XG4gICAgICByZXR1cm4gKHJlc3VsdCB8fCB0aGlzLnJvb3RWaWV3KSBhcyBWaWV3O1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHNlbGVjdG9yT3JOb2RlID09PSAnc3RyaW5nJykge1xuICAgICAgY29uc3QgdmlldyA9IHRoaXMudmlld1V0aWwuY3JlYXRlVmlldyhzZWxlY3Rvck9yTm9kZSk7XG4gICAgICBpZiAoZ2V0Rmlyc3ROYXRpdmVMaWtlVmlldyh2aWV3KSA9PT0gdmlldykge1xuICAgICAgICAvLyB2aWV3IGlzIG5hdGl2ZWxpa2UhXG4gICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGhpcy5yb290Vmlldywgdmlldyk7XG4gICAgICAgIHJldHVybiB2aWV3O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5yb290VmlldztcbiAgfVxuICBwYXJlbnROb2RlKG5vZGU6IE5nVmlldykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIucGFyZW50Tm9kZSBmb3Igbm9kZTogJHtub2RlfSBpcyAke25vZGUucGFyZW50Tm9kZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIG5vZGUucGFyZW50Tm9kZTtcbiAgfVxuICBuZXh0U2libGluZyhub2RlOiBOZ1ZpZXcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLm5leHRTaWJsaW5nIG9mICR7bm9kZX0gaXMgJHtub2RlLm5leHRTaWJsaW5nfWApO1xuICAgIH1cbiAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZztcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIHNldEF0dHJpYnV0ZShlbDogYW55LCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuc2V0QXR0cmlidXRlICR7bmFtZXNwYWNlID8gbmFtZXNwYWNlICsgJzonIDogJyd9JHtlbH0uJHtuYW1lfSA9ICR7dmFsdWV9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwuc2V0UHJvcGVydHkoZWwsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UpO1xuICB9XG4gIHJlbW92ZUF0dHJpYnV0ZShlbDogYW55LCBuYW1lOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIucmVtb3ZlQXR0cmlidXRlICR7bmFtZXNwYWNlID8gbmFtZXNwYWNlICsgJzonIDogJyd9JHtlbH0uJHtuYW1lfWApO1xuICAgIH1cbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIGFkZENsYXNzKGVsOiBhbnksIG5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuYWRkQ2xhc3MgJHtuYW1lfWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLmFkZENsYXNzKGVsLCBuYW1lKTtcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIHJlbW92ZUNsYXNzKGVsOiBhbnksIG5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIucmVtb3ZlQ2xhc3MgJHtuYW1lfWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLnJlbW92ZUNsYXNzKGVsLCBuYW1lKTtcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIHNldFN0eWxlKGVsOiBhbnksIHN0eWxlOiBzdHJpbmcsIHZhbHVlOiBhbnksIGZsYWdzPzogUmVuZGVyZXJTdHlsZUZsYWdzMik6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuc2V0U3R5bGU6ICR7ZWx9LCAke3N0eWxlfSA9ICR7dmFsdWV9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwuc2V0U3R5bGUoZWwsIHN0eWxlLCB2YWx1ZSk7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICByZW1vdmVTdHlsZShlbDogYW55LCBzdHlsZTogc3RyaW5nLCBmbGFncz86IFJlbmRlcmVyU3R5bGVGbGFnczIpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coJ05hdGl2ZVNjcmlwdFJlbmRlcmVyLnJlbW92ZVN0eWxlOiAke3N0eWxlTmFtZX0nKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5yZW1vdmVTdHlsZShlbCwgc3R5bGUpO1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgc2V0UHJvcGVydHkoZWw6IGFueSwgbmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5zZXRQcm9wZXJ0eSAke2VsfS4ke25hbWV9ID0gJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5zZXRQcm9wZXJ0eShlbCwgbmFtZSwgdmFsdWUpO1xuICB9XG4gIHNldFZhbHVlKG5vZGU6IGFueSwgdmFsdWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuc2V0VmFsdWUgcmVuZGVyTm9kZTogJHtub2RlfSwgdmFsdWU6ICR7dmFsdWV9YCk7XG4gICAgfVxuICAgIC8vIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xuICB9XG4gIGxpc3Rlbih0YXJnZXQ6IFZpZXcsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsYmFjazogKGV2ZW50OiBhbnkpID0+IGJvb2xlYW4gfCB2b2lkKTogKCkgPT4gdm9pZCB7XG4gICAgLy8gdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5saXN0ZW46ICR7ZXZlbnROYW1lfWApO1xuICAgIH1cbiAgICB0YXJnZXQub24oZXZlbnROYW1lLCBjYWxsYmFjayk7XG4gICAgaWYgKGV2ZW50TmFtZSA9PT0gVmlldy5sb2FkZWRFdmVudCAmJiB0YXJnZXQuaXNMb2FkZWQpIHtcbiAgICAgIC8vIHdlIG11c3QgY3JlYXRlIGEgbmV3IG9iZXJ2YWJsZSBoZXJlIHRvIGVuc3VyZSB0aGF0IHRoZSBldmVudCBnb2VzIHRocm91Z2ggd2hhdGV2ZXIgem9uZSBwYXRjaGVzIGFyZSBhcHBsaWVkXG4gICAgICBjb25zdCBvYnMgPSBuZXcgT2JzZXJ2YWJsZSgpO1xuICAgICAgb2JzLm9uY2UoZXZlbnROYW1lLCBjYWxsYmFjayk7XG4gICAgICBvYnMubm90aWZ5KHtcbiAgICAgICAgZXZlbnROYW1lLFxuICAgICAgICBvYmplY3Q6IHRhcmdldCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gKCkgPT4gdGFyZ2V0Lm9mZihldmVudE5hbWUsIGNhbGxiYWNrKTtcbiAgfVxufVxuXG4vLyBDT05URU5UX0FUVFIgbm90IGV4cG9ydGVkIGZyb20gbmF0aXZlc2NyaXB0LXJlbmRlcmVyIC0gd2UgbmVlZCBpdCBmb3Igc3R5bGVzIGFwcGxpY2F0aW9uLlxuY29uc3QgQ09NUE9ORU5UX1JFR0VYID0gLyVDT01QJS9nO1xuY29uc3QgQVRUUl9TQU5JVElaRVIgPSAvLS9nO1xuZXhwb3J0IGNvbnN0IENPTVBPTkVOVF9WQVJJQUJMRSA9ICclQ09NUCUnO1xuZXhwb3J0IGNvbnN0IEhPU1RfQVRUUiA9IGBfbmdob3N0LSR7Q09NUE9ORU5UX1ZBUklBQkxFfWA7XG5leHBvcnQgY29uc3QgQ09OVEVOVF9BVFRSID0gYF9uZ2NvbnRlbnQtJHtDT01QT05FTlRfVkFSSUFCTEV9YDtcblxuY29uc3QgcmVwbGFjZU5nQXR0cmlidXRlID0gZnVuY3Rpb24gKGlucHV0OiBzdHJpbmcsIGNvbXBvbmVudElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gaW5wdXQucmVwbGFjZShDT01QT05FTlRfUkVHRVgsIGNvbXBvbmVudElkKTtcbn07XG5cbmNvbnN0IGFkZFNjb3BlZFN0eWxlVG9Dc3MgPSBwcm9maWxlKGBcInJlbmRlcmVyXCIuYWRkU2NvcGVkU3R5bGVUb0Nzc2AsIGZ1bmN0aW9uIGFkZFNjb3BlZFN0eWxlVG9Dc3Moc3R5bGU6IHN0cmluZywgdGFnPzogbnVtYmVyIHwgc3RyaW5nKTogdm9pZCB7XG4gIGlmICh0YWcpIHtcbiAgICBhZGRUYWdnZWRBZGRpdGlvbmFsQ1NTKHN0eWxlLCB0YWcpO1xuICB9IGVsc2Uge1xuICAgIEFwcGxpY2F0aW9uLmFkZENzcyhzdHlsZSk7XG4gIH1cbn0pO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRW11bGF0ZWRSZW5kZXJlciBleHRlbmRzIE5hdGl2ZVNjcmlwdFJlbmRlcmVyIHtcbiAgcHJpdmF0ZSBjb250ZW50QXR0cjogc3RyaW5nO1xuICBwcml2YXRlIGhvc3RBdHRyOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoY29tcG9uZW50OiBSZW5kZXJlclR5cGUyLCByb290VmlldzogVmlldywgbmFtZXNwYWNlRmlsdGVyczogTmFtZXNwYWNlRmlsdGVyW10sIHByaXZhdGUgcm9vdE1vZHVsZUlkOiBzdHJpbmcgfCBudW1iZXIsIHJldXNlVmlld3M6IGJvb2xlYW4pIHtcbiAgICBzdXBlcihyb290VmlldywgbmFtZXNwYWNlRmlsdGVycywgcmV1c2VWaWV3cyk7XG5cbiAgICBjb25zdCBjb21wb25lbnRJZCA9IGNvbXBvbmVudC5pZC5yZXBsYWNlKEFUVFJfU0FOSVRJWkVSLCAnXycpO1xuICAgIHRoaXMuY29udGVudEF0dHIgPSByZXBsYWNlTmdBdHRyaWJ1dGUoQ09OVEVOVF9BVFRSLCBjb21wb25lbnRJZCk7XG4gICAgdGhpcy5ob3N0QXR0ciA9IHJlcGxhY2VOZ0F0dHJpYnV0ZShIT1NUX0FUVFIsIGNvbXBvbmVudElkKTtcbiAgICB0aGlzLmFkZFN0eWxlcyhjb21wb25lbnQuc3R5bGVzLCBjb21wb25lbnRJZCk7XG4gIH1cblxuICBhcHBseVRvSG9zdCh2aWV3OiBOZ1ZpZXcpIHtcbiAgICBzdXBlci5zZXRBdHRyaWJ1dGUodmlldywgdGhpcy5ob3N0QXR0ciwgJycpO1xuICB9XG5cbiAgYXBwZW5kQ2hpbGQocGFyZW50OiBhbnksIG5ld0NoaWxkOiBOZ1ZpZXcpOiB2b2lkIHtcbiAgICBzdXBlci5hcHBlbmRDaGlsZChwYXJlbnQsIG5ld0NoaWxkKTtcbiAgfVxuXG4gIGNyZWF0ZUVsZW1lbnQocGFyZW50OiBhbnksIG5hbWU6IHN0cmluZyk6IE5nVmlldyB7XG4gICAgY29uc3QgdmlldyA9IHN1cGVyLmNyZWF0ZUVsZW1lbnQocGFyZW50LCBuYW1lKTtcblxuICAgIC8vIFNldCBhbiBhdHRyaWJ1dGUgdG8gdGhlIHZpZXcgdG8gc2NvcGUgY29tcG9uZW50LXNwZWNpZmljIGNzcy5cbiAgICAvLyBUaGUgcHJvcGVydHkgbmFtZSBpcyBwcmUtZ2VuZXJhdGVkIGJ5IEFuZ3VsYXIuXG4gICAgc3VwZXIuc2V0QXR0cmlidXRlKHZpZXcsIHRoaXMuY29udGVudEF0dHIsICcnKTtcblxuICAgIHJldHVybiB2aWV3O1xuICB9XG5cbiAgQHByb2ZpbGVcbiAgcHJpdmF0ZSBhZGRTdHlsZXMoc3R5bGVzOiAoc3RyaW5nIHwgYW55W10pW10sIGNvbXBvbmVudElkOiBzdHJpbmcpIHtcbiAgICBzdHlsZXNcbiAgICAgIC5tYXAoKHMpID0+IHMudG9TdHJpbmcoKSlcbiAgICAgIC5tYXAoKHMpID0+IHJlcGxhY2VOZ0F0dHJpYnV0ZShzLCBjb21wb25lbnRJZCkpXG4gICAgICAuZm9yRWFjaCgocykgPT4gYWRkU2NvcGVkU3R5bGVUb0NzcyhzLCB0aGlzLnJvb3RNb2R1bGVJZCkpO1xuICB9XG59XG4iXX0=