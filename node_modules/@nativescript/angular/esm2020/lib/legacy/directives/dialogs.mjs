import { ApplicationRef, ComponentFactoryResolver, Injectable, Injector, NgZone, ɵmarkDirty } from '@angular/core';
import { Application, ContentView, Frame } from '@nativescript/core';
import { AppHostAsyncView, AppHostView } from '../../app-host-view';
import { ComponentPortal } from '../../cdk/portal/common';
import { NativeScriptDomPortalOutlet } from '../../cdk/portal/nsdom-portal-outlet';
import { once } from '../../utils/general';
import { NgViewRef } from '../../view-refs';
import { NSLocationStrategy } from '../router/ns-location-strategy';
import * as i0 from "@angular/core";
import * as i1 from "../router/ns-location-strategy";
export class ModalDialogParams {
    constructor(context = {}, closeCallback) {
        this.context = context;
        this.closeCallback = closeCallback;
    }
}
export class ModalDialogService {
    constructor(location, zone, appRef, defaultInjector) {
        this.location = location;
        this.zone = zone;
        this.appRef = appRef;
        this.defaultInjector = defaultInjector;
    }
    showModal(type, options = {}) {
        // if (!options.viewContainerRef) {
        //   throw new Error('No viewContainerRef: ' + 'Make sure you pass viewContainerRef in ModalDialogOptions.');
        // }
        let parentView = options.viewContainerRef?.element.nativeElement || Application.getRootView();
        if (options.target) {
            parentView = options.target;
        }
        if ((parentView instanceof AppHostView || parentView instanceof AppHostAsyncView) && parentView.ngAppRoot) {
            parentView = parentView.ngAppRoot;
        }
        // _ngDialogRoot is the first child of the previously detached proxy.
        // It should have 'viewController' (iOS) or '_dialogFragment' (Android) available for
        // presenting future modal views.
        if (parentView._ngDialogRoot) {
            parentView = parentView._ngDialogRoot;
        }
        // resolve from particular module (moduleRef)
        // or from same module as parentView (viewContainerRef)
        const componentInjector = options.moduleRef?.injector || options.viewContainerRef?.injector || this.defaultInjector;
        const resolver = componentInjector.get(ComponentFactoryResolver);
        let frame = parentView;
        if (!(parentView instanceof Frame)) {
            frame = (parentView.page && parentView.page.frame) || Frame.topmost();
        }
        this.location?._beginModalNavigation(frame);
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                try {
                    this._showDialog({
                        ...options,
                        containerRef: options.viewContainerRef,
                        injector: componentInjector,
                        context: options.context,
                        doneCallback: resolve,
                        parentView,
                        resolver,
                        type,
                    });
                }
                catch (err) {
                    reject(err);
                }
            }, 10);
        });
    }
    _showDialog(options) {
        let componentViewRef;
        let detachedLoaderRef;
        let portalOutlet;
        const closeCallback = once((...args) => {
            options.doneCallback.apply(undefined, args);
            if (componentViewRef) {
                componentViewRef.firstNativeLikeView.closeModal();
                this.location._closeModalNavigation();
                if (detachedLoaderRef || portalOutlet) {
                    this.zone.run(() => {
                        portalOutlet?.dispose();
                        detachedLoaderRef?.instance.detectChanges();
                        detachedLoaderRef?.destroy();
                    });
                }
            }
        });
        const modalParams = new ModalDialogParams(options.context, closeCallback);
        const childInjector = Injector.create({
            providers: [{ provide: ModalDialogParams, useValue: modalParams }],
            parent: options.injector,
        });
        this.zone.run(() => {
            // if we ever support templates in the old API
            // if(options.templateRef) {
            //     const detachedFactory = options.resolver.resolveComponentFactory(DetachedLoader);
            //     if(options.attachToContainerRef) {
            //         detachedLoaderRef = options.attachToContainerRef.createComponent(detachedFactory, 0, childInjector, null);
            //     } else {
            //         detachedLoaderRef = detachedFactory.create(childInjector); // this DetachedLoader is **completely** detached
            //         this.appRef.attachView(detachedLoaderRef.hostView); // we attach it to the applicationRef, so it becomes a "root" view in angular's hierarchy
            //     }
            //     detachedLoaderRef.changeDetectorRef.detectChanges(); // force a change detection
            //     detachedLoaderRef.instance.createTemplatePortal(options.templateRef);
            // }
            const targetView = new ContentView();
            const portal = new ComponentPortal(options.type);
            portalOutlet = new NativeScriptDomPortalOutlet(targetView, options.resolver, this.appRef, childInjector);
            const componentRef = portalOutlet.attach(portal);
            ɵmarkDirty(componentRef.instance);
            componentViewRef = new NgViewRef(componentRef);
            if (componentViewRef !== componentRef.location.nativeElement) {
                componentRef.location.nativeElement._ngDialogRoot = componentViewRef.firstNativeLikeView;
            }
            // if we don't detach the view from its parent, ios gets mad
            componentViewRef.detachNativeLikeView();
            options.parentView.showModal(componentViewRef.firstNativeLikeView, { ...options, closeCallback });
        });
    }
}
ModalDialogService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: ModalDialogService, deps: [{ token: i1.NSLocationStrategy }, { token: i0.NgZone }, { token: i0.ApplicationRef }, { token: i0.Injector }], target: i0.ɵɵFactoryTarget.Injectable });
ModalDialogService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: ModalDialogService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: ModalDialogService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.NSLocationStrategy }, { type: i0.NgZone }, { type: i0.ApplicationRef }, { type: i0.Injector }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2FuZ3VsYXIvc3JjL2xpYi9sZWdhY3kvZGlyZWN0aXZlcy9kaWFsb2dzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsd0JBQXdCLEVBQWdCLFVBQVUsRUFBRSxRQUFRLEVBQWUsTUFBTSxFQUEwQixVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEssT0FBTyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFvQyxNQUFNLG9CQUFvQixDQUFDO0FBQ3ZHLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUVwRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDMUQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDbkYsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQzs7O0FBMkJwRSxNQUFNLE9BQU8saUJBQWlCO0lBQzVCLFlBQW1CLFVBQWUsRUFBRSxFQUFTLGFBQStCO1FBQXpELFlBQU8sR0FBUCxPQUFPLENBQVU7UUFBUyxrQkFBYSxHQUFiLGFBQWEsQ0FBa0I7SUFBRyxDQUFDO0NBQ2pGO0FBR0QsTUFBTSxPQUFPLGtCQUFrQjtJQUM3QixZQUFvQixRQUE0QixFQUFVLElBQVksRUFBVSxNQUFzQixFQUFVLGVBQXlCO1FBQXJILGFBQVEsR0FBUixRQUFRLENBQW9CO1FBQVUsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQWdCO1FBQVUsb0JBQWUsR0FBZixlQUFlLENBQVU7SUFB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QWEsRUFBRTtnQkFDNUQsWUFBWSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsYUFBYSxHQUFHLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDO2FBQzFGO1lBQ0QsNERBQTREO1lBQzVELGdCQUFnQixDQUFDLG9CQUFvQixFQUFFLENBQUM7WUFDeEMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLEVBQUUsRUFBRSxHQUFHLE9BQU8sRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFDO1FBQ3BHLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7K0dBNUdVLGtCQUFrQjttSEFBbEIsa0JBQWtCOzJGQUFsQixrQkFBa0I7a0JBRDlCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBsaWNhdGlvblJlZiwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBDb21wb25lbnRSZWYsIEluamVjdGFibGUsIEluamVjdG9yLCBOZ01vZHVsZVJlZiwgTmdab25lLCBUeXBlLCBWaWV3Q29udGFpbmVyUmVmLCDJtW1hcmtEaXJ0eSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQXBwbGljYXRpb24sIENvbnRlbnRWaWV3LCBGcmFtZSwgU2hvd01vZGFsT3B0aW9ucywgVmlldywgVmlld0Jhc2UgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuaW1wb3J0IHsgQXBwSG9zdEFzeW5jVmlldywgQXBwSG9zdFZpZXcgfSBmcm9tICcuLi8uLi9hcHAtaG9zdC12aWV3JztcbmltcG9ydCB7IERldGFjaGVkTG9hZGVyIH0gZnJvbSAnLi4vLi4vY2RrL2RldGFjaGVkLWxvYWRlcic7XG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwgfSBmcm9tICcuLi8uLi9jZGsvcG9ydGFsL2NvbW1vbic7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQgfSBmcm9tICcuLi8uLi9jZGsvcG9ydGFsL25zZG9tLXBvcnRhbC1vdXRsZXQnO1xuaW1wb3J0IHsgb25jZSB9IGZyb20gJy4uLy4uL3V0aWxzL2dlbmVyYWwnO1xuaW1wb3J0IHsgTmdWaWV3UmVmIH0gZnJvbSAnLi4vLi4vdmlldy1yZWZzJztcbmltcG9ydCB7IE5TTG9jYXRpb25TdHJhdGVneSB9IGZyb20gJy4uL3JvdXRlci9ucy1sb2NhdGlvbi1zdHJhdGVneSc7XG5cbmV4cG9ydCB0eXBlIEJhc2VTaG93TW9kYWxPcHRpb25zID0gUGljazxTaG93TW9kYWxPcHRpb25zLCBFeGNsdWRlPGtleW9mIFNob3dNb2RhbE9wdGlvbnMsICdjbG9zZUNhbGxiYWNrJyB8ICdjb250ZXh0Jz4+O1xuXG5leHBvcnQgaW50ZXJmYWNlIE1vZGFsRGlhbG9nT3B0aW9ucyBleHRlbmRzIEJhc2VTaG93TW9kYWxPcHRpb25zIHtcbiAgY29udGV4dD86IGFueTtcbiAgdmlld0NvbnRhaW5lclJlZj86IFZpZXdDb250YWluZXJSZWY7XG4gIG1vZHVsZVJlZj86IE5nTW9kdWxlUmVmPGFueT47XG4gIHRhcmdldD86IFZpZXc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2hvd0RpYWxvZ09wdGlvbnMgZXh0ZW5kcyBCYXNlU2hvd01vZGFsT3B0aW9ucyB7XG4gIGNvbnRhaW5lclJlZj86IFZpZXdDb250YWluZXJSZWY7XG4gIC8qKlxuICAgKiB3aGljaCBjb250YWluZXIgdG8gYXR0YWNoIHRoZSBjaGFuZ2UgZGV0ZWN0aW9uXG4gICAqIGlmIG5vdCBzcGVjaWZpZWQsIGF0dGFjaGVzIHRvIHRoZSBBcHBsaWNhdGlvblJlZiAocmVjb21tZW5kZWQpXG4gICAqL1xuICBhdHRhY2hUb0NvbnRhaW5lclJlZj86IFZpZXdDb250YWluZXJSZWY7XG4gIGluamVjdG9yOiBJbmplY3RvcjtcbiAgY29udGV4dDogYW55O1xuICBkb25lQ2FsbGJhY2s7XG4gIHBhZ2VGYWN0b3J5PzogYW55O1xuICBwYXJlbnRWaWV3OiBWaWV3QmFzZTtcbiAgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjtcbiAgdHlwZTogVHlwZTxhbnk+O1xufVxuXG5leHBvcnQgY2xhc3MgTW9kYWxEaWFsb2dQYXJhbXMge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgY29udGV4dDogYW55ID0ge30sIHB1YmxpYyBjbG9zZUNhbGxiYWNrOiAoLi4uYXJncykgPT4gYW55KSB7fVxufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTW9kYWxEaWFsb2dTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsb2NhdGlvbjogTlNMb2NhdGlvblN0cmF0ZWd5LCBwcml2YXRlIHpvbmU6IE5nWm9uZSwgcHJpdmF0ZSBhcHBSZWY6IEFwcGxpY2F0aW9uUmVmLCBwcml2YXRlIGRlZmF1bHRJbmplY3RvcjogSW5qZWN0b3IpIHt9XG5cbiAgcHVibGljIHNob3dNb2RhbCh0eXBlOiBUeXBlPGFueT4sIG9wdGlvbnM6IE1vZGFsRGlhbG9nT3B0aW9ucyA9IHt9KTogUHJvbWlzZTxhbnk+IHtcbiAgICAvLyBpZiAoIW9wdGlvbnMudmlld0NvbnRhaW5lclJlZikge1xuICAgIC8vICAgdGhyb3cgbmV3IEVycm9yKCdObyB2aWV3Q29udGFpbmVyUmVmOiAnICsgJ01ha2Ugc3VyZSB5b3UgcGFzcyB2aWV3Q29udGFpbmVyUmVmIGluIE1vZGFsRGlhbG9nT3B0aW9ucy4nKTtcbiAgICAvLyB9XG5cbiAgICBsZXQgcGFyZW50VmlldyA9IG9wdGlvbnMudmlld0NvbnRhaW5lclJlZj8uZWxlbWVudC5uYXRpdmVFbGVtZW50IHx8IEFwcGxpY2F0aW9uLmdldFJvb3RWaWV3KCk7XG4gICAgaWYgKG9wdGlvbnMudGFyZ2V0KSB7XG4gICAgICBwYXJlbnRWaWV3ID0gb3B0aW9ucy50YXJnZXQ7XG4gICAgfVxuXG4gICAgaWYgKChwYXJlbnRWaWV3IGluc3RhbmNlb2YgQXBwSG9zdFZpZXcgfHwgcGFyZW50VmlldyBpbnN0YW5jZW9mIEFwcEhvc3RBc3luY1ZpZXcpICYmIHBhcmVudFZpZXcubmdBcHBSb290KSB7XG4gICAgICBwYXJlbnRWaWV3ID0gcGFyZW50Vmlldy5uZ0FwcFJvb3Q7XG4gICAgfVxuXG4gICAgLy8gX25nRGlhbG9nUm9vdCBpcyB0aGUgZmlyc3QgY2hpbGQgb2YgdGhlIHByZXZpb3VzbHkgZGV0YWNoZWQgcHJveHkuXG4gICAgLy8gSXQgc2hvdWxkIGhhdmUgJ3ZpZXdDb250cm9sbGVyJyAoaU9TKSBvciAnX2RpYWxvZ0ZyYWdtZW50JyAoQW5kcm9pZCkgYXZhaWxhYmxlIGZvclxuICAgIC8vIHByZXNlbnRpbmcgZnV0dXJlIG1vZGFsIHZpZXdzLlxuICAgIGlmIChwYXJlbnRWaWV3Ll9uZ0RpYWxvZ1Jvb3QpIHtcbiAgICAgIHBhcmVudFZpZXcgPSBwYXJlbnRWaWV3Ll9uZ0RpYWxvZ1Jvb3Q7XG4gICAgfVxuXG4gICAgLy8gcmVzb2x2ZSBmcm9tIHBhcnRpY3VsYXIgbW9kdWxlIChtb2R1bGVSZWYpXG4gICAgLy8gb3IgZnJvbSBzYW1lIG1vZHVsZSBhcyBwYXJlbnRWaWV3ICh2aWV3Q29udGFpbmVyUmVmKVxuICAgIGNvbnN0IGNvbXBvbmVudEluamVjdG9yID0gb3B0aW9ucy5tb2R1bGVSZWY/LmluamVjdG9yIHx8IG9wdGlvbnMudmlld0NvbnRhaW5lclJlZj8uaW5qZWN0b3IgfHwgdGhpcy5kZWZhdWx0SW5qZWN0b3I7XG4gICAgY29uc3QgcmVzb2x2ZXIgPSBjb21wb25lbnRJbmplY3Rvci5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKTtcblxuICAgIGxldCBmcmFtZSA9IHBhcmVudFZpZXc7XG4gICAgaWYgKCEocGFyZW50VmlldyBpbnN0YW5jZW9mIEZyYW1lKSkge1xuICAgICAgZnJhbWUgPSAocGFyZW50Vmlldy5wYWdlICYmIHBhcmVudFZpZXcucGFnZS5mcmFtZSkgfHwgRnJhbWUudG9wbW9zdCgpO1xuICAgIH1cblxuICAgIHRoaXMubG9jYXRpb24/Ll9iZWdpbk1vZGFsTmF2aWdhdGlvbihmcmFtZSk7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgdGhpcy5fc2hvd0RpYWxvZyh7XG4gICAgICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICAgICAgY29udGFpbmVyUmVmOiBvcHRpb25zLnZpZXdDb250YWluZXJSZWYsXG4gICAgICAgICAgICBpbmplY3RvcjogY29tcG9uZW50SW5qZWN0b3IsXG4gICAgICAgICAgICBjb250ZXh0OiBvcHRpb25zLmNvbnRleHQsXG4gICAgICAgICAgICBkb25lQ2FsbGJhY2s6IHJlc29sdmUsXG4gICAgICAgICAgICBwYXJlbnRWaWV3LFxuICAgICAgICAgICAgcmVzb2x2ZXIsXG4gICAgICAgICAgICB0eXBlLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSwgMTApO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2hvd0RpYWxvZyhvcHRpb25zOiBTaG93RGlhbG9nT3B0aW9ucyk6IHZvaWQge1xuICAgIGxldCBjb21wb25lbnRWaWV3UmVmOiBOZ1ZpZXdSZWY8dW5rbm93bj47XG4gICAgbGV0IGRldGFjaGVkTG9hZGVyUmVmOiBDb21wb25lbnRSZWY8RGV0YWNoZWRMb2FkZXI+O1xuICAgIGxldCBwb3J0YWxPdXRsZXQ6IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldDtcblxuICAgIGNvbnN0IGNsb3NlQ2FsbGJhY2sgPSBvbmNlKCguLi5hcmdzKSA9PiB7XG4gICAgICBvcHRpb25zLmRvbmVDYWxsYmFjay5hcHBseSh1bmRlZmluZWQsIGFyZ3MpO1xuICAgICAgaWYgKGNvbXBvbmVudFZpZXdSZWYpIHtcbiAgICAgICAgY29tcG9uZW50Vmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3LmNsb3NlTW9kYWwoKTtcbiAgICAgICAgdGhpcy5sb2NhdGlvbi5fY2xvc2VNb2RhbE5hdmlnYXRpb24oKTtcbiAgICAgICAgaWYgKGRldGFjaGVkTG9hZGVyUmVmIHx8IHBvcnRhbE91dGxldCkge1xuICAgICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgcG9ydGFsT3V0bGV0Py5kaXNwb3NlKCk7XG4gICAgICAgICAgICBkZXRhY2hlZExvYWRlclJlZj8uaW5zdGFuY2UuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgICAgICAgZGV0YWNoZWRMb2FkZXJSZWY/LmRlc3Ryb3koKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgbW9kYWxQYXJhbXMgPSBuZXcgTW9kYWxEaWFsb2dQYXJhbXMob3B0aW9ucy5jb250ZXh0LCBjbG9zZUNhbGxiYWNrKTtcblxuICAgIGNvbnN0IGNoaWxkSW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgcHJvdmlkZXJzOiBbeyBwcm92aWRlOiBNb2RhbERpYWxvZ1BhcmFtcywgdXNlVmFsdWU6IG1vZGFsUGFyYW1zIH1dLFxuICAgICAgcGFyZW50OiBvcHRpb25zLmluamVjdG9yLFxuICAgIH0pO1xuICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgLy8gaWYgd2UgZXZlciBzdXBwb3J0IHRlbXBsYXRlcyBpbiB0aGUgb2xkIEFQSVxuICAgICAgLy8gaWYob3B0aW9ucy50ZW1wbGF0ZVJlZikge1xuICAgICAgLy8gICAgIGNvbnN0IGRldGFjaGVkRmFjdG9yeSA9IG9wdGlvbnMucmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRGV0YWNoZWRMb2FkZXIpO1xuICAgICAgLy8gICAgIGlmKG9wdGlvbnMuYXR0YWNoVG9Db250YWluZXJSZWYpIHtcbiAgICAgIC8vICAgICAgICAgZGV0YWNoZWRMb2FkZXJSZWYgPSBvcHRpb25zLmF0dGFjaFRvQ29udGFpbmVyUmVmLmNyZWF0ZUNvbXBvbmVudChkZXRhY2hlZEZhY3RvcnksIDAsIGNoaWxkSW5qZWN0b3IsIG51bGwpO1xuICAgICAgLy8gICAgIH0gZWxzZSB7XG4gICAgICAvLyAgICAgICAgIGRldGFjaGVkTG9hZGVyUmVmID0gZGV0YWNoZWRGYWN0b3J5LmNyZWF0ZShjaGlsZEluamVjdG9yKTsgLy8gdGhpcyBEZXRhY2hlZExvYWRlciBpcyAqKmNvbXBsZXRlbHkqKiBkZXRhY2hlZFxuICAgICAgLy8gICAgICAgICB0aGlzLmFwcFJlZi5hdHRhY2hWaWV3KGRldGFjaGVkTG9hZGVyUmVmLmhvc3RWaWV3KTsgLy8gd2UgYXR0YWNoIGl0IHRvIHRoZSBhcHBsaWNhdGlvblJlZiwgc28gaXQgYmVjb21lcyBhIFwicm9vdFwiIHZpZXcgaW4gYW5ndWxhcidzIGhpZXJhcmNoeVxuICAgICAgLy8gICAgIH1cbiAgICAgIC8vICAgICBkZXRhY2hlZExvYWRlclJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7IC8vIGZvcmNlIGEgY2hhbmdlIGRldGVjdGlvblxuICAgICAgLy8gICAgIGRldGFjaGVkTG9hZGVyUmVmLmluc3RhbmNlLmNyZWF0ZVRlbXBsYXRlUG9ydGFsKG9wdGlvbnMudGVtcGxhdGVSZWYpO1xuICAgICAgLy8gfVxuICAgICAgY29uc3QgdGFyZ2V0VmlldyA9IG5ldyBDb250ZW50VmlldygpO1xuICAgICAgY29uc3QgcG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbChvcHRpb25zLnR5cGUpO1xuICAgICAgcG9ydGFsT3V0bGV0ID0gbmV3IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldCh0YXJnZXRWaWV3LCBvcHRpb25zLnJlc29sdmVyLCB0aGlzLmFwcFJlZiwgY2hpbGRJbmplY3Rvcik7XG4gICAgICBjb25zdCBjb21wb25lbnRSZWYgPSBwb3J0YWxPdXRsZXQuYXR0YWNoKHBvcnRhbCk7XG4gICAgICDJtW1hcmtEaXJ0eShjb21wb25lbnRSZWYuaW5zdGFuY2UpO1xuICAgICAgY29tcG9uZW50Vmlld1JlZiA9IG5ldyBOZ1ZpZXdSZWYoY29tcG9uZW50UmVmKTtcbiAgICAgIGlmIChjb21wb25lbnRWaWV3UmVmICE9PSBjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudCkge1xuICAgICAgICBjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudC5fbmdEaWFsb2dSb290ID0gY29tcG9uZW50Vmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3O1xuICAgICAgfVxuICAgICAgLy8gaWYgd2UgZG9uJ3QgZGV0YWNoIHRoZSB2aWV3IGZyb20gaXRzIHBhcmVudCwgaW9zIGdldHMgbWFkXG4gICAgICBjb21wb25lbnRWaWV3UmVmLmRldGFjaE5hdGl2ZUxpa2VWaWV3KCk7XG4gICAgICBvcHRpb25zLnBhcmVudFZpZXcuc2hvd01vZGFsKGNvbXBvbmVudFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldywgeyAuLi5vcHRpb25zLCBjbG9zZUNhbGxiYWNrIH0pO1xuICAgIH0pO1xuICB9XG59XG4iXX0=