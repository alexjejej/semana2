import { Inject, Injectable, Optional } from '@angular/core';
import { LocationStrategy } from '@angular/common';
import { DefaultUrlSerializer } from '@angular/router';
import { NativeScriptDebug } from '../../trace';
import { isPresent } from '../../utils/lang-facade';
import { FrameService } from '../frame.service';
import { Outlet, defaultNavOptions } from './ns-location-utils';
import { START_PATH } from '../../tokens';
import * as i0 from "@angular/core";
import * as i1 from "../frame.service";
export class NSLocationStrategy extends LocationStrategy {
    constructor(frameService, startPath) {
        super();
        this.frameService = frameService;
        this.startPath = startPath;
        this.outlets = [];
        this.popStateCallbacks = new Array();
        this._modalNavigationDepth = 0;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.constructor()');
        }
    }
    path() {
        if (!this.currentUrlTree) {
            return this.startPath || '/';
        }
        const state = this.currentOutlet && this.currentOutlet.peekState();
        if (!state) {
            return '/';
        }
        let tree = this.currentUrlTree;
        let changedOutlet = this.getSegmentGroupByOutlet(this.currentOutlet);
        // Handle case where the user declares a component at path "/".
        // The url serializer doesn't parse this url as having a primary outlet.
        if (state.isRootSegmentGroup) {
            tree.root = state.segmentGroup;
        }
        else if (changedOutlet) {
            this.updateSegmentGroup(tree.root, changedOutlet, state.segmentGroup);
        }
        const urlSerializer = new DefaultUrlSerializer();
        tree.queryParams = state.queryParams;
        const url = urlSerializer.serialize(tree);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.path(): ' + url);
        }
        return url;
    }
    prepareExternalUrl(internal) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.prepareExternalUrl() internal: ' + internal);
        }
        return internal;
    }
    pushState(state, title, url, queryParams) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.pushState state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
        }
        this.pushStateInternal(state, title, url, queryParams);
    }
    pushStateInternal(state, title, url, queryParams) {
        const urlSerializer = new DefaultUrlSerializer();
        this.currentUrlTree = urlSerializer.parse(url);
        const urlTreeRoot = this.currentUrlTree.root;
        // Handle case where the user declares a component at path "/".
        // The url serializer doesn't parse this url as having a primary outlet.
        if (!Object.keys(urlTreeRoot.children).length) {
            const segmentGroup = this.currentUrlTree && this.currentUrlTree.root;
            const outletKey = this.getOutletKey(this.getSegmentGroupFullPath(segmentGroup), 'primary');
            const outlet = this.findOutlet(outletKey);
            if (outlet && this.updateStates(outlet, segmentGroup, this.currentUrlTree.queryParams)) {
                this.currentOutlet = outlet; // If states updated
            }
            else if (!outlet) {
                // tslint:disable-next-line:max-line-length
                const rootOutlet = this.createOutlet('primary', null, segmentGroup, null, null, this.currentUrlTree.queryParams);
                this.currentOutlet = rootOutlet;
            }
            this.currentOutlet.peekState().isRootSegmentGroup = true;
            return;
        }
        const queue = [];
        let currentTree = urlTreeRoot;
        while (currentTree) {
            Object.keys(currentTree.children).forEach((outletName) => {
                const currentSegmentGroup = currentTree.children[outletName];
                currentSegmentGroup.outlet = outletName;
                currentSegmentGroup.root = urlTreeRoot;
                const outletPath = this.getSegmentGroupFullPath(currentTree);
                let outletKey = this.getOutletKey(outletPath, outletName);
                let outlet = this.findOutlet(outletKey);
                const parentOutletName = currentTree.outlet || '';
                const parentOutletPath = this.getSegmentGroupFullPath(currentTree.parent);
                const parentOutletKey = this.getOutletKey(parentOutletPath, parentOutletName);
                const parentOutlet = this.findOutlet(parentOutletKey);
                const containsLastState = outlet && outlet.containsTopState(currentSegmentGroup.toString());
                if (!outlet) {
                    // tslint:disable-next-line:max-line-length
                    outlet = this.createOutlet(outletKey, outletPath, currentSegmentGroup, parentOutlet, this._modalNavigationDepth, this.currentUrlTree.queryParams);
                    this.currentOutlet = outlet;
                }
                else if (this._modalNavigationDepth > 0 && outlet.showingModal && !containsLastState) {
                    // Navigation inside modal view.
                    this.upsertModalOutlet(outlet, currentSegmentGroup, this.currentUrlTree.queryParams);
                }
                else {
                    outlet.parent = parentOutlet;
                    if (this.updateStates(outlet, currentSegmentGroup, this.currentUrlTree.queryParams)) {
                        this.currentOutlet = outlet; // If states updated
                    }
                }
                queue.push(currentSegmentGroup);
            });
            currentTree = queue.shift();
        }
    }
    replaceState(state, title, url, queryParams) {
        const states = this.currentOutlet && this.currentOutlet.states;
        if (states && states.length > 0) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy.replaceState changing existing state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
            }
        }
        else {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy.replaceState pushing new state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
            }
            this.pushStateInternal(state, title, url, queryParams);
        }
    }
    forward() {
        throw new Error('NSLocationStrategy.forward() - not implemented');
    }
    back(outlet, frame) {
        this.currentOutlet = outlet || this.currentOutlet;
        if (this.currentOutlet.isPageNavigationBack) {
            const states = this.currentOutlet.states;
            // We are navigating to the previous page
            // clear the stack until we get to a page navigation state
            let state = states.pop();
            let count = 1;
            if (frame) {
                while (state.frame && state.frame !== frame) {
                    state = states.pop();
                    count++;
                }
            }
            while (!state.isPageNavigation) {
                state = states.pop();
                count++;
            }
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog(`NSLocationStrategy.back() while navigating back. States popped: ${count}`);
            }
            this.callPopState(state, true);
        }
        else {
            let state = this.currentOutlet.peekState();
            if (state && state.isPageNavigation) {
                // This was a page navigation - so navigate through frame.
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('NSLocationStrategy.back() while not navigating back but top' + ' state is page - will call frame.goBack()');
                }
                if (!outlet) {
                    const topmostFrame = this.frameService.getFrame();
                    this.currentOutlet = this.getOutletByFrame(topmostFrame) || this.currentOutlet;
                }
                const frameToBack = this.currentOutlet.getFrameToBack();
                if (frameToBack) {
                    frameToBack.goBack();
                }
            }
            else {
                // Nested navigation - just pop the state
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('NSLocationStrategy.back() while not navigating back but top' + ' state is not page - just pop');
                }
                this.callPopState(this.currentOutlet.states.pop(), true);
            }
        }
    }
    canGoBack(outlet) {
        outlet = outlet || this.currentOutlet;
        return outlet.states.length > 1;
    }
    onPopState(fn) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.onPopState');
        }
        this.popStateCallbacks.push(fn);
    }
    getBaseHref() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.getBaseHref()');
        }
        return '';
    }
    callPopState(state, pop = true, outlet) {
        outlet = outlet || this.currentOutlet;
        const urlSerializer = new DefaultUrlSerializer();
        let changedOutlet = this.getSegmentGroupByOutlet(outlet);
        if (state && changedOutlet) {
            this.updateSegmentGroup(this.currentUrlTree.root, changedOutlet, state.segmentGroup);
        }
        else if (changedOutlet) {
            // when closing modal view there are scenarios (e.g. root viewContainerRef) when we need
            // to clean up the named page router outlet to make sure we will open the modal properly again if needed.
            this.updateSegmentGroup(this.currentUrlTree.root, changedOutlet, null);
        }
        const url = urlSerializer.serialize(this.currentUrlTree);
        const change = { state, type: 'popstate' };
        for (let fn of this.popStateCallbacks) {
            fn(change);
        }
    }
    toString() {
        let result = [];
        this.outlets.forEach((outlet) => {
            const outletStates = outlet.states;
            const outletLog = outletStates
                // tslint:disable-next-line:max-line-length
                .map((v, i) => `${outlet.outletKeys}.${i}.[${v.isPageNavigation ? 'PAGE' : 'INTERNAL'}].[${outlet.modalNavigationDepth ? 'MODAL' : 'BASE'}] "${v.segmentGroup.toString()}"`)
                .reverse();
            result = result.concat(outletLog);
        });
        return result.join('\n');
    }
    // Methods for syncing with page navigation in PageRouterOutlet
    _beginBackPageNavigation(frame) {
        const outlet = this.getOutletByFrame(frame);
        if (!outlet || outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('Attempted to call startGoBack while going back.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.startGoBack()');
        }
        outlet.isPageNavigationBack = true;
        // we find all the children and also set their isPageNavigationBack
        this.outlets
            .filter((o) => {
            let parent = o.parent;
            while (parent) {
                if (parent === outlet) {
                    return true;
                }
                parent = parent.parent;
            }
            return false;
        })
            .forEach((o) => (o.isPageNavigationBack = true));
        this.currentOutlet = outlet;
    }
    _finishBackPageNavigation(frame) {
        const outlet = this.getOutletByFrame(frame);
        if (!outlet || !outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('Attempted to call endGoBack while not going back.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.finishBackPageNavigation()');
        }
        outlet.isPageNavigationBack = false;
    }
    _beginModalNavigation(frame) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy._beginModalNavigation()');
        }
        this.currentOutlet = this.getOutletByFrame(frame) || this.currentOutlet;
        // It is possible to have frame, but not corresponding Outlet, if
        // showing modal dialog on app.component.ts ngOnInit() e.g. In that case
        // the modal is treated as none modal navigation.
        if (this.currentOutlet) {
            this.currentOutlet.showingModal = true;
            this._modalNavigationDepth++;
        }
    }
    _closeModalNavigation() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.closeModalNavigation()');
        }
        const isShowingModal = this._modalNavigationDepth > 0;
        if (isShowingModal) {
            this._modalNavigationDepth--;
        }
        // currentOutlet should be the one that corresponds to the topmost frame
        const topmostOutlet = this.getOutletByFrame(this.frameService.getFrame());
        const outlet = this.findOutletByModal(this._modalNavigationDepth, isShowingModal) || topmostOutlet;
        if (outlet) {
            this.currentOutlet = outlet;
            this.currentOutlet.showingModal = false;
            this.callPopState(this.currentOutlet.peekState(), false);
        }
    }
    _beginPageNavigation(frame) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy._beginPageNavigation()');
        }
        this.currentOutlet = this.getOutletByFrame(frame) || this.currentOutlet;
        const lastState = this.currentOutlet.peekState();
        if (lastState) {
            lastState.isPageNavigation = true;
        }
        const navOptions = this._currentNavigationOptions || defaultNavOptions;
        if (navOptions.clearHistory) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy._beginPageNavigation clearing states history');
            }
            this.currentOutlet.states = [lastState];
        }
        this._currentNavigationOptions = undefined;
        return navOptions;
    }
    _setNavigationOptions(options) {
        this._currentNavigationOptions = {
            clearHistory: isPresent(options.clearHistory) ? options.clearHistory : false,
            animated: isPresent(options.animated) ? options.animated : true,
            transition: options.transition,
        };
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy._setNavigationOptions(' + `${JSON.stringify(this._currentNavigationOptions)})`);
        }
    }
    _getOutlets() {
        return this.outlets;
    }
    updateOutletFrame(outlet, frame, isEmptyOutletFrame) {
        const lastState = outlet.peekState();
        if (lastState && !lastState.frame && !isEmptyOutletFrame) {
            lastState.frame = frame;
        }
        if (!outlet.containsFrame(frame)) {
            outlet.frames.push(frame);
        }
        this.currentOutlet = outlet;
    }
    clearOutlet(frame) {
        this.outlets = this.outlets.filter((currentOutlet) => {
            let isEqualToCurrent;
            if (this.currentOutlet) {
                isEqualToCurrent = currentOutlet.pathByOutlets === this.currentOutlet.pathByOutlets;
            }
            // Remove outlet from the url tree.
            if (currentOutlet.containsFrame(frame) && !isEqualToCurrent) {
                this.callPopState(null, true, currentOutlet);
            }
            // Skip frames filtering since currentOutlet is <router-outlet> when no frames available.
            if (currentOutlet.frames.length && !currentOutlet.isNSEmptyOutlet) {
                currentOutlet.frames = currentOutlet.frames.filter((currentFrame) => currentFrame !== frame);
                return currentOutlet.frames.length;
            }
            return !currentOutlet.containsFrame(frame);
        });
    }
    getSegmentGroupFullPath(segmentGroup) {
        let fullPath = '';
        while (segmentGroup) {
            const url = segmentGroup.toString();
            if (fullPath) {
                fullPath = (url ? url + '/' : '') + fullPath;
            }
            else {
                fullPath = url;
            }
            segmentGroup = segmentGroup.parent;
        }
        return fullPath;
    }
    getRouteFullPath(currentRoute) {
        const outletName = currentRoute.outlet;
        let fullPath;
        currentRoute = currentRoute.parent;
        while (currentRoute) {
            const urls = currentRoute.url.value || currentRoute.url;
            let url = urls;
            if (Array.isArray(urls)) {
                url = url.join('/');
            }
            fullPath = fullPath ? (url ? url + '/' : url) + fullPath : url;
            currentRoute = currentRoute.parent;
        }
        return fullPath ? fullPath + '-' + outletName : outletName;
    }
    getPathByOutlets(urlSegmentGroup) {
        if (!urlSegmentGroup) {
            return '';
        }
        let pathToOutlet;
        let lastPath = urlSegmentGroup.outlet || 'primary';
        let parent = urlSegmentGroup.parent;
        while (parent && urlSegmentGroup.root !== parent) {
            if (parent && parent.outlet !== lastPath) {
                if (lastPath === 'primary') {
                    lastPath = parent.outlet;
                }
                else {
                    lastPath = parent.outlet;
                    pathToOutlet = lastPath + '-' + (pathToOutlet || urlSegmentGroup.outlet);
                }
            }
            parent = parent.parent;
        }
        return pathToOutlet || lastPath;
    }
    findOutlet(outletKey, activatedRouteSnapshot) {
        let outlet = this.outlets.find((currentOutlet) => {
            let equalModalDepth = currentOutlet.modalNavigationDepth === this._modalNavigationDepth;
            return equalModalDepth && currentOutlet.outletKeys.indexOf(outletKey) > -1;
        });
        // No Outlet with the given outletKey could happen when using nested unnamed p-r-o
        // primary -> primary -> prymary
        if (!outlet && activatedRouteSnapshot) {
            const pathByOutlets = this.getPathByOutlets(activatedRouteSnapshot);
            outlet = this.outlets.find((currentOutlet) => {
                let equalModalDepth = currentOutlet.modalNavigationDepth === this._modalNavigationDepth;
                return equalModalDepth && currentOutlet.pathByOutlets === pathByOutlets;
            });
        }
        return outlet;
    }
    findOutletByModal(modalNavigation, isShowingModal) {
        return this.outlets.find((outlet) => {
            let equalModalDepth = outlet.modalNavigationDepth === modalNavigation;
            return isShowingModal ? equalModalDepth && outlet.showingModal : equalModalDepth;
        });
    }
    getOutletByFrame(frame) {
        let outlet;
        for (let index = 0; index < this.outlets.length; index++) {
            const currentOutlet = this.outlets[index];
            if (currentOutlet.containsFrame(frame)) {
                outlet = currentOutlet;
                break;
            }
        }
        return outlet;
    }
    updateStates(outlet, currentSegmentGroup, queryParams) {
        const isNewPage = outlet.states.length === 0;
        const lastState = outlet.states[outlet.states.length - 1];
        const equalStateUrls = outlet.containsTopState(currentSegmentGroup.toString());
        const locationState = {
            segmentGroup: currentSegmentGroup,
            isRootSegmentGroup: false,
            isPageNavigation: isNewPage,
            queryParams: { ...queryParams },
        };
        if (!lastState || !equalStateUrls) {
            outlet.states.push(locationState);
            // Update last state segmentGroup of parent Outlet.
            if (this._modalNavigationDepth === 0 && !outlet.showingModal) {
                this.updateParentsStates(outlet, currentSegmentGroup.parent);
            }
            return true;
        }
        return false;
    }
    updateParentsStates(outlet, newSegmentGroup) {
        let parentOutlet = outlet.parent;
        // Update parents lastState segmentGroups
        while (parentOutlet && newSegmentGroup) {
            const state = parentOutlet.peekState();
            if (state) {
                state.segmentGroup = newSegmentGroup;
                newSegmentGroup = newSegmentGroup.parent;
                parentOutlet = parentOutlet.parent;
            }
        }
    }
    // tslint:disable-next-line:max-line-length
    createOutlet(outletKey, path, segmentGroup, parent, modalNavigation, queryParams = {}) {
        const pathByOutlets = this.getPathByOutlets(segmentGroup);
        const newOutlet = new Outlet(outletKey, path, pathByOutlets, modalNavigation);
        const locationState = {
            segmentGroup: segmentGroup,
            isRootSegmentGroup: false,
            isPageNavigation: true,
            queryParams: { ...queryParams },
        };
        newOutlet.states = [locationState];
        newOutlet.parent = parent;
        this.outlets.push(newOutlet);
        // Update last state segmentGroup of parent Outlet.
        if (this._modalNavigationDepth === 0 && !newOutlet.showingModal) {
            this.updateParentsStates(newOutlet, segmentGroup.parent);
        }
        return newOutlet;
    }
    getSegmentGroupByOutlet(outlet) {
        const pathList = outlet.pathByOutlets.split('-');
        let segmentGroup = this.currentUrlTree.root;
        let pathToOutlet;
        for (let index = 0; index < pathList.length; index++) {
            const currentPath = pathList[index];
            const childrenCount = Object.keys(segmentGroup.children).length;
            if (childrenCount && segmentGroup.children[currentPath]) {
                const url = segmentGroup.toString();
                pathToOutlet = pathToOutlet ? pathToOutlet + '/' + url : url;
                segmentGroup = segmentGroup.children[currentPath];
            }
            else {
                // If no child outlet found with the given name - forget about all previously found outlets.
                // example: seaching for 'primary-second-primary' shouldn't return 'primary-second'
                // if no 'primary' child available on 'second'.
                segmentGroup = null;
                break;
            }
        }
        // Paths should also match since there could be another Outlet
        // with the same pathByOutlets but different url path.
        if (segmentGroup && outlet.path && pathToOutlet && outlet.path !== pathToOutlet) {
            segmentGroup = null;
        }
        return segmentGroup;
    }
    // Traversal and replacement of segmentGroup.
    updateSegmentGroup(rootNode, oldSegmentGroup, newSegmentGroup) {
        const queue = [];
        let currentTree = rootNode;
        while (currentTree) {
            Object.keys(currentTree.children).forEach((outletName) => {
                if (currentTree.children[outletName] === oldSegmentGroup) {
                    if (newSegmentGroup) {
                        currentTree.children[outletName] = newSegmentGroup;
                    }
                    else {
                        delete currentTree.children[outletName];
                    }
                }
                queue.push(currentTree.children[outletName]);
            });
            currentTree = queue.shift();
        }
    }
    upsertModalOutlet(parentOutlet, segmentedGroup, queryParams) {
        let currentModalOutlet = this.findOutletByModal(this._modalNavigationDepth);
        // We want to treat every p-r-o as a standalone Outlet.
        if (!currentModalOutlet) {
            if (this._modalNavigationDepth > 1) {
                // The parent of the current Outlet should be the previous opened modal (if any).
                parentOutlet = this.findOutletByModal(this._modalNavigationDepth - 1);
            }
            // No currentModalOutlet available when opening 'primary' p-r-o.
            const outletName = 'primary';
            const outletPath = parentOutlet.peekState().segmentGroup.toString();
            const outletKey = this.getOutletKey(outletPath, outletName);
            // tslint:disable-next-line:max-line-length
            currentModalOutlet = this.createOutlet(outletKey, outletPath, segmentedGroup, parentOutlet, this._modalNavigationDepth, queryParams);
            this.currentOutlet = currentModalOutlet;
        }
        else if (this.updateStates(currentModalOutlet, segmentedGroup, queryParams)) {
            this.currentOutlet = currentModalOutlet; // If states updated
        }
    }
    getOutletKey(path, outletName) {
        return path ? path + '-' + outletName : outletName;
    }
    ngOnDestroy() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.ngOnDestroy()');
        }
        this.outlets = [];
        this.currentOutlet = null;
    }
}
NSLocationStrategy.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NSLocationStrategy, deps: [{ token: i1.FrameService }, { token: START_PATH, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
NSLocationStrategy.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NSLocationStrategy, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: NSLocationStrategy, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.FrameService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [START_PATH]
                }, {
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnMtbG9jYXRpb24tc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvbGVnYWN5L3JvdXRlci9ucy1sb2NhdGlvbi1zdHJhdGVneS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUF1QixnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxvQkFBb0IsRUFBNEQsTUFBTSxpQkFBaUIsQ0FBQztBQUVqSCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDaEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsTUFBTSxFQUFvQyxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2xHLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7OztBQUsxQyxNQUFNLE9BQU8sa0JBQW1CLFNBQVEsZ0JBQWdCO0lBVXRELFlBQW9CLFlBQTBCLEVBQTBDLFNBQWtCO1FBQ3hHLEtBQUssRUFBRSxDQUFDO1FBRFUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBMEMsY0FBUyxHQUFULFNBQVMsQ0FBUztRQVRsRyxZQUFPLEdBQWtCLEVBQUUsQ0FBQztRQUc1QixzQkFBaUIsR0FBRyxJQUFJLEtBQUssRUFBbUIsQ0FBQztRQUlsRCwwQkFBcUIsR0FBRyxDQUFDLENBQUM7UUFJL0IsSUFBSSxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsRUFBRTtZQUNwQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsa0NBQWtDLENBQUMsQ0FBQztTQUNqRTtJQUNILENBQUM7SUFFRCxJ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amVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBMb2NhdGlvbkNoYW5nZUV2ZW50LCBMb2NhdGlvblN0cmF0ZWd5IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IERlZmF1bHRVcmxTZXJpYWxpemVyLCBVcmxTZWdtZW50R3JvdXAsIFVybFRyZWUsIEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBGcmFtZSB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4uLy4uL3RyYWNlJztcbmltcG9ydCB7IGlzUHJlc2VudCB9IGZyb20gJy4uLy4uL3V0aWxzL2xhbmctZmFjYWRlJztcbmltcG9ydCB7IEZyYW1lU2VydmljZSB9IGZyb20gJy4uL2ZyYW1lLnNlcnZpY2UnO1xuaW1wb3J0IHsgT3V0bGV0LCBOYXZpZ2F0aW9uT3B0aW9ucywgTG9jYXRpb25TdGF0ZSwgZGVmYXVsdE5hdk9wdGlvbnMgfSBmcm9tICcuL25zLWxvY2F0aW9uLXV0aWxzJztcbmltcG9ydCB7IFNUQVJUX1BBVEggfSBmcm9tICcuLi8uLi90b2tlbnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgTlNMb2NhdGlvblN0cmF0ZWd5IGV4dGVuZHMgTG9jYXRpb25TdHJhdGVneSB7XG4gIHByaXZhdGUgb3V0bGV0czogQXJyYXk8T3V0bGV0PiA9IFtdO1xuICBwcml2YXRlIGN1cnJlbnRPdXRsZXQ6IE91dGxldDtcblxuICBwcml2YXRlIHBvcFN0YXRlQ2FsbGJhY2tzID0gbmV3IEFycmF5PChfOiBhbnkpID0+IGFueT4oKTtcbiAgcHJpdmF0ZSBfY3VycmVudE5hdmlnYXRpb25PcHRpb25zOiBOYXZpZ2F0aW9uT3B0aW9ucztcbiAgcHJpdmF0ZSBjdXJyZW50VXJsVHJlZTogVXJsVHJlZTtcblxuICBwdWJsaWMgX21vZGFsTmF2aWdhdGlvbkRlcHRoID0gMDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZyYW1lU2VydmljZTogRnJhbWVTZXJ2aWNlLCBASW5qZWN0KFNUQVJUX1BBVEgpIEBPcHRpb25hbCgpIHByaXZhdGUgc3RhcnRQYXRoPzogc3RyaW5nKSB7XG4gICAgc3VwZXIoKTtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LmNvbnN0cnVjdG9yKCknKTtcbiAgICB9XG4gIH1cblxuICBwYXRoKCk6IHN0cmluZyB7XG4gICAgaWYgKCF0aGlzLmN1cnJlbnRVcmxUcmVlKSB7XG4gICAgICByZXR1cm4gdGhpcy5zdGFydFBhdGggfHwgJy8nO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5jdXJyZW50T3V0bGV0ICYmIHRoaXMuY3VycmVudE91dGxldC5wZWVrU3RhdGUoKTtcbiAgICBpZiAoIXN0YXRlKSB7XG4gICAgICByZXR1cm4gJy8nO1xuICAgIH1cblxuICAgIGxldCB0cmVlID0gdGhpcy5jdXJyZW50VXJsVHJlZTtcbiAgICBsZXQgY2hhbmdlZE91dGxldCA9IHRoaXMuZ2V0U2VnbWVudEdyb3VwQnlPdXRsZXQodGhpcy5jdXJyZW50T3V0bGV0KTtcblxuICAgIC8vIEhhbmRsZSBjYXNlIHdoZXJlIHRoZSB1c2VyIGRlY2xhcmVzIGEgY29tcG9uZW50IGF0IHBhdGggXCIvXCIuXG4gICAgLy8gVGhlIHVybCBzZXJpYWxpemVyIGRvZXNuJ3QgcGFyc2UgdGhpcyB1cmwgYXMgaGF2aW5nIGEgcHJpbWFyeSBvdXRsZXQuXG4gICAgaWYgKHN0YXRlLmlzUm9vdFNlZ21lbnRHcm91cCkge1xuICAgICAgdHJlZS5yb290ID0gc3RhdGUuc2VnbWVudEdyb3VwO1xuICAgIH0gZWxzZSBpZiAoY2hhbmdlZE91dGxldCkge1xuICAgICAgdGhpcy51cGRhdGVTZWdtZW50R3JvdXAodHJlZS5yb290LCBjaGFuZ2VkT3V0bGV0LCBzdGF0ZS5zZWdtZW50R3JvdXApO1xuICAgIH1cblxuICAgIGNvbnN0IHVybFNlcmlhbGl6ZXIgPSBuZXcgRGVmYXVsdFVybFNlcmlhbGl6ZXIoKTtcbiAgICB0cmVlLnF1ZXJ5UGFyYW1zID0gc3RhdGUucXVlcnlQYXJhbXM7XG4gICAgY29uc3QgdXJsID0gdXJsU2VyaWFsaXplci5zZXJpYWxpemUodHJlZSk7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5wYXRoKCk6ICcgKyB1cmwpO1xuICAgIH1cbiAgICByZXR1cm4gdXJsO1xuICB9XG5cbiAgcHJlcGFyZUV4dGVybmFsVXJsKGludGVybmFsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kucHJlcGFyZUV4dGVybmFsVXJsKCkgaW50ZXJuYWw6ICcgKyBpbnRlcm5hbCk7XG4gICAgfVxuICAgIHJldHVybiBpbnRlcm5hbDtcbiAgfVxuXG4gIHB1c2hTdGF0ZShzdGF0ZTogYW55LCB0aXRsZTogc3RyaW5nLCB1cmw6IHN0cmluZywgcXVlcnlQYXJhbXM6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kucHVzaFN0YXRlIHN0YXRlOiAnICsgYCR7c3RhdGV9LCB0aXRsZTogJHt0aXRsZX0sIHVybDogJHt1cmx9LCBxdWVyeVBhcmFtczogJHtxdWVyeVBhcmFtc31gKTtcbiAgICB9XG4gICAgdGhpcy5wdXNoU3RhdGVJbnRlcm5hbChzdGF0ZSwgdGl0bGUsIHVybCwgcXVlcnlQYXJhbXMpO1xuICB9XG5cbiAgcHVzaFN0YXRlSW50ZXJuYWwoc3RhdGU6IGFueSwgdGl0bGU6IHN0cmluZywgdXJsOiBzdHJpbmcsIHF1ZXJ5UGFyYW1zOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCB1cmxTZXJpYWxpemVyID0gbmV3IERlZmF1bHRVcmxTZXJpYWxpemVyKCk7XG4gICAgdGhpcy5jdXJyZW50VXJsVHJlZSA9IHVybFNlcmlhbGl6ZXIucGFyc2UodXJsKTtcbiAgICBjb25zdCB1cmxUcmVlUm9vdCA9IHRoaXMuY3VycmVudFVybFRyZWUucm9vdDtcblxuICAgIC8vIEhhbmRsZSBjYXNlIHdoZXJlIHRoZSB1c2VyIGRlY2xhcmVzIGEgY29tcG9uZW50IGF0IHBhdGggXCIvXCIuXG4gICAgLy8gVGhlIHVybCBzZXJpYWxpemVyIGRvZXNuJ3QgcGFyc2UgdGhpcyB1cmwgYXMgaGF2aW5nIGEgcHJpbWFyeSBvdXRsZXQuXG4gICAgaWYgKCFPYmplY3Qua2V5cyh1cmxUcmVlUm9vdC5jaGlsZHJlbikubGVuZ3RoKSB7XG4gICAgICBjb25zdCBzZWdtZW50R3JvdXAgPSB0aGlzLmN1cnJlbnRVcmxUcmVlICYmIHRoaXMuY3VycmVudFVybFRyZWUucm9vdDtcbiAgICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMuZ2V0T3V0bGV0S2V5KHRoaXMuZ2V0U2VnbWVudEdyb3VwRnVsbFBhdGgoc2VnbWVudEdyb3VwKSwgJ3ByaW1hcnknKTtcbiAgICAgIGNvbnN0IG91dGxldCA9IHRoaXMuZmluZE91dGxldChvdXRsZXRLZXkpO1xuXG4gICAgICBpZiAob3V0bGV0ICYmIHRoaXMudXBkYXRlU3RhdGVzKG91dGxldCwgc2VnbWVudEdyb3VwLCB0aGlzLmN1cnJlbnRVcmxUcmVlLnF1ZXJ5UGFyYW1zKSkge1xuICAgICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBvdXRsZXQ7IC8vIElmIHN0YXRlcyB1cGRhdGVkXG4gICAgICB9IGVsc2UgaWYgKCFvdXRsZXQpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICBjb25zdCByb290T3V0bGV0ID0gdGhpcy5jcmVhdGVPdXRsZXQoJ3ByaW1hcnknLCBudWxsLCBzZWdtZW50R3JvdXAsIG51bGwsIG51bGwsIHRoaXMuY3VycmVudFVybFRyZWUucXVlcnlQYXJhbXMpO1xuICAgICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSByb290T3V0bGV0O1xuICAgICAgfVxuXG4gICAgICB0aGlzLmN1cnJlbnRPdXRsZXQucGVla1N0YXRlKCkuaXNSb290U2VnbWVudEdyb3VwID0gdHJ1ZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBxdWV1ZSA9IFtdO1xuICAgIGxldCBjdXJyZW50VHJlZSA9IDxhbnk+dXJsVHJlZVJvb3Q7XG5cbiAgICB3aGlsZSAoY3VycmVudFRyZWUpIHtcbiAgICAgIE9iamVjdC5rZXlzKGN1cnJlbnRUcmVlLmNoaWxkcmVuKS5mb3JFYWNoKChvdXRsZXROYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRTZWdtZW50R3JvdXAgPSBjdXJyZW50VHJlZS5jaGlsZHJlbltvdXRsZXROYW1lXTtcbiAgICAgICAgY3VycmVudFNlZ21lbnRHcm91cC5vdXRsZXQgPSBvdXRsZXROYW1lO1xuICAgICAgICBjdXJyZW50U2VnbWVudEdyb3VwLnJvb3QgPSB1cmxUcmVlUm9vdDtcblxuICAgICAgICBjb25zdCBvdXRsZXRQYXRoID0gdGhpcy5nZXRTZWdtZW50R3JvdXBGdWxsUGF0aChjdXJyZW50VHJlZSk7XG4gICAgICAgIGxldCBvdXRsZXRLZXkgPSB0aGlzLmdldE91dGxldEtleShvdXRsZXRQYXRoLCBvdXRsZXROYW1lKTtcbiAgICAgICAgbGV0IG91dGxldCA9IHRoaXMuZmluZE91dGxldChvdXRsZXRLZXkpO1xuXG4gICAgICAgIGNvbnN0IHBhcmVudE91dGxldE5hbWUgPSBjdXJyZW50VHJlZS5vdXRsZXQgfHwgJyc7XG4gICAgICAgIGNvbnN0IHBhcmVudE91dGxldFBhdGggPSB0aGlzLmdldFNlZ21lbnRHcm91cEZ1bGxQYXRoKGN1cnJlbnRUcmVlLnBhcmVudCk7XG4gICAgICAgIGNvbnN0IHBhcmVudE91dGxldEtleSA9IHRoaXMuZ2V0T3V0bGV0S2V5KHBhcmVudE91dGxldFBhdGgsIHBhcmVudE91dGxldE5hbWUpO1xuICAgICAgICBjb25zdCBwYXJlbnRPdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXQocGFyZW50T3V0bGV0S2V5KTtcblxuICAgICAgICBjb25zdCBjb250YWluc0xhc3RTdGF0ZSA9IG91dGxldCAmJiBvdXRsZXQuY29udGFpbnNUb3BTdGF0ZShjdXJyZW50U2VnbWVudEdyb3VwLnRvU3RyaW5nKCkpO1xuICAgICAgICBpZiAoIW91dGxldCkge1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgICBvdXRsZXQgPSB0aGlzLmNyZWF0ZU91dGxldChvdXRsZXRLZXksIG91dGxldFBhdGgsIGN1cnJlbnRTZWdtZW50R3JvdXAsIHBhcmVudE91dGxldCwgdGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGgsIHRoaXMuY3VycmVudFVybFRyZWUucXVlcnlQYXJhbXMpO1xuICAgICAgICAgIHRoaXMuY3VycmVudE91dGxldCA9IG91dGxldDtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCA+IDAgJiYgb3V0bGV0LnNob3dpbmdNb2RhbCAmJiAhY29udGFpbnNMYXN0U3RhdGUpIHtcbiAgICAgICAgICAvLyBOYXZpZ2F0aW9uIGluc2lkZSBtb2RhbCB2aWV3LlxuICAgICAgICAgIHRoaXMudXBzZXJ0TW9kYWxPdXRsZXQob3V0bGV0LCBjdXJyZW50U2VnbWVudEdyb3VwLCB0aGlzLmN1cnJlbnRVcmxUcmVlLnF1ZXJ5UGFyYW1zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdXRsZXQucGFyZW50ID0gcGFyZW50T3V0bGV0O1xuXG4gICAgICAgICAgaWYgKHRoaXMudXBkYXRlU3RhdGVzKG91dGxldCwgY3VycmVudFNlZ21lbnRHcm91cCwgdGhpcy5jdXJyZW50VXJsVHJlZS5xdWVyeVBhcmFtcykpIHtcbiAgICAgICAgICAgIHRoaXMuY3VycmVudE91dGxldCA9IG91dGxldDsgLy8gSWYgc3RhdGVzIHVwZGF0ZWRcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBxdWV1ZS5wdXNoKGN1cnJlbnRTZWdtZW50R3JvdXApO1xuICAgICAgfSk7XG5cbiAgICAgIGN1cnJlbnRUcmVlID0gcXVldWUuc2hpZnQoKTtcbiAgICB9XG4gIH1cblxuICByZXBsYWNlU3RhdGUoc3RhdGU6IGFueSwgdGl0bGU6IHN0cmluZywgdXJsOiBzdHJpbmcsIHF1ZXJ5UGFyYW1zOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0ZXMgPSB0aGlzLmN1cnJlbnRPdXRsZXQgJiYgdGhpcy5jdXJyZW50T3V0bGV0LnN0YXRlcztcblxuICAgIGlmIChzdGF0ZXMgJiYgc3RhdGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5yZXBsYWNlU3RhdGUgY2hhbmdpbmcgZXhpc3Rpbmcgc3RhdGU6ICcgKyBgJHtzdGF0ZX0sIHRpdGxlOiAke3RpdGxlfSwgdXJsOiAke3VybH0sIHF1ZXJ5UGFyYW1zOiAke3F1ZXJ5UGFyYW1zfWApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kucmVwbGFjZVN0YXRlIHB1c2hpbmcgbmV3IHN0YXRlOiAnICsgYCR7c3RhdGV9LCB0aXRsZTogJHt0aXRsZX0sIHVybDogJHt1cmx9LCBxdWVyeVBhcmFtczogJHtxdWVyeVBhcmFtc31gKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucHVzaFN0YXRlSW50ZXJuYWwoc3RhdGUsIHRpdGxlLCB1cmwsIHF1ZXJ5UGFyYW1zKTtcbiAgICB9XG4gIH1cblxuICBmb3J3YXJkKCk6IHZvaWQge1xuICAgIHRocm93IG5ldyBFcnJvcignTlNMb2NhdGlvblN0cmF0ZWd5LmZvcndhcmQoKSAtIG5vdCBpbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgYmFjayhvdXRsZXQ/OiBPdXRsZXQsIGZyYW1lPzogRnJhbWUpOiB2b2lkIHtcbiAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBvdXRsZXQgfHwgdGhpcy5jdXJyZW50T3V0bGV0O1xuXG4gICAgaWYgKHRoaXMuY3VycmVudE91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjaykge1xuICAgICAgY29uc3Qgc3RhdGVzID0gdGhpcy5jdXJyZW50T3V0bGV0LnN0YXRlcztcbiAgICAgIC8vIFdlIGFyZSBuYXZpZ2F0aW5nIHRvIHRoZSBwcmV2aW91cyBwYWdlXG4gICAgICAvLyBjbGVhciB0aGUgc3RhY2sgdW50aWwgd2UgZ2V0IHRvIGEgcGFnZSBuYXZpZ2F0aW9uIHN0YXRlXG4gICAgICBsZXQgc3RhdGUgPSBzdGF0ZXMucG9wKCk7XG4gICAgICBsZXQgY291bnQgPSAxO1xuXG4gICAgICBpZiAoZnJhbWUpIHtcbiAgICAgICAgd2hpbGUgKHN0YXRlLmZyYW1lICYmIHN0YXRlLmZyYW1lICE9PSBmcmFtZSkge1xuICAgICAgICAgIHN0YXRlID0gc3RhdGVzLnBvcCgpO1xuICAgICAgICAgIGNvdW50Kys7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgd2hpbGUgKCFzdGF0ZS5pc1BhZ2VOYXZpZ2F0aW9uKSB7XG4gICAgICAgIHN0YXRlID0gc3RhdGVzLnBvcCgpO1xuICAgICAgICBjb3VudCsrO1xuICAgICAgfVxuXG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBOU0xvY2F0aW9uU3RyYXRlZ3kuYmFjaygpIHdoaWxlIG5hdmlnYXRpbmcgYmFjay4gU3RhdGVzIHBvcHBlZDogJHtjb3VudH1gKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuY2FsbFBvcFN0YXRlKHN0YXRlLCB0cnVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHN0YXRlID0gdGhpcy5jdXJyZW50T3V0bGV0LnBlZWtTdGF0ZSgpO1xuICAgICAgaWYgKHN0YXRlICYmIHN0YXRlLmlzUGFnZU5hdmlnYXRpb24pIHtcbiAgICAgICAgLy8gVGhpcyB3YXMgYSBwYWdlIG5hdmlnYXRpb24gLSBzbyBuYXZpZ2F0ZSB0aHJvdWdoIGZyYW1lLlxuICAgICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5iYWNrKCkgd2hpbGUgbm90IG5hdmlnYXRpbmcgYmFjayBidXQgdG9wJyArICcgc3RhdGUgaXMgcGFnZSAtIHdpbGwgY2FsbCBmcmFtZS5nb0JhY2soKScpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFvdXRsZXQpIHtcbiAgICAgICAgICBjb25zdCB0b3Btb3N0RnJhbWUgPSB0aGlzLmZyYW1lU2VydmljZS5nZXRGcmFtZSgpO1xuICAgICAgICAgIHRoaXMuY3VycmVudE91dGxldCA9IHRoaXMuZ2V0T3V0bGV0QnlGcmFtZSh0b3Btb3N0RnJhbWUpIHx8IHRoaXMuY3VycmVudE91dGxldDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGZyYW1lVG9CYWNrOiBGcmFtZSA9IHRoaXMuY3VycmVudE91dGxldC5nZXRGcmFtZVRvQmFjaygpO1xuICAgICAgICBpZiAoZnJhbWVUb0JhY2spIHtcbiAgICAgICAgICBmcmFtZVRvQmFjay5nb0JhY2soKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gTmVzdGVkIG5hdmlnYXRpb24gLSBqdXN0IHBvcCB0aGUgc3RhdGVcbiAgICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuYmFjaygpIHdoaWxlIG5vdCBuYXZpZ2F0aW5nIGJhY2sgYnV0IHRvcCcgKyAnIHN0YXRlIGlzIG5vdCBwYWdlIC0ganVzdCBwb3AnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY2FsbFBvcFN0YXRlKHRoaXMuY3VycmVudE91dGxldC5zdGF0ZXMucG9wKCksIHRydWUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNhbkdvQmFjayhvdXRsZXQ/OiBPdXRsZXQpIHtcbiAgICBvdXRsZXQgPSBvdXRsZXQgfHwgdGhpcy5jdXJyZW50T3V0bGV0O1xuICAgIHJldHVybiBvdXRsZXQuc3RhdGVzLmxlbmd0aCA+IDE7XG4gIH1cblxuICBvblBvcFN0YXRlKGZuOiAoXzogYW55KSA9PiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5Lm9uUG9wU3RhdGUnKTtcbiAgICB9XG4gICAgdGhpcy5wb3BTdGF0ZUNhbGxiYWNrcy5wdXNoKGZuKTtcbiAgfVxuXG4gIGdldEJhc2VIcmVmKCk6IHN0cmluZyB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5nZXRCYXNlSHJlZigpJyk7XG4gICAgfVxuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIHByaXZhdGUgY2FsbFBvcFN0YXRlKHN0YXRlOiBMb2NhdGlvblN0YXRlLCBwb3A6IGJvb2xlYW4gPSB0cnVlLCBvdXRsZXQ/OiBPdXRsZXQpIHtcbiAgICBvdXRsZXQgPSBvdXRsZXQgfHwgdGhpcy5jdXJyZW50T3V0bGV0O1xuICAgIGNvbnN0IHVybFNlcmlhbGl6ZXIgPSBuZXcgRGVmYXVsdFVybFNlcmlhbGl6ZXIoKTtcbiAgICBsZXQgY2hhbmdlZE91dGxldCA9IHRoaXMuZ2V0U2VnbWVudEdyb3VwQnlPdXRsZXQob3V0bGV0KTtcblxuICAgIGlmIChzdGF0ZSAmJiBjaGFuZ2VkT3V0bGV0KSB7XG4gICAgICB0aGlzLnVwZGF0ZVNlZ21lbnRHcm91cCh0aGlzLmN1cnJlbnRVcmxUcmVlLnJvb3QsIGNoYW5nZWRPdXRsZXQsIHN0YXRlLnNlZ21lbnRHcm91cCk7XG4gICAgfSBlbHNlIGlmIChjaGFuZ2VkT3V0bGV0KSB7XG4gICAgICAvLyB3aGVuIGNsb3NpbmcgbW9kYWwgdmlldyB0aGVyZSBhcmUgc2NlbmFyaW9zIChlLmcuIHJvb3Qgdmlld0NvbnRhaW5lclJlZikgd2hlbiB3ZSBuZWVkXG4gICAgICAvLyB0byBjbGVhbiB1cCB0aGUgbmFtZWQgcGFnZSByb3V0ZXIgb3V0bGV0IHRvIG1ha2Ugc3VyZSB3ZSB3aWxsIG9wZW4gdGhlIG1vZGFsIHByb3Blcmx5IGFnYWluIGlmIG5lZWRlZC5cbiAgICAgIHRoaXMudXBkYXRlU2VnbWVudEdyb3VwKHRoaXMuY3VycmVudFVybFRyZWUucm9vdCwgY2hhbmdlZE91dGxldCwgbnVsbCk7XG4gICAgfVxuXG4gICAgY29uc3QgdXJsID0gdXJsU2VyaWFsaXplci5zZXJpYWxpemUodGhpcy5jdXJyZW50VXJsVHJlZSk7XG4gICAgY29uc3QgY2hhbmdlOiBMb2NhdGlvbkNoYW5nZUV2ZW50ID0geyBzdGF0ZSwgdHlwZTogJ3BvcHN0YXRlJyB9O1xuICAgIGZvciAobGV0IGZuIG9mIHRoaXMucG9wU3RhdGVDYWxsYmFja3MpIHtcbiAgICAgIGZuKGNoYW5nZSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHRvU3RyaW5nKCkge1xuICAgIGxldCByZXN1bHQgPSBbXTtcblxuICAgIHRoaXMub3V0bGV0cy5mb3JFYWNoKChvdXRsZXQpID0+IHtcbiAgICAgIGNvbnN0IG91dGxldFN0YXRlcyA9IG91dGxldC5zdGF0ZXM7XG4gICAgICBjb25zdCBvdXRsZXRMb2cgPSBvdXRsZXRTdGF0ZXNcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICAubWFwKCh2LCBpKSA9PiBgJHtvdXRsZXQub3V0bGV0S2V5c30uJHtpfS5bJHt2LmlzUGFnZU5hdmlnYXRpb24gPyAnUEFHRScgOiAnSU5URVJOQUwnfV0uWyR7b3V0bGV0Lm1vZGFsTmF2aWdhdGlvbkRlcHRoID8gJ01PREFMJyA6ICdCQVNFJ31dIFwiJHt2LnNlZ21lbnRHcm91cC50b1N0cmluZygpfVwiYClcbiAgICAgICAgLnJldmVyc2UoKTtcblxuICAgICAgcmVzdWx0ID0gcmVzdWx0LmNvbmNhdChvdXRsZXRMb2cpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlc3VsdC5qb2luKCdcXG4nKTtcbiAgfVxuXG4gIC8vIE1ldGhvZHMgZm9yIHN5bmNpbmcgd2l0aCBwYWdlIG5hdmlnYXRpb24gaW4gUGFnZVJvdXRlck91dGxldFxuICBwdWJsaWMgX2JlZ2luQmFja1BhZ2VOYXZpZ2F0aW9uKGZyYW1lOiBGcmFtZSkge1xuICAgIGNvbnN0IG91dGxldDogT3V0bGV0ID0gdGhpcy5nZXRPdXRsZXRCeUZyYW1lKGZyYW1lKTtcblxuICAgIGlmICghb3V0bGV0IHx8IG91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjaykge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckVycm9yKCdBdHRlbXB0ZWQgdG8gY2FsbCBzdGFydEdvQmFjayB3aGlsZSBnb2luZyBiYWNrLicpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuc3RhcnRHb0JhY2soKScpO1xuICAgIH1cbiAgICBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgPSB0cnVlO1xuICAgIC8vIHdlIGZpbmQgYWxsIHRoZSBjaGlsZHJlbiBhbmQgYWxzbyBzZXQgdGhlaXIgaXNQYWdlTmF2aWdhdGlvbkJhY2tcbiAgICB0aGlzLm91dGxldHNcbiAgICAgIC5maWx0ZXIoKG8pID0+IHtcbiAgICAgICAgbGV0IHBhcmVudCA9IG8ucGFyZW50O1xuICAgICAgICB3aGlsZSAocGFyZW50KSB7XG4gICAgICAgICAgaWYgKHBhcmVudCA9PT0gb3V0bGV0KSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9KVxuICAgICAgLmZvckVhY2goKG8pID0+IChvLmlzUGFnZU5hdmlnYXRpb25CYWNrID0gdHJ1ZSkpO1xuXG4gICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gb3V0bGV0O1xuICB9XG5cbiAgcHVibGljIF9maW5pc2hCYWNrUGFnZU5hdmlnYXRpb24oZnJhbWU6IEZyYW1lKSB7XG4gICAgY29uc3Qgb3V0bGV0OiBPdXRsZXQgPSB0aGlzLmdldE91dGxldEJ5RnJhbWUoZnJhbWUpO1xuXG4gICAgaWYgKCFvdXRsZXQgfHwgIW91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjaykge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckVycm9yKCdBdHRlbXB0ZWQgdG8gY2FsbCBlbmRHb0JhY2sgd2hpbGUgbm90IGdvaW5nIGJhY2suJyk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5maW5pc2hCYWNrUGFnZU5hdmlnYXRpb24oKScpO1xuICAgIH1cbiAgICBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgPSBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyBfYmVnaW5Nb2RhbE5hdmlnYXRpb24oZnJhbWU6IEZyYW1lKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5fYmVnaW5Nb2RhbE5hdmlnYXRpb24oKScpO1xuICAgIH1cblxuICAgIHRoaXMuY3VycmVudE91dGxldCA9IHRoaXMuZ2V0T3V0bGV0QnlGcmFtZShmcmFtZSkgfHwgdGhpcy5jdXJyZW50T3V0bGV0O1xuXG4gICAgLy8gSXQgaXMgcG9zc2libGUgdG8gaGF2ZSBmcmFtZSwgYnV0IG5vdCBjb3JyZXNwb25kaW5nIE91dGxldCwgaWZcbiAgICAvLyBzaG93aW5nIG1vZGFsIGRpYWxvZyBvbiBhcHAuY29tcG9uZW50LnRzIG5nT25Jbml0KCkgZS5nLiBJbiB0aGF0IGNhc2VcbiAgICAvLyB0aGUgbW9kYWwgaXMgdHJlYXRlZCBhcyBub25lIG1vZGFsIG5hdmlnYXRpb24uXG4gICAgaWYgKHRoaXMuY3VycmVudE91dGxldCkge1xuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0LnNob3dpbmdNb2RhbCA9IHRydWU7XG4gICAgICB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCsrO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBfY2xvc2VNb2RhbE5hdmlnYXRpb24oKSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5jbG9zZU1vZGFsTmF2aWdhdGlvbigpJyk7XG4gICAgfVxuXG4gICAgY29uc3QgaXNTaG93aW5nTW9kYWwgPSB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCA+IDA7XG5cbiAgICBpZiAoaXNTaG93aW5nTW9kYWwpIHtcbiAgICAgIHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoLS07XG4gICAgfVxuXG4gICAgLy8gY3VycmVudE91dGxldCBzaG91bGQgYmUgdGhlIG9uZSB0aGF0IGNvcnJlc3BvbmRzIHRvIHRoZSB0b3Btb3N0IGZyYW1lXG4gICAgY29uc3QgdG9wbW9zdE91dGxldCA9IHRoaXMuZ2V0T3V0bGV0QnlGcmFtZSh0aGlzLmZyYW1lU2VydmljZS5nZXRGcmFtZSgpKTtcbiAgICBjb25zdCBvdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXRCeU1vZGFsKHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoLCBpc1Nob3dpbmdNb2RhbCkgfHwgdG9wbW9zdE91dGxldDtcblxuICAgIGlmIChvdXRsZXQpIHtcbiAgICAgIHRoaXMuY3VycmVudE91dGxldCA9IG91dGxldDtcbiAgICAgIHRoaXMuY3VycmVudE91dGxldC5zaG93aW5nTW9kYWwgPSBmYWxzZTtcbiAgICAgIHRoaXMuY2FsbFBvcFN0YXRlKHRoaXMuY3VycmVudE91dGxldC5wZWVrU3RhdGUoKSwgZmFsc2UpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBfYmVnaW5QYWdlTmF2aWdhdGlvbihmcmFtZTogRnJhbWUpOiBOYXZpZ2F0aW9uT3B0aW9ucyB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5fYmVnaW5QYWdlTmF2aWdhdGlvbigpJyk7XG4gICAgfVxuXG4gICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gdGhpcy5nZXRPdXRsZXRCeUZyYW1lKGZyYW1lKSB8fCB0aGlzLmN1cnJlbnRPdXRsZXQ7XG4gICAgY29uc3QgbGFzdFN0YXRlID0gdGhpcy5jdXJyZW50T3V0bGV0LnBlZWtTdGF0ZSgpO1xuXG4gICAgaWYgKGxhc3RTdGF0ZSkge1xuICAgICAgbGFzdFN0YXRlLmlzUGFnZU5hdmlnYXRpb24gPSB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IG5hdk9wdGlvbnMgPSB0aGlzLl9jdXJyZW50TmF2aWdhdGlvbk9wdGlvbnMgfHwgZGVmYXVsdE5hdk9wdGlvbnM7XG4gICAgaWYgKG5hdk9wdGlvbnMuY2xlYXJIaXN0b3J5KSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuX2JlZ2luUGFnZU5hdmlnYXRpb24gY2xlYXJpbmcgc3RhdGVzIGhpc3RvcnknKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuY3VycmVudE91dGxldC5zdGF0ZXMgPSBbbGFzdFN0YXRlXTtcbiAgICB9XG5cbiAgICB0aGlzLl9jdXJyZW50TmF2aWdhdGlvbk9wdGlvbnMgPSB1bmRlZmluZWQ7XG4gICAgcmV0dXJuIG5hdk9wdGlvbnM7XG4gIH1cblxuICBwdWJsaWMgX3NldE5hdmlnYXRpb25PcHRpb25zKG9wdGlvbnM6IE5hdmlnYXRpb25PcHRpb25zKSB7XG4gICAgdGhpcy5fY3VycmVudE5hdmlnYXRpb25PcHRpb25zID0ge1xuICAgICAgY2xlYXJIaXN0b3J5OiBpc1ByZXNlbnQob3B0aW9ucy5jbGVhckhpc3RvcnkpID8gb3B0aW9ucy5jbGVhckhpc3RvcnkgOiBmYWxzZSxcbiAgICAgIGFuaW1hdGVkOiBpc1ByZXNlbnQob3B0aW9ucy5hbmltYXRlZCkgPyBvcHRpb25zLmFuaW1hdGVkIDogdHJ1ZSxcbiAgICAgIHRyYW5zaXRpb246IG9wdGlvbnMudHJhbnNpdGlvbixcbiAgICB9O1xuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5fc2V0TmF2aWdhdGlvbk9wdGlvbnMoJyArIGAke0pTT04uc3RyaW5naWZ5KHRoaXMuX2N1cnJlbnROYXZpZ2F0aW9uT3B0aW9ucyl9KWApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBfZ2V0T3V0bGV0cygpOiBBcnJheTxPdXRsZXQ+IHtcbiAgICByZXR1cm4gdGhpcy5vdXRsZXRzO1xuICB9XG5cbiAgdXBkYXRlT3V0bGV0RnJhbWUob3V0bGV0OiBPdXRsZXQsIGZyYW1lOiBGcmFtZSwgaXNFbXB0eU91dGxldEZyYW1lOiBib29sZWFuKSB7XG4gICAgY29uc3QgbGFzdFN0YXRlID0gb3V0bGV0LnBlZWtTdGF0ZSgpO1xuXG4gICAgaWYgKGxhc3RTdGF0ZSAmJiAhbGFzdFN0YXRlLmZyYW1lICYmICFpc0VtcHR5T3V0bGV0RnJhbWUpIHtcbiAgICAgIGxhc3RTdGF0ZS5mcmFtZSA9IGZyYW1lO1xuICAgIH1cblxuICAgIGlmICghb3V0bGV0LmNvbnRhaW5zRnJhbWUoZnJhbWUpKSB7XG4gICAgICBvdXRsZXQuZnJhbWVzLnB1c2goZnJhbWUpO1xuICAgIH1cbiAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBvdXRsZXQ7XG4gIH1cblxuICBjbGVhck91dGxldChmcmFtZTogRnJhbWUpIHtcbiAgICB0aGlzLm91dGxldHMgPSB0aGlzLm91dGxldHMuZmlsdGVyKChjdXJyZW50T3V0bGV0KSA9PiB7XG4gICAgICBsZXQgaXNFcXVhbFRvQ3VycmVudDtcblxuICAgICAgaWYgKHRoaXMuY3VycmVudE91dGxldCkge1xuICAgICAgICBpc0VxdWFsVG9DdXJyZW50ID0gY3VycmVudE91dGxldC5wYXRoQnlPdXRsZXRzID09PSB0aGlzLmN1cnJlbnRPdXRsZXQucGF0aEJ5T3V0bGV0cztcbiAgICAgIH1cblxuICAgICAgLy8gUmVtb3ZlIG91dGxldCBmcm9tIHRoZSB1cmwgdHJlZS5cbiAgICAgIGlmIChjdXJyZW50T3V0bGV0LmNvbnRhaW5zRnJhbWUoZnJhbWUpICYmICFpc0VxdWFsVG9DdXJyZW50KSB7XG4gICAgICAgIHRoaXMuY2FsbFBvcFN0YXRlKG51bGwsIHRydWUsIGN1cnJlbnRPdXRsZXQpO1xuICAgICAgfVxuXG4gICAgICAvLyBTa2lwIGZyYW1lcyBmaWx0ZXJpbmcgc2luY2UgY3VycmVudE91dGxldCBpcyA8cm91dGVyLW91dGxldD4gd2hlbiBubyBmcmFtZXMgYXZhaWxhYmxlLlxuICAgICAgaWYgKGN1cnJlbnRPdXRsZXQuZnJhbWVzLmxlbmd0aCAmJiAhY3VycmVudE91dGxldC5pc05TRW1wdHlPdXRsZXQpIHtcbiAgICAgICAgY3VycmVudE91dGxldC5mcmFtZXMgPSBjdXJyZW50T3V0bGV0LmZyYW1lcy5maWx0ZXIoKGN1cnJlbnRGcmFtZSkgPT4gY3VycmVudEZyYW1lICE9PSBmcmFtZSk7XG4gICAgICAgIHJldHVybiBjdXJyZW50T3V0bGV0LmZyYW1lcy5sZW5ndGg7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiAhY3VycmVudE91dGxldC5jb250YWluc0ZyYW1lKGZyYW1lKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldFNlZ21lbnRHcm91cEZ1bGxQYXRoKHNlZ21lbnRHcm91cDogVXJsU2VnbWVudEdyb3VwKTogc3RyaW5nIHtcbiAgICBsZXQgZnVsbFBhdGggPSAnJztcblxuICAgIHdoaWxlIChzZWdtZW50R3JvdXApIHtcbiAgICAgIGNvbnN0IHVybCA9IHNlZ21lbnRHcm91cC50b1N0cmluZygpO1xuXG4gICAgICBpZiAoZnVsbFBhdGgpIHtcbiAgICAgICAgZnVsbFBhdGggPSAodXJsID8gdXJsICsgJy8nIDogJycpICsgZnVsbFBhdGg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmdWxsUGF0aCA9IHVybDtcbiAgICAgIH1cblxuICAgICAgc2VnbWVudEdyb3VwID0gc2VnbWVudEdyb3VwLnBhcmVudDtcbiAgICB9XG5cbiAgICByZXR1cm4gZnVsbFBhdGg7XG4gIH1cblxuICBnZXRSb3V0ZUZ1bGxQYXRoKGN1cnJlbnRSb3V0ZTogYW55KTogc3RyaW5nIHtcbiAgICBjb25zdCBvdXRsZXROYW1lID0gY3VycmVudFJvdXRlLm91dGxldDtcbiAgICBsZXQgZnVsbFBhdGg7XG5cbiAgICBjdXJyZW50Um91dGUgPSBjdXJyZW50Um91dGUucGFyZW50O1xuICAgIHdoaWxlIChjdXJyZW50Um91dGUpIHtcbiAgICAgIGNvbnN0IHVybHMgPSBjdXJyZW50Um91dGUudXJsLnZhbHVlIHx8IGN1cnJlbnRSb3V0ZS51cmw7XG4gICAgICBsZXQgdXJsID0gdXJscztcblxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkodXJscykpIHtcbiAgICAgICAgdXJsID0gdXJsLmpvaW4oJy8nKTtcbiAgICAgIH1cblxuICAgICAgZnVsbFBhdGggPSBmdWxsUGF0aCA/ICh1cmwgPyB1cmwgKyAnLycgOiB1cmwpICsgZnVsbFBhdGggOiB1cmw7XG4gICAgICBjdXJyZW50Um91dGUgPSBjdXJyZW50Um91dGUucGFyZW50O1xuICAgIH1cblxuICAgIHJldHVybiBmdWxsUGF0aCA/IGZ1bGxQYXRoICsgJy0nICsgb3V0bGV0TmFtZSA6IG91dGxldE5hbWU7XG4gIH1cblxuICBnZXRQYXRoQnlPdXRsZXRzKHVybFNlZ21lbnRHcm91cDogYW55KTogc3RyaW5nIHtcbiAgICBpZiAoIXVybFNlZ21lbnRHcm91cCkge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIGxldCBwYXRoVG9PdXRsZXQ7XG4gICAgbGV0IGxhc3RQYXRoID0gdXJsU2VnbWVudEdyb3VwLm91dGxldCB8fCAncHJpbWFyeSc7XG4gICAgbGV0IHBhcmVudCA9IHVybFNlZ21lbnRHcm91cC5wYXJlbnQ7XG5cbiAgICB3aGlsZSAocGFyZW50ICYmIHVybFNlZ21lbnRHcm91cC5yb290ICE9PSBwYXJlbnQpIHtcbiAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50Lm91dGxldCAhPT0gbGFzdFBhdGgpIHtcbiAgICAgICAgaWYgKGxhc3RQYXRoID09PSAncHJpbWFyeScpIHtcbiAgICAgICAgICBsYXN0UGF0aCA9IHBhcmVudC5vdXRsZXQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGFzdFBhdGggPSBwYXJlbnQub3V0bGV0O1xuICAgICAgICAgIHBhdGhUb091dGxldCA9IGxhc3RQYXRoICsgJy0nICsgKHBhdGhUb091dGxldCB8fCB1cmxTZWdtZW50R3JvdXAub3V0bGV0KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50O1xuICAgIH1cblxuICAgIHJldHVybiBwYXRoVG9PdXRsZXQgfHwgbGFzdFBhdGg7XG4gIH1cblxuICBmaW5kT3V0bGV0KG91dGxldEtleTogc3RyaW5nLCBhY3RpdmF0ZWRSb3V0ZVNuYXBzaG90PzogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IE91dGxldCB7XG4gICAgbGV0IG91dGxldDogT3V0bGV0ID0gdGhpcy5vdXRsZXRzLmZpbmQoKGN1cnJlbnRPdXRsZXQpID0+IHtcbiAgICAgIGxldCBlcXVhbE1vZGFsRGVwdGggPSBjdXJyZW50T3V0bGV0Lm1vZGFsTmF2aWdhdGlvbkRlcHRoID09PSB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aDtcbiAgICAgIHJldHVybiBlcXVhbE1vZGFsRGVwdGggJiYgY3VycmVudE91dGxldC5vdXRsZXRLZXlzLmluZGV4T2Yob3V0bGV0S2V5KSA+IC0xO1xuICAgIH0pO1xuXG4gICAgLy8gTm8gT3V0bGV0IHdpdGggdGhlIGdpdmVuIG91dGxldEtleSBjb3VsZCBoYXBwZW4gd2hlbiB1c2luZyBuZXN0ZWQgdW5uYW1lZCBwLXItb1xuICAgIC8vIHByaW1hcnkgLT4gcHJpbWFyeSAtPiBwcnltYXJ5XG4gICAgaWYgKCFvdXRsZXQgJiYgYWN0aXZhdGVkUm91dGVTbmFwc2hvdCkge1xuICAgICAgY29uc3QgcGF0aEJ5T3V0bGV0cyA9IHRoaXMuZ2V0UGF0aEJ5T3V0bGV0cyhhY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTtcbiAgICAgIG91dGxldCA9IHRoaXMub3V0bGV0cy5maW5kKChjdXJyZW50T3V0bGV0KSA9PiB7XG4gICAgICAgIGxldCBlcXVhbE1vZGFsRGVwdGggPSBjdXJyZW50T3V0bGV0Lm1vZGFsTmF2aWdhdGlvbkRlcHRoID09PSB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aDtcbiAgICAgICAgcmV0dXJuIGVxdWFsTW9kYWxEZXB0aCAmJiBjdXJyZW50T3V0bGV0LnBhdGhCeU91dGxldHMgPT09IHBhdGhCeU91dGxldHM7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gb3V0bGV0O1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kT3V0bGV0QnlNb2RhbChtb2RhbE5hdmlnYXRpb246IG51bWJlciwgaXNTaG93aW5nTW9kYWw/OiBib29sZWFuKTogT3V0bGV0IHtcbiAgICByZXR1cm4gdGhpcy5vdXRsZXRzLmZpbmQoKG91dGxldCkgPT4ge1xuICAgICAgbGV0IGVxdWFsTW9kYWxEZXB0aCA9IG91dGxldC5tb2RhbE5hdmlnYXRpb25EZXB0aCA9PT0gbW9kYWxOYXZpZ2F0aW9uO1xuICAgICAgcmV0dXJuIGlzU2hvd2luZ01vZGFsID8gZXF1YWxNb2RhbERlcHRoICYmIG91dGxldC5zaG93aW5nTW9kYWwgOiBlcXVhbE1vZGFsRGVwdGg7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldE91dGxldEJ5RnJhbWUoZnJhbWU6IEZyYW1lKTogT3V0bGV0IHtcbiAgICBsZXQgb3V0bGV0O1xuXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMub3V0bGV0cy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IGN1cnJlbnRPdXRsZXQgPSB0aGlzLm91dGxldHNbaW5kZXhdO1xuXG4gICAgICBpZiAoY3VycmVudE91dGxldC5jb250YWluc0ZyYW1lKGZyYW1lKSkge1xuICAgICAgICBvdXRsZXQgPSBjdXJyZW50T3V0bGV0O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gb3V0bGV0O1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVTdGF0ZXMob3V0bGV0OiBPdXRsZXQsIGN1cnJlbnRTZWdtZW50R3JvdXA6IFVybFNlZ21lbnRHcm91cCwgcXVlcnlQYXJhbXM6IFBhcmFtcyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGlzTmV3UGFnZSA9IG91dGxldC5zdGF0ZXMubGVuZ3RoID09PSAwO1xuICAgIGNvbnN0IGxhc3RTdGF0ZSA9IG91dGxldC5zdGF0ZXNbb3V0bGV0LnN0YXRlcy5sZW5ndGggLSAxXTtcbiAgICBjb25zdCBlcXVhbFN0YXRlVXJscyA9IG91dGxldC5jb250YWluc1RvcFN0YXRlKGN1cnJlbnRTZWdtZW50R3JvdXAudG9TdHJpbmcoKSk7XG5cbiAgICBjb25zdCBsb2NhdGlvblN0YXRlOiBMb2NhdGlvblN0YXRlID0ge1xuICAgICAgc2VnbWVudEdyb3VwOiBjdXJyZW50U2VnbWVudEdyb3VwLFxuICAgICAgaXNSb290U2VnbWVudEdyb3VwOiBmYWxzZSxcbiAgICAgIGlzUGFnZU5hdmlnYXRpb246IGlzTmV3UGFnZSxcbiAgICAgIHF1ZXJ5UGFyYW1zOiB7IC4uLnF1ZXJ5UGFyYW1zIH0sXG4gICAgfTtcblxuICAgIGlmICghbGFzdFN0YXRlIHx8ICFlcXVhbFN0YXRlVXJscykge1xuICAgICAgb3V0bGV0LnN0YXRlcy5wdXNoKGxvY2F0aW9uU3RhdGUpO1xuXG4gICAgICAvLyBVcGRhdGUgbGFzdCBzdGF0ZSBzZWdtZW50R3JvdXAgb2YgcGFyZW50IE91dGxldC5cbiAgICAgIGlmICh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCA9PT0gMCAmJiAhb3V0bGV0LnNob3dpbmdNb2RhbCkge1xuICAgICAgICB0aGlzLnVwZGF0ZVBhcmVudHNTdGF0ZXMob3V0bGV0LCBjdXJyZW50U2VnbWVudEdyb3VwLnBhcmVudCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlUGFyZW50c1N0YXRlcyhvdXRsZXQ6IE91dGxldCwgbmV3U2VnbWVudEdyb3VwOiBVcmxTZWdtZW50R3JvdXApIHtcbiAgICBsZXQgcGFyZW50T3V0bGV0ID0gb3V0bGV0LnBhcmVudDtcblxuICAgIC8vIFVwZGF0ZSBwYXJlbnRzIGxhc3RTdGF0ZSBzZWdtZW50R3JvdXBzXG4gICAgd2hpbGUgKHBhcmVudE91dGxldCAmJiBuZXdTZWdtZW50R3JvdXApIHtcbiAgICAgIGNvbnN0IHN0YXRlID0gcGFyZW50T3V0bGV0LnBlZWtTdGF0ZSgpO1xuXG4gICAgICBpZiAoc3RhdGUpIHtcbiAgICAgICAgc3RhdGUuc2VnbWVudEdyb3VwID0gbmV3U2VnbWVudEdyb3VwO1xuICAgICAgICBuZXdTZWdtZW50R3JvdXAgPSBuZXdTZWdtZW50R3JvdXAucGFyZW50O1xuICAgICAgICBwYXJlbnRPdXRsZXQgPSBwYXJlbnRPdXRsZXQucGFyZW50O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgcHJpdmF0ZSBjcmVhdGVPdXRsZXQob3V0bGV0S2V5OiBzdHJpbmcsIHBhdGg6IHN0cmluZywgc2VnbWVudEdyb3VwOiBhbnksIHBhcmVudDogT3V0bGV0LCBtb2RhbE5hdmlnYXRpb24/OiBudW1iZXIsIHF1ZXJ5UGFyYW1zOiBQYXJhbXMgPSB7fSk6IE91dGxldCB7XG4gICAgY29uc3QgcGF0aEJ5T3V0bGV0cyA9IHRoaXMuZ2V0UGF0aEJ5T3V0bGV0cyhzZWdtZW50R3JvdXApO1xuICAgIGNvbnN0IG5ld091dGxldCA9IG5ldyBPdXRsZXQob3V0bGV0S2V5LCBwYXRoLCBwYXRoQnlPdXRsZXRzLCBtb2RhbE5hdmlnYXRpb24pO1xuXG4gICAgY29uc3QgbG9jYXRpb25TdGF0ZTogTG9jYXRpb25TdGF0ZSA9IHtcbiAgICAgIHNlZ21lbnRHcm91cDogc2VnbWVudEdyb3VwLFxuICAgICAgaXNSb290U2VnbWVudEdyb3VwOiBmYWxzZSxcbiAgICAgIGlzUGFnZU5hdmlnYXRpb246IHRydWUsIC8vIEl0IGlzIGEgbmV3IE91dGxldE5vZGUuXG4gICAgICBxdWVyeVBhcmFtczogeyAuLi5xdWVyeVBhcmFtcyB9LFxuICAgIH07XG5cbiAgICBuZXdPdXRsZXQuc3RhdGVzID0gW2xvY2F0aW9uU3RhdGVdO1xuICAgIG5ld091dGxldC5wYXJlbnQgPSBwYXJlbnQ7XG4gICAgdGhpcy5vdXRsZXRzLnB1c2gobmV3T3V0bGV0KTtcblxuICAgIC8vIFVwZGF0ZSBsYXN0IHN0YXRlIHNlZ21lbnRHcm91cCBvZiBwYXJlbnQgT3V0bGV0LlxuICAgIGlmICh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCA9PT0gMCAmJiAhbmV3T3V0bGV0LnNob3dpbmdNb2RhbCkge1xuICAgICAgdGhpcy51cGRhdGVQYXJlbnRzU3RhdGVzKG5ld091dGxldCwgc2VnbWVudEdyb3VwLnBhcmVudCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld091dGxldDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U2VnbWVudEdyb3VwQnlPdXRsZXQob3V0bGV0OiBPdXRsZXQpOiBVcmxTZWdtZW50R3JvdXAge1xuICAgIGNvbnN0IHBhdGhMaXN0ID0gb3V0bGV0LnBhdGhCeU91dGxldHMuc3BsaXQoJy0nKTtcbiAgICBsZXQgc2VnbWVudEdyb3VwID0gdGhpcy5jdXJyZW50VXJsVHJlZS5yb290O1xuICAgIGxldCBwYXRoVG9PdXRsZXQ7XG5cbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcGF0aExpc3QubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBjdXJyZW50UGF0aCA9IHBhdGhMaXN0W2luZGV4XTtcbiAgICAgIGNvbnN0IGNoaWxkcmVuQ291bnQgPSBPYmplY3Qua2V5cyhzZWdtZW50R3JvdXAuY2hpbGRyZW4pLmxlbmd0aDtcblxuICAgICAgaWYgKGNoaWxkcmVuQ291bnQgJiYgc2VnbWVudEdyb3VwLmNoaWxkcmVuW2N1cnJlbnRQYXRoXSkge1xuICAgICAgICBjb25zdCB1cmwgPSBzZWdtZW50R3JvdXAudG9TdHJpbmcoKTtcbiAgICAgICAgcGF0aFRvT3V0bGV0ID0gcGF0aFRvT3V0bGV0ID8gcGF0aFRvT3V0bGV0ICsgJy8nICsgdXJsIDogdXJsO1xuICAgICAgICBzZWdtZW50R3JvdXAgPSBzZWdtZW50R3JvdXAuY2hpbGRyZW5bY3VycmVudFBhdGhdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gSWYgbm8gY2hpbGQgb3V0bGV0IGZvdW5kIHdpdGggdGhlIGdpdmVuIG5hbWUgLSBmb3JnZXQgYWJvdXQgYWxsIHByZXZpb3VzbHkgZm91bmQgb3V0bGV0cy5cbiAgICAgICAgLy8gZXhhbXBsZTogc2VhY2hpbmcgZm9yICdwcmltYXJ5LXNlY29uZC1wcmltYXJ5JyBzaG91bGRuJ3QgcmV0dXJuICdwcmltYXJ5LXNlY29uZCdcbiAgICAgICAgLy8gaWYgbm8gJ3ByaW1hcnknIGNoaWxkIGF2YWlsYWJsZSBvbiAnc2Vjb25kJy5cbiAgICAgICAgc2VnbWVudEdyb3VwID0gbnVsbDtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gUGF0aHMgc2hvdWxkIGFsc28gbWF0Y2ggc2luY2UgdGhlcmUgY291bGQgYmUgYW5vdGhlciBPdXRsZXRcbiAgICAvLyB3aXRoIHRoZSBzYW1lIHBhdGhCeU91dGxldHMgYnV0IGRpZmZlcmVudCB1cmwgcGF0aC5cbiAgICBpZiAoc2VnbWVudEdyb3VwICYmIG91dGxldC5wYXRoICYmIHBhdGhUb091dGxldCAmJiBvdXRsZXQucGF0aCAhPT0gcGF0aFRvT3V0bGV0KSB7XG4gICAgICBzZWdtZW50R3JvdXAgPSBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBzZWdtZW50R3JvdXA7XG4gIH1cblxuICAvLyBUcmF2ZXJzYWwgYW5kIHJlcGxhY2VtZW50IG9mIHNlZ21lbnRHcm91cC5cbiAgcHJpdmF0ZSB1cGRhdGVTZWdtZW50R3JvdXAocm9vdE5vZGU6IGFueSwgb2xkU2VnbWVudEdyb3VwOiBVcmxTZWdtZW50R3JvdXAsIG5ld1NlZ21lbnRHcm91cDogVXJsU2VnbWVudEdyb3VwKSB7XG4gICAgY29uc3QgcXVldWUgPSBbXTtcbiAgICBsZXQgY3VycmVudFRyZWUgPSByb290Tm9kZTtcblxuICAgIHdoaWxlIChjdXJyZW50VHJlZSkge1xuICAgICAgT2JqZWN0LmtleXMoY3VycmVudFRyZWUuY2hpbGRyZW4pLmZvckVhY2goKG91dGxldE5hbWUpID0+IHtcbiAgICAgICAgaWYgKGN1cnJlbnRUcmVlLmNoaWxkcmVuW291dGxldE5hbWVdID09PSBvbGRTZWdtZW50R3JvdXApIHtcbiAgICAgICAgICBpZiAobmV3U2VnbWVudEdyb3VwKSB7XG4gICAgICAgICAgICBjdXJyZW50VHJlZS5jaGlsZHJlbltvdXRsZXROYW1lXSA9IG5ld1NlZ21lbnRHcm91cDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVsZXRlIGN1cnJlbnRUcmVlLmNoaWxkcmVuW291dGxldE5hbWVdO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBxdWV1ZS5wdXNoKGN1cnJlbnRUcmVlLmNoaWxkcmVuW291dGxldE5hbWVdKTtcbiAgICAgIH0pO1xuXG4gICAgICBjdXJyZW50VHJlZSA9IHF1ZXVlLnNoaWZ0KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cHNlcnRNb2RhbE91dGxldChwYXJlbnRPdXRsZXQ6IE91dGxldCwgc2VnbWVudGVkR3JvdXA6IFVybFNlZ21lbnRHcm91cCwgcXVlcnlQYXJhbXM6IFBhcmFtcykge1xuICAgIGxldCBjdXJyZW50TW9kYWxPdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXRCeU1vZGFsKHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoKTtcblxuICAgIC8vIFdlIHdhbnQgdG8gdHJlYXQgZXZlcnkgcC1yLW8gYXMgYSBzdGFuZGFsb25lIE91dGxldC5cbiAgICBpZiAoIWN1cnJlbnRNb2RhbE91dGxldCkge1xuICAgICAgaWYgKHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoID4gMSkge1xuICAgICAgICAvLyBUaGUgcGFyZW50IG9mIHRoZSBjdXJyZW50IE91dGxldCBzaG91bGQgYmUgdGhlIHByZXZpb3VzIG9wZW5lZCBtb2RhbCAoaWYgYW55KS5cbiAgICAgICAgcGFyZW50T3V0bGV0ID0gdGhpcy5maW5kT3V0bGV0QnlNb2RhbCh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCAtIDEpO1xuICAgICAgfVxuXG4gICAgICAvLyBObyBjdXJyZW50TW9kYWxPdXRsZXQgYXZhaWxhYmxlIHdoZW4gb3BlbmluZyAncHJpbWFyeScgcC1yLW8uXG4gICAgICBjb25zdCBvdXRsZXROYW1lID0gJ3ByaW1hcnknO1xuICAgICAgY29uc3Qgb3V0bGV0UGF0aCA9IHBhcmVudE91dGxldC5wZWVrU3RhdGUoKS5zZWdtZW50R3JvdXAudG9TdHJpbmcoKTtcbiAgICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMuZ2V0T3V0bGV0S2V5KG91dGxldFBhdGgsIG91dGxldE5hbWUpO1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgY3VycmVudE1vZGFsT3V0bGV0ID0gdGhpcy5jcmVhdGVPdXRsZXQob3V0bGV0S2V5LCBvdXRsZXRQYXRoLCBzZWdtZW50ZWRHcm91cCwgcGFyZW50T3V0bGV0LCB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCwgcXVlcnlQYXJhbXMpO1xuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gY3VycmVudE1vZGFsT3V0bGV0O1xuICAgIH0gZWxzZSBpZiAodGhpcy51cGRhdGVTdGF0ZXMoY3VycmVudE1vZGFsT3V0bGV0LCBzZWdtZW50ZWRHcm91cCwgcXVlcnlQYXJhbXMpKSB7XG4gICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBjdXJyZW50TW9kYWxPdXRsZXQ7IC8vIElmIHN0YXRlcyB1cGRhdGVkXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRPdXRsZXRLZXkocGF0aDogc3RyaW5nLCBvdXRsZXROYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBwYXRoID8gcGF0aCArICctJyArIG91dGxldE5hbWUgOiBvdXRsZXROYW1lO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5uZ09uRGVzdHJveSgpJyk7XG4gICAgfVxuXG4gICAgdGhpcy5vdXRsZXRzID0gW107XG4gICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gbnVsbDtcbiAgfVxufVxuIl19