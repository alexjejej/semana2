import { __decorate, __metadata } from "tslib";
import { Attribute, ChangeDetectorRef, ComponentFactoryResolver, ComponentRef, Directive, Inject, Injector, EventEmitter, Output, ViewContainerRef, ElementRef, NgZone } from '@angular/core';
import { ActivatedRoute, ChildrenOutletContexts, PRIMARY_OUTLET } from '@angular/router';
import { Frame, Page, profile } from '@nativescript/core';
import { BehaviorSubject } from 'rxjs';
import { PAGE_FACTORY } from '../../tokens';
import { NativeScriptDebug } from '../../trace';
import { DetachedLoader } from '../../cdk/detached-loader';
import { ViewUtil } from '../../view-util';
import { NSLocationStrategy } from './ns-location-strategy';
import { NSRouteReuseStrategy } from './ns-route-reuse-strategy';
import { findTopActivatedRouteNodeForOutlet, pageRouterActivatedSymbol, loaderRefSymbol, destroyComponentRef } from './page-router-outlet-utils';
import { registerElement } from '../../element-registry';
import { PageService } from '../../cdk/frame-page/page.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "./ns-location-strategy";
import * as i3 from "./ns-route-reuse-strategy";
import * as i4 from "../../view-util";
export class PageRoute {
    constructor(startRoute) {
        this.activatedRoute = new BehaviorSubject(startRoute);
    }
}
export class DestructibleInjector {
    constructor(destructableProviders, parent) {
        this.destructableProviders = destructableProviders;
        this.parent = parent;
        this.refs = new Set();
    }
    get(token, notFoundValue, flags) {
        const ref = this.parent.get(token, notFoundValue, flags);
        if (this.destructableProviders.has(token)) {
            this.refs.add(ref);
        }
        return ref;
    }
    destroy() {
        this.refs.forEach((ref) => {
            if (ref.ngOnDestroy instanceof Function) {
                ref.ngOnDestroy();
            }
        });
        this.refs.clear();
    }
}
const routeToString = function (activatedRoute) {
    return activatedRoute.pathFromRoot.join('->');
};
registerElement('page-router-outlet', () => Frame);
// eslint-disable-next-line @angular-eslint/directive-selector
// eslint-disable-next-line @angular-eslint/directive-class-suffix
export class PageRouterOutlet {
    constructor(parentContexts, location, name, actionBarVisibility, isEmptyOutlet, locationStrategy, componentFactoryResolver, resolver, changeDetector, pageFactory, routeReuseStrategy, ngZone, elRef, viewUtil) {
        this.parentContexts = parentContexts;
        this.location = location;
        this.locationStrategy = locationStrategy;
        this.componentFactoryResolver = componentFactoryResolver;
        this.resolver = resolver;
        this.changeDetector = changeDetector;
        this.pageFactory = pageFactory;
        this.routeReuseStrategy = routeReuseStrategy;
        this.ngZone = ngZone;
        // tslint:disable-line:directive-class-suffix
        this.activated = null;
        this._activatedRoute = null;
        // eslint-disable-next-line @angular-eslint/no-output-rename
        this.activateEvents = new EventEmitter(); // tslint:disable-line:no-output-rename
        // eslint-disable-next-line @angular-eslint/no-output-rename
        this.deactivateEvents = new EventEmitter(); // tslint:disable-line:no-output-rename
        this.isEmptyOutlet = isEmptyOutlet;
        this.frame = elRef.nativeElement;
        this.setActionBarVisibility(actionBarVisibility);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.constructor frame: ${this.frame}`);
        }
        this.name = name || PRIMARY_OUTLET;
        parentContexts.onChildOutletCreated(this.name, this);
        this.viewUtil = viewUtil;
        this.detachedLoaderFactory = resolver.resolveComponentFactory(DetachedLoader);
    }
    /** @deprecated from Angular since v4 */
    get locationInjector() {
        return this.location.injector;
    }
    /** @deprecated from Angular since v4 */
    get locationFactoryResolver() {
        return this.resolver;
    }
    get isActivated() {
        return !!this.activated;
    }
    get component() {
        if (!this.activated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        return this.activated.instance;
    }
    get activatedRoute() {
        if (!this.activated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        return this._activatedRoute;
    }
    setActionBarVisibility(actionBarVisibility) {
        switch (actionBarVisibility) {
            case 'always':
            case 'never':
                this.frame.actionBarVisibility = actionBarVisibility;
                return;
            default:
                this.frame.actionBarVisibility = 'auto';
        }
    }
    ngOnDestroy() {
        // In the event that the `parentContexts` has changed the outlet
        // via the creation of another outlet, the `onChildOutletDestroyed`
        // will be skipped
        if (this.parentContexts.getContext(this.name)?.outlet === this) {
            // Clear accumulated modal view page cache when page-router-outlet
            // destroyed on modal view closing
            this.parentContexts.onChildOutletDestroyed(this.name);
        }
        if (this.outlet) {
            this.outlet.outletKeys.forEach((key) => {
                this.routeReuseStrategy.clearModalCache(key);
            });
            this.locationStrategy.clearOutlet(this.frame);
        }
        else {
            NativeScriptDebug.routerLog('PageRouterOutlet.ngOnDestroy: no outlet available for page-router-outlet');
        }
        if (this.isActivated) {
            const c = this.activated.instance;
            this.activated.hostView.detach();
            destroyComponentRef(this.activated);
            this.deactivateEvents.emit(c);
            this.activated = null;
        }
    }
    deactivate() {
        if (!this.outlet || !this.outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Currently not in page back navigation - component should be detached instead of deactivated.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('PageRouterOutlet.deactivate() while going back - should destroy');
        }
        if (!this.isActivated) {
            return;
        }
        const c = this.activated.instance;
        destroyComponentRef(this.activated);
        this.activated = null;
        this._activatedRoute = null;
        this.deactivateEvents.emit(c);
    }
    /**
     * Called when the `RouteReuseStrategy` instructs to detach the subtree
     */
    detach() {
        if (!this.isActivated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.detach() - ${routeToString(this._activatedRoute)}`);
        }
        // Detach from ChangeDetection
        this.activated.hostView.detach();
        const component = this.activated;
        this.activated = null;
        this._activatedRoute = null;
        return component;
    }
    /**
     * Called when the `RouteReuseStrategy` instructs to re-attach a previously detached subtree
     */
    attach(ref, activatedRoute) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.attach() - ${routeToString(activatedRoute)}`);
        }
        this.activated = ref;
        // reattach to ChangeDetection
        this.activated.hostView.markForCheck();
        this.activated.hostView.reattach();
        this._activatedRoute = activatedRoute;
        this.markActivatedRoute(activatedRoute);
        this.locationStrategy._finishBackPageNavigation(this.frame);
    }
    /**
     * Called by the Router to instantiate a new component during the commit phase of a navigation.
     * This method in turn is responsible for calling the `routerOnActivate` hook of its child.
     */
    activateWith(activatedRoute, resolver) {
        this.outlet = this.outlet || this.getOutlet(activatedRoute.snapshot);
        if (!this.outlet) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('No outlet found relative to activated route');
            }
            return;
        }
        this.outlet.isNSEmptyOutlet = this.isEmptyOutlet;
        this.locationStrategy.updateOutletFrame(this.outlet, this.frame, this.isEmptyOutlet);
        if (this.outlet && this.outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Currently in page back navigation - component should be reattached instead of activated.');
            }
            this.locationStrategy._finishBackPageNavigation(this.frame);
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.activateWith() - ${routeToString(activatedRoute)}`);
        }
        this._activatedRoute = activatedRoute;
        this.markActivatedRoute(activatedRoute);
        resolver = resolver || this.resolver;
        this.activateOnGoForward(activatedRoute, resolver);
        this.activateEvents.emit(this.activated.instance);
    }
    activateOnGoForward(activatedRoute, loadedResolver) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('PageRouterOutlet.activate() forward navigation - ' + 'create detached loader in the loader container');
        }
        const factory = this.getComponentFactory(activatedRoute, loadedResolver);
        const page = this.pageFactory({
            isNavigation: true,
            componentType: factory.componentType,
        });
        const destructables = new Set([]);
        const injector = Injector.create({
            providers: [
                { provide: Page, useValue: page },
                { provide: Frame, useValue: this.frame },
                { provide: PageRoute, useValue: new PageRoute(activatedRoute) },
                { provide: ActivatedRoute, useValue: activatedRoute },
                { provide: ChildrenOutletContexts, useValue: this.parentContexts.getOrCreateContext(this.name).children },
                { provide: PageService, useClass: PageService },
            ],
            parent: this.location.injector,
        });
        const childInjector = new DestructibleInjector(destructables, injector);
        const loaderRef = this.location.createComponent(this.detachedLoaderFactory, this.location.length, childInjector, []);
        loaderRef.onDestroy(() => childInjector.destroy());
        this.changeDetector.markForCheck();
        this.activated = loaderRef.instance.loadWithFactory(factory);
        this.activated.changeDetectorRef.detectChanges();
        this.loadComponentInPage(page, this.activated, { activatedRoute });
        this.activated[loaderRefSymbol] = loaderRef;
    }
    loadComponentInPage(page, componentRef, navigationContext) {
        // Component loaded. Find its root native view.
        const componentView = componentRef.location.nativeElement;
        // Remove it from original native parent.
        this.viewUtil.removeChild(componentView.parent, componentView);
        // Add it to the new page
        this.viewUtil.appendChild(page, componentView);
        const navigatedFromCallback = global.Zone.current.wrap((args) => {
            if (args.isBackNavigation) {
                this.locationStrategy._beginBackPageNavigation(this.frame);
                this.locationStrategy.back(null, this.frame);
            }
        });
        // TODO: experiment with using NgZone instead of global above
        // const navigatedFromCallback = (args: NavigatedData) => {
        // 	if (args.isBackNavigation) {
        //     this.ngZone.run(() => {
        //       this.locationStrategy._beginBackPageNavigation(this.frame);
        //       this.locationStrategy.back(null, this.frame);
        //     });
        // 	}
        // };
        page.on(Page.navigatedFromEvent, navigatedFromCallback);
        componentRef.onDestroy(() => {
            if (page) {
                page.off(Page.navigatedFromEvent, navigatedFromCallback);
                page = null;
            }
        });
        const navOptions = this.locationStrategy._beginPageNavigation(this.frame);
        // Clear refCache if navigation with clearHistory
        if (navOptions.clearHistory) {
            const clearCallback = () => setTimeout(() => {
                if (this.outlet) {
                    this.routeReuseStrategy.clearCache(this.outlet.outletKeys[0]);
                }
            });
            page.once(Page.navigatedToEvent, clearCallback);
        }
        this.frame.navigate({
            create() {
                return page;
            },
            context: navigationContext,
            clearHistory: navOptions.clearHistory,
            animated: navOptions.animated,
            transition: navOptions.transition,
        });
    }
    // Find and mark the top activated route as an activated one.
    // In ns-location-strategy we are reusing components only if their corresponing routes
    // are marked as activated from this method.
    markActivatedRoute(activatedRoute) {
        const queue = [];
        queue.push(activatedRoute.snapshot);
        let currentRoute = queue.shift();
        while (currentRoute) {
            currentRoute.children.forEach((childRoute) => {
                queue.push(childRoute);
            });
            const topActivatedRoute = findTopActivatedRouteNodeForOutlet(currentRoute);
            const outletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute);
            const outlet = this.locationStrategy.findOutlet(outletKey, topActivatedRoute);
            if (outlet && outlet.frames.length) {
                topActivatedRoute[pageRouterActivatedSymbol] = true;
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('Activated route marked as page: ' + routeToString(topActivatedRoute));
                }
            }
            currentRoute = queue.shift();
        }
    }
    getComponentFactory(activatedRoute, loadedResolver) {
        const { component } = activatedRoute.routeConfig;
        return loadedResolver ? loadedResolver.resolveComponentFactory(component) : this.componentFactoryResolver.resolveComponentFactory(component);
    }
    getOutlet(activatedRouteSnapshot) {
        const topActivatedRoute = findTopActivatedRouteNodeForOutlet(activatedRouteSnapshot);
        const outletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute);
        let outlet = this.locationStrategy.findOutlet(outletKey, topActivatedRoute);
        // Named lazy loaded outlet.
        if (!outlet && this.isEmptyOutlet) {
            const parentOutletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute.parent);
            outlet = this.locationStrategy.findOutlet(parentOutletKey, topActivatedRoute.parent);
            if (outlet) {
                outlet.outletKeys.push(outletKey);
            }
        }
        return outlet;
    }
}
PageRouterOutlet.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: PageRouterOutlet, deps: [{ token: i1.ChildrenOutletContexts }, { token: i0.ViewContainerRef }, { token: 'name', attribute: true }, { token: 'actionBarVisibility', attribute: true }, { token: 'isEmptyOutlet', attribute: true }, { token: i2.NSLocationStrategy }, { token: i0.ComponentFactoryResolver }, { token: i0.ComponentFactoryResolver }, { token: i0.ChangeDetectorRef }, { token: PAGE_FACTORY }, { token: i3.NSRouteReuseStrategy }, { token: i0.NgZone }, { token: i0.ElementRef }, { token: i4.ViewUtil }], target: i0.ɵɵFactoryTarget.Directive });
PageRouterOutlet.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.1", type: PageRouterOutlet, selector: "page-router-outlet", outputs: { activateEvents: "activate", deactivateEvents: "deactivate" }, ngImport: i0 });
__decorate([
    profile,
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [ActivatedRoute, ComponentFactoryResolver]),
    __metadata("design:returntype", void 0)
], PageRouterOutlet.prototype, "activateWith", null);
__decorate([
    profile,
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Page, ComponentRef, Object]),
    __metadata("design:returntype", void 0)
], PageRouterOutlet.prototype, "loadComponentInPage", null);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: PageRouterOutlet, decorators: [{
            type: Directive,
            args: [{ selector: 'page-router-outlet' }]
        }], ctorParameters: function () { return [{ type: i1.ChildrenOutletContexts }, { type: i0.ViewContainerRef }, { type: undefined, decorators: [{
                    type: Attribute,
                    args: ['name']
                }] }, { type: undefined, decorators: [{
                    type: Attribute,
                    args: ['actionBarVisibility']
                }] }, { type: undefined, decorators: [{
                    type: Attribute,
                    args: ['isEmptyOutlet']
                }] }, { type: i2.NSLocationStrategy }, { type: i0.ComponentFactoryResolver }, { type: i0.ComponentFactoryResolver }, { type: i0.ChangeDetectorRef }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PAGE_FACTORY]
                }] }, { type: i3.NSRouteReuseStrategy }, { type: i0.NgZone }, { type: i0.ElementRef }, { type: i4.ViewUtil }]; }, propDecorators: { activateEvents: [{
                type: Output,
                args: ['activate']
            }], deactivateEvents: [{
                type: Output,
                args: ['deactivate']
            }], activateWith: [], loadComponentInPage: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZS1yb3V0ZXItb3V0bGV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL2xlZ2FjeS9yb3V0ZXIvcGFnZS1yb3V0ZXItb3V0bGV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFvQix3QkFBd0IsRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBa0IsUUFBUSxFQUFhLFlBQVksRUFBRSxNQUFNLEVBQVEsZ0JBQWdCLEVBQUUsVUFBVSxFQUFlLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM5UCxPQUFPLEVBQUUsY0FBYyxFQUEwQixzQkFBc0IsRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUVqSCxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBaUIsT0FBTyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFekUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUV2QyxPQUFPLEVBQUUsWUFBWSxFQUFlLE1BQU0sY0FBYyxDQUFDO0FBQ3pELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDM0QsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTVELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSx5QkFBeUIsRUFBRSxlQUFlLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNqSixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDekQsT0FB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T0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs7NkdBcFhVLGdCQUFnQix3RkFzRGQsTUFBTSw4QkFDTixxQkFBcUIsOEJBQ3JCLGVBQWUsaUxBS2xCLFlBQVk7aUdBN0RYLGdCQUFnQjtBQW1NM0I7SUFEQyxPQUFPOztxQ0FDcUIsY0FBYyxFQUFZLHdCQUF3Qjs7b0RBK0I5RTtBQXVDRDtJQURDLE9BQU87O3FDQUMwQixJQUFJLEVBQWdCLFlBQVk7OzJEQXVEakU7MkZBaFVVLGdCQUFnQjtrQkFGNUIsU0FBUzttQkFBQyxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRTs7MEJBd0R4QyxTQUFTOzJCQUFDLE1BQU07OzBCQUNoQixTQUFTOzJCQUFDLHFCQUFxQjs7MEJBQy9CLFNBQVM7MkJBQUMsZUFBZTs7MEJBS3pCLE1BQU07MkJBQUMsWUFBWTtvSkFoREYsY0FBYztzQkFBakMsTUFBTTt1QkFBQyxVQUFVO2dCQUVJLGdCQUFnQjtzQkFBckMsTUFBTTt1QkFBQyxZQUFZO2dCQW9McEIsWUFBWSxNQXNFSixtQkFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBdHRyaWJ1dGUsIENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnRGYWN0b3J5LCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgRGlyZWN0aXZlLCBJbmplY3QsIEluamVjdGlvblRva2VuLCBJbmplY3RvciwgT25EZXN0cm95LCBFdmVudEVtaXR0ZXIsIE91dHB1dCwgVHlwZSwgVmlld0NvbnRhaW5lclJlZiwgRWxlbWVudFJlZiwgSW5qZWN0RmxhZ3MsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUsIEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIENoaWxkcmVuT3V0bGV0Q29udGV4dHMsIFBSSU1BUllfT1VUTEVUIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgRnJhbWUsIFBhZ2UsIE5hdmlnYXRlZERhdGEsIHByb2ZpbGUgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgUEFHRV9GQUNUT1JZLCBQYWdlRmFjdG9yeSB9IGZyb20gJy4uLy4uL3Rva2Vucyc7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4uLy4uL3RyYWNlJztcbmltcG9ydCB7IERldGFjaGVkTG9hZGVyIH0gZnJvbSAnLi4vLi4vY2RrL2RldGFjaGVkLWxvYWRlcic7XG5pbXBvcnQgeyBWaWV3VXRpbCB9IGZyb20gJy4uLy4uL3ZpZXctdXRpbCc7XG5pbXBvcnQgeyBOU0xvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICcuL25zLWxvY2F0aW9uLXN0cmF0ZWd5JztcbmltcG9ydCB7IE91dGxldCB9IGZyb20gJy4vbnMtbG9jYXRpb24tdXRpbHMnO1xuaW1wb3J0IHsgTlNSb3V0ZVJldXNlU3RyYXRlZ3kgfSBmcm9tICcuL25zLXJvdXRlLXJldXNlLXN0cmF0ZWd5JztcbmltcG9ydCB7IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQsIHBhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2wsIGxvYWRlclJlZlN5bWJvbCwgZGVzdHJveUNvbXBvbmVudFJlZiB9IGZyb20gJy4vcGFnZS1yb3V0ZXItb3V0bGV0LXV0aWxzJztcbmltcG9ydCB7IHJlZ2lzdGVyRWxlbWVudCB9IGZyb20gJy4uLy4uL2VsZW1lbnQtcmVnaXN0cnknO1xuaW1wb3J0IHsgUGFnZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9jZGsvZnJhbWUtcGFnZS9wYWdlLnNlcnZpY2UnO1xuXG5leHBvcnQgY2xhc3MgUGFnZVJvdXRlIHtcbiAgYWN0aXZhdGVkUm91dGU6IEJlaGF2aW9yU3ViamVjdDxBY3RpdmF0ZWRSb3V0ZT47XG5cbiAgY29uc3RydWN0b3Ioc3RhcnRSb3V0ZTogQWN0aXZhdGVkUm91dGUpIHtcbiAgICB0aGlzLmFjdGl2YXRlZFJvdXRlID0gbmV3IEJlaGF2aW9yU3ViamVjdChzdGFydFJvdXRlKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgRGVzdHJ1Y3RpYmxlSW5qZWN0b3IgaW1wbGVtZW50cyBJbmplY3RvciB7XG4gIHByaXZhdGUgcmVmcyA9IG5ldyBTZXQ8YW55PigpO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRlc3RydWN0YWJsZVByb3ZpZGVyczogUHJvdmlkZXJTZXQsIHByaXZhdGUgcGFyZW50OiBJbmplY3Rvcikge31cbiAgZ2V0PFQ+KHRva2VuOiBUeXBlPFQ+IHwgSW5qZWN0aW9uVG9rZW48VD4sIG5vdEZvdW5kVmFsdWU/OiBULCBmbGFncz86IEluamVjdEZsYWdzKTogVCB7XG4gICAgY29uc3QgcmVmID0gdGhpcy5wYXJlbnQuZ2V0KHRva2VuLCBub3RGb3VuZFZhbHVlLCBmbGFncyk7XG4gICAgaWYgKHRoaXMuZGVzdHJ1Y3RhYmxlUHJvdmlkZXJzLmhhcyh0b2tlbikpIHtcbiAgICAgIHRoaXMucmVmcy5hZGQocmVmKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlZjtcbiAgfVxuICBkZXN0cm95KCkge1xuICAgIHRoaXMucmVmcy5mb3JFYWNoKChyZWYpID0+IHtcbiAgICAgIGlmIChyZWYubmdPbkRlc3Ryb3kgaW5zdGFuY2VvZiBGdW5jdGlvbikge1xuICAgICAgICByZWYubmdPbkRlc3Ryb3koKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLnJlZnMuY2xlYXIoKTtcbiAgfVxufVxuXG50eXBlIFByb3ZpZGVyU2V0ID0gU2V0PFR5cGU8YW55PiB8IEluamVjdGlvblRva2VuPGFueT4+O1xuXG5jb25zdCByb3V0ZVRvU3RyaW5nID0gZnVuY3Rpb24gKGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSB8IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBzdHJpbmcge1xuICByZXR1cm4gYWN0aXZhdGVkUm91dGUucGF0aEZyb21Sb290LmpvaW4oJy0+Jyk7XG59O1xuXG5yZWdpc3RlckVsZW1lbnQoJ3BhZ2Utcm91dGVyLW91dGxldCcsICgpID0+IEZyYW1lKTtcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvZGlyZWN0aXZlLXNlbGVjdG9yXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdwYWdlLXJvdXRlci1vdXRsZXQnIH0pIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6ZGlyZWN0aXZlLXNlbGVjdG9yXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L2RpcmVjdGl2ZS1jbGFzcy1zdWZmaXhcbmV4cG9ydCBjbGFzcyBQYWdlUm91dGVyT3V0bGV0IGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbGluZTpkaXJlY3RpdmUtY2xhc3Mtc3VmZml4XG4gIHByaXZhdGUgYWN0aXZhdGVkOiBDb21wb25lbnRSZWY8YW55PiB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIF9hY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBkZXRhY2hlZExvYWRlckZhY3Rvcnk6IENvbXBvbmVudEZhY3Rvcnk8RGV0YWNoZWRMb2FkZXI+O1xuXG4gIHByaXZhdGUgb3V0bGV0OiBPdXRsZXQ7XG4gIHByaXZhdGUgbmFtZTogc3RyaW5nO1xuICBwcml2YXRlIGlzRW1wdHlPdXRsZXQ6IGJvb2xlYW47XG4gIHByaXZhdGUgdmlld1V0aWw6IFZpZXdVdGlsO1xuICBwcml2YXRlIGZyYW1lOiBGcmFtZTtcblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L25vLW91dHB1dC1yZW5hbWVcbiAgQE91dHB1dCgnYWN0aXZhdGUnKSBhY3RpdmF0ZUV2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpOyAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLW91dHB1dC1yZW5hbWVcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1vdXRwdXQtcmVuYW1lXG4gIEBPdXRwdXQoJ2RlYWN0aXZhdGUnKSBkZWFjdGl2YXRlRXZlbnRzID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7IC8vIHRzbGludDpkaXNhYmxlLWxpbmU6bm8tb3V0cHV0LXJlbmFtZVxuXG4gIC8qKiBAZGVwcmVjYXRlZCBmcm9tIEFuZ3VsYXIgc2luY2UgdjQgKi9cbiAgZ2V0IGxvY2F0aW9uSW5qZWN0b3IoKTogSW5qZWN0b3Ige1xuICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmluamVjdG9yO1xuICB9XG4gIC8qKiBAZGVwcmVjYXRlZCBmcm9tIEFuZ3VsYXIgc2luY2UgdjQgKi9cbiAgZ2V0IGxvY2F0aW9uRmFjdG9yeVJlc29sdmVyKCk6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciB7XG4gICAgcmV0dXJuIHRoaXMucmVzb2x2ZXI7XG4gIH1cblxuICBnZXQgaXNBY3RpdmF0ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhdGhpcy5hY3RpdmF0ZWQ7XG4gIH1cblxuICBnZXQgY29tcG9uZW50KCk6IHVua25vd24ge1xuICAgIGlmICghdGhpcy5hY3RpdmF0ZWQpIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ091dGxldCBpcyBub3QgYWN0aXZhdGVkJyk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuYWN0aXZhdGVkLmluc3RhbmNlO1xuICB9XG4gIGdldCBhY3RpdmF0ZWRSb3V0ZSgpOiBBY3RpdmF0ZWRSb3V0ZSB7XG4gICAgaWYgKCF0aGlzLmFjdGl2YXRlZCkge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnT3V0bGV0IGlzIG5vdCBhY3RpdmF0ZWQnKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fYWN0aXZhdGVkUm91dGU7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHBhcmVudENvbnRleHRzOiBDaGlsZHJlbk91dGxldENvbnRleHRzLFxuICAgIHByaXZhdGUgbG9jYXRpb246IFZpZXdDb250YWluZXJSZWYsXG4gICAgQEF0dHJpYnV0ZSgnbmFtZScpIG5hbWU6IHN0cmluZyxcbiAgICBAQXR0cmlidXRlKCdhY3Rpb25CYXJWaXNpYmlsaXR5JykgYWN0aW9uQmFyVmlzaWJpbGl0eTogc3RyaW5nLFxuICAgIEBBdHRyaWJ1dGUoJ2lzRW1wdHlPdXRsZXQnKSBpc0VtcHR5T3V0bGV0OiBib29sZWFuLFxuICAgIHByaXZhdGUgbG9jYXRpb25TdHJhdGVneTogTlNMb2NhdGlvblN0cmF0ZWd5LFxuICAgIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIEBJbmplY3QoUEFHRV9GQUNUT1JZKSBwcml2YXRlIHBhZ2VGYWN0b3J5OiBQYWdlRmFjdG9yeSxcbiAgICBwcml2YXRlIHJvdXRlUmV1c2VTdHJhdGVneTogTlNSb3V0ZVJldXNlU3RyYXRlZ3ksXG4gICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSxcbiAgICBlbFJlZjogRWxlbWVudFJlZixcbiAgICB2aWV3VXRpbDogVmlld1V0aWxcbiAgKSB7XG4gICAgdGhpcy5pc0VtcHR5T3V0bGV0ID0gaXNFbXB0eU91dGxldDtcbiAgICB0aGlzLmZyYW1lID0gZWxSZWYubmF0aXZlRWxlbWVudDtcbiAgICB0aGlzLnNldEFjdGlvbkJhclZpc2liaWxpdHkoYWN0aW9uQmFyVmlzaWJpbGl0eSk7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coYFBhZ2VSb3V0ZXJPdXRsZXQuY29uc3RydWN0b3IgZnJhbWU6ICR7dGhpcy5mcmFtZX1gKTtcbiAgICB9XG5cbiAgICB0aGlzLm5hbWUgPSBuYW1lIHx8IFBSSU1BUllfT1VUTEVUO1xuICAgIHBhcmVudENvbnRleHRzLm9uQ2hpbGRPdXRsZXRDcmVhdGVkKHRoaXMubmFtZSwgPGFueT50aGlzKTtcblxuICAgIHRoaXMudmlld1V0aWwgPSB2aWV3VXRpbDtcbiAgICB0aGlzLmRldGFjaGVkTG9hZGVyRmFjdG9yeSA9IHJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KERldGFjaGVkTG9hZGVyKTtcbiAgfVxuXG4gIHNldEFjdGlvbkJhclZpc2liaWxpdHkoYWN0aW9uQmFyVmlzaWJpbGl0eTogc3RyaW5nKTogdm9pZCB7XG4gICAgc3dpdGNoIChhY3Rpb25CYXJWaXNpYmlsaXR5KSB7XG4gICAgICBjYXNlICdhbHdheXMnOlxuICAgICAgY2FzZSAnbmV2ZXInOlxuICAgICAgICB0aGlzLmZyYW1lLmFjdGlvbkJhclZpc2liaWxpdHkgPSBhY3Rpb25CYXJWaXNpYmlsaXR5O1xuICAgICAgICByZXR1cm47XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMuZnJhbWUuYWN0aW9uQmFyVmlzaWJpbGl0eSA9ICdhdXRvJztcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAvLyBJbiB0aGUgZXZlbnQgdGhhdCB0aGUgYHBhcmVudENvbnRleHRzYCBoYXMgY2hhbmdlZCB0aGUgb3V0bGV0XG4gICAgLy8gdmlhIHRoZSBjcmVhdGlvbiBvZiBhbm90aGVyIG91dGxldCwgdGhlIGBvbkNoaWxkT3V0bGV0RGVzdHJveWVkYFxuICAgIC8vIHdpbGwgYmUgc2tpcHBlZFxuICAgIGlmICh0aGlzLnBhcmVudENvbnRleHRzLmdldENvbnRleHQodGhpcy5uYW1lKT8ub3V0bGV0ID09PSA8YW55PnRoaXMpIHtcbiAgICAgIC8vIENsZWFyIGFjY3VtdWxhdGVkIG1vZGFsIHZpZXcgcGFnZSBjYWNoZSB3aGVuIHBhZ2Utcm91dGVyLW91dGxldFxuICAgICAgLy8gZGVzdHJveWVkIG9uIG1vZGFsIHZpZXcgY2xvc2luZ1xuICAgICAgdGhpcy5wYXJlbnRDb250ZXh0cy5vbkNoaWxkT3V0bGV0RGVzdHJveWVkKHRoaXMubmFtZSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3V0bGV0KSB7XG4gICAgICB0aGlzLm91dGxldC5vdXRsZXRLZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICB0aGlzLnJvdXRlUmV1c2VTdHJhdGVneS5jbGVhck1vZGFsQ2FjaGUoa2V5KTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmNsZWFyT3V0bGV0KHRoaXMuZnJhbWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ1BhZ2VSb3V0ZXJPdXRsZXQubmdPbkRlc3Ryb3k6IG5vIG91dGxldCBhdmFpbGFibGUgZm9yIHBhZ2Utcm91dGVyLW91dGxldCcpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzQWN0aXZhdGVkKSB7XG4gICAgICBjb25zdCBjID0gdGhpcy5hY3RpdmF0ZWQuaW5zdGFuY2U7XG4gICAgICB0aGlzLmFjdGl2YXRlZC5ob3N0Vmlldy5kZXRhY2goKTtcbiAgICAgIGRlc3Ryb3lDb21wb25lbnRSZWYodGhpcy5hY3RpdmF0ZWQpO1xuXG4gICAgICB0aGlzLmRlYWN0aXZhdGVFdmVudHMuZW1pdChjKTtcbiAgICAgIHRoaXMuYWN0aXZhdGVkID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBkZWFjdGl2YXRlKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5vdXRsZXQgfHwgIXRoaXMub3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrKSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdDdXJyZW50bHkgbm90IGluIHBhZ2UgYmFjayBuYXZpZ2F0aW9uIC0gY29tcG9uZW50IHNob3VsZCBiZSBkZXRhY2hlZCBpbnN0ZWFkIG9mIGRlYWN0aXZhdGVkLicpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdQYWdlUm91dGVyT3V0bGV0LmRlYWN0aXZhdGUoKSB3aGlsZSBnb2luZyBiYWNrIC0gc2hvdWxkIGRlc3Ryb3knKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaXNBY3RpdmF0ZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBjID0gdGhpcy5hY3RpdmF0ZWQuaW5zdGFuY2U7XG4gICAgZGVzdHJveUNvbXBvbmVudFJlZih0aGlzLmFjdGl2YXRlZCk7XG5cbiAgICB0aGlzLmFjdGl2YXRlZCA9IG51bGw7XG4gICAgdGhpcy5fYWN0aXZhdGVkUm91dGUgPSBudWxsO1xuXG4gICAgdGhpcy5kZWFjdGl2YXRlRXZlbnRzLmVtaXQoYyk7XG4gIH1cblxuICAvKipcbiAgICogQ2FsbGVkIHdoZW4gdGhlIGBSb3V0ZVJldXNlU3RyYXRlZ3lgIGluc3RydWN0cyB0byBkZXRhY2ggdGhlIHN1YnRyZWVcbiAgICovXG4gIGRldGFjaCgpOiBDb21wb25lbnRSZWY8YW55PiB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZhdGVkKSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdPdXRsZXQgaXMgbm90IGFjdGl2YXRlZCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmRldGFjaCgpIC0gJHtyb3V0ZVRvU3RyaW5nKHRoaXMuX2FjdGl2YXRlZFJvdXRlKX1gKTtcbiAgICB9XG5cbiAgICAvLyBEZXRhY2ggZnJvbSBDaGFuZ2VEZXRlY3Rpb25cbiAgICB0aGlzLmFjdGl2YXRlZC5ob3N0Vmlldy5kZXRhY2goKTtcblxuICAgIGNvbnN0IGNvbXBvbmVudCA9IHRoaXMuYWN0aXZhdGVkO1xuICAgIHRoaXMuYWN0aXZhdGVkID0gbnVsbDtcbiAgICB0aGlzLl9hY3RpdmF0ZWRSb3V0ZSA9IG51bGw7XG4gICAgcmV0dXJuIGNvbXBvbmVudDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxsZWQgd2hlbiB0aGUgYFJvdXRlUmV1c2VTdHJhdGVneWAgaW5zdHJ1Y3RzIHRvIHJlLWF0dGFjaCBhIHByZXZpb3VzbHkgZGV0YWNoZWQgc3VidHJlZVxuICAgKi9cbiAgYXR0YWNoKHJlZjogQ29tcG9uZW50UmVmPGFueT4sIGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSkge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmF0dGFjaCgpIC0gJHtyb3V0ZVRvU3RyaW5nKGFjdGl2YXRlZFJvdXRlKX1gKTtcbiAgICB9XG5cbiAgICB0aGlzLmFjdGl2YXRlZCA9IHJlZjtcblxuICAgIC8vIHJlYXR0YWNoIHRvIENoYW5nZURldGVjdGlvblxuICAgIHRoaXMuYWN0aXZhdGVkLmhvc3RWaWV3Lm1hcmtGb3JDaGVjaygpO1xuICAgIHRoaXMuYWN0aXZhdGVkLmhvc3RWaWV3LnJlYXR0YWNoKCk7XG4gICAgdGhpcy5fYWN0aXZhdGVkUm91dGUgPSBhY3RpdmF0ZWRSb3V0ZTtcbiAgICB0aGlzLm1hcmtBY3RpdmF0ZWRSb3V0ZShhY3RpdmF0ZWRSb3V0ZSk7XG5cbiAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuX2ZpbmlzaEJhY2tQYWdlTmF2aWdhdGlvbih0aGlzLmZyYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxsZWQgYnkgdGhlIFJvdXRlciB0byBpbnN0YW50aWF0ZSBhIG5ldyBjb21wb25lbnQgZHVyaW5nIHRoZSBjb21taXQgcGhhc2Ugb2YgYSBuYXZpZ2F0aW9uLlxuICAgKiBUaGlzIG1ldGhvZCBpbiB0dXJuIGlzIHJlc3BvbnNpYmxlIGZvciBjYWxsaW5nIHRoZSBgcm91dGVyT25BY3RpdmF0ZWAgaG9vayBvZiBpdHMgY2hpbGQuXG4gICAqL1xuICBAcHJvZmlsZVxuICBhY3RpdmF0ZVdpdGgoYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlLCByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyIHwgbnVsbCk6IHZvaWQge1xuICAgIHRoaXMub3V0bGV0ID0gdGhpcy5vdXRsZXQgfHwgdGhpcy5nZXRPdXRsZXQoYWN0aXZhdGVkUm91dGUuc25hcHNob3QpO1xuICAgIGlmICghdGhpcy5vdXRsZXQpIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJFcnJvcignTm8gb3V0bGV0IGZvdW5kIHJlbGF0aXZlIHRvIGFjdGl2YXRlZCByb3V0ZScpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMub3V0bGV0LmlzTlNFbXB0eU91dGxldCA9IHRoaXMuaXNFbXB0eU91dGxldDtcbiAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kudXBkYXRlT3V0bGV0RnJhbWUodGhpcy5vdXRsZXQsIHRoaXMuZnJhbWUsIHRoaXMuaXNFbXB0eU91dGxldCk7XG5cbiAgICBpZiAodGhpcy5vdXRsZXQgJiYgdGhpcy5vdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2spIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ0N1cnJlbnRseSBpbiBwYWdlIGJhY2sgbmF2aWdhdGlvbiAtIGNvbXBvbmVudCBzaG91bGQgYmUgcmVhdHRhY2hlZCBpbnN0ZWFkIG9mIGFjdGl2YXRlZC4nKTtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9jYXRpb25TdHJhdGVneS5fZmluaXNoQmFja1BhZ2VOYXZpZ2F0aW9uKHRoaXMuZnJhbWUpO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmFjdGl2YXRlV2l0aCgpIC0gJHtyb3V0ZVRvU3RyaW5nKGFjdGl2YXRlZFJvdXRlKX1gKTtcbiAgICB9XG5cbiAgICB0aGlzLl9hY3RpdmF0ZWRSb3V0ZSA9IGFjdGl2YXRlZFJvdXRlO1xuXG4gICAgdGhpcy5tYXJrQWN0aXZhdGVkUm91dGUoYWN0aXZhdGVkUm91dGUpO1xuXG4gICAgcmVzb2x2ZXIgPSByZXNvbHZlciB8fCB0aGlzLnJlc29sdmVyO1xuXG4gICAgdGhpcy5hY3RpdmF0ZU9uR29Gb3J3YXJkKGFjdGl2YXRlZFJvdXRlLCByZXNvbHZlcik7XG4gICAgdGhpcy5hY3RpdmF0ZUV2ZW50cy5lbWl0KHRoaXMuYWN0aXZhdGVkLmluc3RhbmNlKTtcbiAgfVxuXG4gIHByaXZhdGUgYWN0aXZhdGVPbkdvRm9yd2FyZChhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsIGxvYWRlZFJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnUGFnZVJvdXRlck91dGxldC5hY3RpdmF0ZSgpIGZvcndhcmQgbmF2aWdhdGlvbiAtICcgKyAnY3JlYXRlIGRldGFjaGVkIGxvYWRlciBpbiB0aGUgbG9hZGVyIGNvbnRhaW5lcicpO1xuICAgIH1cblxuICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLmdldENvbXBvbmVudEZhY3RvcnkoYWN0aXZhdGVkUm91dGUsIGxvYWRlZFJlc29sdmVyKTtcbiAgICBjb25zdCBwYWdlID0gdGhpcy5wYWdlRmFjdG9yeSh7XG4gICAgICBpc05hdmlnYXRpb246IHRydWUsXG4gICAgICBjb21wb25lbnRUeXBlOiBmYWN0b3J5LmNvbXBvbmVudFR5cGUsXG4gICAgfSk7XG5cbiAgICBjb25zdCBkZXN0cnVjdGFibGVzID0gbmV3IFNldChbXSk7XG4gICAgY29uc3QgaW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHsgcHJvdmlkZTogUGFnZSwgdXNlVmFsdWU6IHBhZ2UgfSxcbiAgICAgICAgeyBwcm92aWRlOiBGcmFtZSwgdXNlVmFsdWU6IHRoaXMuZnJhbWUgfSxcbiAgICAgICAgeyBwcm92aWRlOiBQYWdlUm91dGUsIHVzZVZhbHVlOiBuZXcgUGFnZVJvdXRlKGFjdGl2YXRlZFJvdXRlKSB9LFxuICAgICAgICB7IHByb3ZpZGU6IEFjdGl2YXRlZFJvdXRlLCB1c2VWYWx1ZTogYWN0aXZhdGVkUm91dGUgfSxcbiAgICAgICAgeyBwcm92aWRlOiBDaGlsZHJlbk91dGxldENvbnRleHRzLCB1c2VWYWx1ZTogdGhpcy5wYXJlbnRDb250ZXh0cy5nZXRPckNyZWF0ZUNvbnRleHQodGhpcy5uYW1lKS5jaGlsZHJlbiB9LFxuICAgICAgICB7IHByb3ZpZGU6IFBhZ2VTZXJ2aWNlLCB1c2VDbGFzczogUGFnZVNlcnZpY2UgfSxcbiAgICAgIF0sXG4gICAgICBwYXJlbnQ6IHRoaXMubG9jYXRpb24uaW5qZWN0b3IsXG4gICAgfSk7XG5cbiAgICBjb25zdCBjaGlsZEluamVjdG9yID0gbmV3IERlc3RydWN0aWJsZUluamVjdG9yKGRlc3RydWN0YWJsZXMsIGluamVjdG9yKTtcbiAgICBjb25zdCBsb2FkZXJSZWYgPSB0aGlzLmxvY2F0aW9uLmNyZWF0ZUNvbXBvbmVudCh0aGlzLmRldGFjaGVkTG9hZGVyRmFjdG9yeSwgdGhpcy5sb2NhdGlvbi5sZW5ndGgsIGNoaWxkSW5qZWN0b3IsIFtdKTtcbiAgICBsb2FkZXJSZWYub25EZXN0cm95KCgpID0+IGNoaWxkSW5qZWN0b3IuZGVzdHJveSgpKTtcbiAgICB0aGlzLmNoYW5nZURldGVjdG9yLm1hcmtGb3JDaGVjaygpO1xuXG4gICAgdGhpcy5hY3RpdmF0ZWQgPSBsb2FkZXJSZWYuaW5zdGFuY2UubG9hZFdpdGhGYWN0b3J5KGZhY3RvcnkpO1xuICAgIHRoaXMuYWN0aXZhdGVkLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICB0aGlzLmxvYWRDb21wb25lbnRJblBhZ2UocGFnZSwgdGhpcy5hY3RpdmF0ZWQsIHsgYWN0aXZhdGVkUm91dGUgfSk7XG5cbiAgICB0aGlzLmFjdGl2YXRlZFtsb2FkZXJSZWZTeW1ib2xdID0gbG9hZGVyUmVmO1xuICB9XG5cbiAgQHByb2ZpbGVcbiAgcHJpdmF0ZSBsb2FkQ29tcG9uZW50SW5QYWdlKHBhZ2U6IFBhZ2UsIGNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPGFueT4sIG5hdmlnYXRpb25Db250ZXh0KTogdm9pZCB7XG4gICAgLy8gQ29tcG9uZW50IGxvYWRlZC4gRmluZCBpdHMgcm9vdCBuYXRpdmUgdmlldy5cbiAgICBjb25zdCBjb21wb25lbnRWaWV3ID0gY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQ7XG4gICAgLy8gUmVtb3ZlIGl0IGZyb20gb3JpZ2luYWwgbmF0aXZlIHBhcmVudC5cbiAgICB0aGlzLnZpZXdVdGlsLnJlbW92ZUNoaWxkKGNvbXBvbmVudFZpZXcucGFyZW50LCBjb21wb25lbnRWaWV3KTtcbiAgICAvLyBBZGQgaXQgdG8gdGhlIG5ldyBwYWdlXG4gICAgdGhpcy52aWV3VXRpbC5hcHBlbmRDaGlsZChwYWdlLCBjb21wb25lbnRWaWV3KTtcblxuICAgIGNvbnN0IG5hdmlnYXRlZEZyb21DYWxsYmFjayA9ICg8YW55Pmdsb2JhbCkuWm9uZS5jdXJyZW50LndyYXAoKGFyZ3M6IE5hdmlnYXRlZERhdGEpID0+IHtcbiAgICAgIGlmIChhcmdzLmlzQmFja05hdmlnYXRpb24pIHtcbiAgICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9iZWdpbkJhY2tQYWdlTmF2aWdhdGlvbih0aGlzLmZyYW1lKTtcbiAgICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmJhY2sobnVsbCwgdGhpcy5mcmFtZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gVE9ETzogZXhwZXJpbWVudCB3aXRoIHVzaW5nIE5nWm9uZSBpbnN0ZWFkIG9mIGdsb2JhbCBhYm92ZVxuICAgIC8vIGNvbnN0IG5hdmlnYXRlZEZyb21DYWxsYmFjayA9IChhcmdzOiBOYXZpZ2F0ZWREYXRhKSA9PiB7XG4gICAgLy8gXHRpZiAoYXJncy5pc0JhY2tOYXZpZ2F0aW9uKSB7XG4gICAgLy8gICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgLy8gICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9iZWdpbkJhY2tQYWdlTmF2aWdhdGlvbih0aGlzLmZyYW1lKTtcbiAgICAvLyAgICAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuYmFjayhudWxsLCB0aGlzLmZyYW1lKTtcbiAgICAvLyAgICAgfSk7XG4gICAgLy8gXHR9XG4gICAgLy8gfTtcblxuICAgIHBhZ2Uub24oUGFnZS5uYXZpZ2F0ZWRGcm9tRXZlbnQsIG5hdmlnYXRlZEZyb21DYWxsYmFjayk7XG4gICAgY29tcG9uZW50UmVmLm9uRGVzdHJveSgoKSA9PiB7XG4gICAgICBpZiAocGFnZSkge1xuICAgICAgICBwYWdlLm9mZihQYWdlLm5hdmlnYXRlZEZyb21FdmVudCwgbmF2aWdhdGVkRnJvbUNhbGxiYWNrKTtcbiAgICAgICAgcGFnZSA9IG51bGw7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBuYXZPcHRpb25zID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9iZWdpblBhZ2VOYXZpZ2F0aW9uKHRoaXMuZnJhbWUpO1xuXG4gICAgLy8gQ2xlYXIgcmVmQ2FjaGUgaWYgbmF2aWdhdGlvbiB3aXRoIGNsZWFySGlzdG9yeVxuICAgIGlmIChuYXZPcHRpb25zLmNsZWFySGlzdG9yeSkge1xuICAgICAgY29uc3QgY2xlYXJDYWxsYmFjayA9ICgpID0+XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLm91dGxldCkge1xuICAgICAgICAgICAgdGhpcy5yb3V0ZVJldXNlU3RyYXRlZ3kuY2xlYXJDYWNoZSh0aGlzLm91dGxldC5vdXRsZXRLZXlzWzBdKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICBwYWdlLm9uY2UoUGFnZS5uYXZpZ2F0ZWRUb0V2ZW50LCBjbGVhckNhbGxiYWNrKTtcbiAgICB9XG5cbiAgICB0aGlzLmZyYW1lLm5hdmlnYXRlKHtcbiAgICAgIGNyZWF0ZSgpIHtcbiAgICAgICAgcmV0dXJuIHBhZ2U7XG4gICAgICB9LFxuICAgICAgY29udGV4dDogbmF2aWdhdGlvbkNvbnRleHQsXG4gICAgICBjbGVhckhpc3Rvcnk6IG5hdk9wdGlvbnMuY2xlYXJIaXN0b3J5LFxuICAgICAgYW5pbWF0ZWQ6IG5hdk9wdGlvbnMuYW5pbWF0ZWQsXG4gICAgICB0cmFuc2l0aW9uOiBuYXZPcHRpb25zLnRyYW5zaXRpb24sXG4gICAgfSk7XG4gIH1cblxuICAvLyBGaW5kIGFuZCBtYXJrIHRoZSB0b3AgYWN0aXZhdGVkIHJvdXRlIGFzIGFuIGFjdGl2YXRlZCBvbmUuXG4gIC8vIEluIG5zLWxvY2F0aW9uLXN0cmF0ZWd5IHdlIGFyZSByZXVzaW5nIGNvbXBvbmVudHMgb25seSBpZiB0aGVpciBjb3JyZXNwb25pbmcgcm91dGVzXG4gIC8vIGFyZSBtYXJrZWQgYXMgYWN0aXZhdGVkIGZyb20gdGhpcyBtZXRob2QuXG4gIHByaXZhdGUgbWFya0FjdGl2YXRlZFJvdXRlKGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSkge1xuICAgIGNvbnN0IHF1ZXVlID0gW107XG4gICAgcXVldWUucHVzaChhY3RpdmF0ZWRSb3V0ZS5zbmFwc2hvdCk7XG4gICAgbGV0IGN1cnJlbnRSb3V0ZSA9IHF1ZXVlLnNoaWZ0KCk7XG5cbiAgICB3aGlsZSAoY3VycmVudFJvdXRlKSB7XG4gICAgICBjdXJyZW50Um91dGUuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGRSb3V0ZSkgPT4ge1xuICAgICAgICBxdWV1ZS5wdXNoKGNoaWxkUm91dGUpO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHRvcEFjdGl2YXRlZFJvdXRlID0gZmluZFRvcEFjdGl2YXRlZFJvdXRlTm9kZUZvck91dGxldChjdXJyZW50Um91dGUpO1xuICAgICAgY29uc3Qgb3V0bGV0S2V5ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmdldFJvdXRlRnVsbFBhdGgodG9wQWN0aXZhdGVkUm91dGUpO1xuICAgICAgY29uc3Qgb3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQob3V0bGV0S2V5LCB0b3BBY3RpdmF0ZWRSb3V0ZSk7XG5cbiAgICAgIGlmIChvdXRsZXQgJiYgb3V0bGV0LmZyYW1lcy5sZW5ndGgpIHtcbiAgICAgICAgdG9wQWN0aXZhdGVkUm91dGVbcGFnZVJvdXRlckFjdGl2YXRlZFN5bWJvbF0gPSB0cnVlO1xuICAgICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ0FjdGl2YXRlZCByb3V0ZSBtYXJrZWQgYXMgcGFnZTogJyArIHJvdXRlVG9TdHJpbmcodG9wQWN0aXZhdGVkUm91dGUpKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjdXJyZW50Um91dGUgPSBxdWV1ZS5zaGlmdCgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29tcG9uZW50RmFjdG9yeShhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsIGxvYWRlZFJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpOiBDb21wb25lbnRGYWN0b3J5PGFueT4ge1xuICAgIGNvbnN0IHsgY29tcG9uZW50IH0gPSBhY3RpdmF0ZWRSb3V0ZS5yb3V0ZUNvbmZpZztcblxuICAgIHJldHVybiBsb2FkZWRSZXNvbHZlciA/IGxvYWRlZFJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudCkgOiB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShjb21wb25lbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRPdXRsZXQoYWN0aXZhdGVkUm91dGVTbmFwc2hvdDogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IE91dGxldCB7XG4gICAgY29uc3QgdG9wQWN0aXZhdGVkUm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KGFjdGl2YXRlZFJvdXRlU25hcHNob3QpO1xuICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5nZXRSb3V0ZUZ1bGxQYXRoKHRvcEFjdGl2YXRlZFJvdXRlKTtcbiAgICBsZXQgb3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQob3V0bGV0S2V5LCB0b3BBY3RpdmF0ZWRSb3V0ZSk7XG5cbiAgICAvLyBOYW1lZCBsYXp5IGxvYWRlZCBvdXRsZXQuXG4gICAgaWYgKCFvdXRsZXQgJiYgdGhpcy5pc0VtcHR5T3V0bGV0KSB7XG4gICAgICBjb25zdCBwYXJlbnRPdXRsZXRLZXkgPSB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuZ2V0Um91dGVGdWxsUGF0aCh0b3BBY3RpdmF0ZWRSb3V0ZS5wYXJlbnQpO1xuICAgICAgb3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQocGFyZW50T3V0bGV0S2V5LCB0b3BBY3RpdmF0ZWRSb3V0ZS5wYXJlbnQpO1xuXG4gICAgICBpZiAob3V0bGV0KSB7XG4gICAgICAgIG91dGxldC5vdXRsZXRLZXlzLnB1c2gob3V0bGV0S2V5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gb3V0bGV0O1xuICB9XG59XG4iXX0=