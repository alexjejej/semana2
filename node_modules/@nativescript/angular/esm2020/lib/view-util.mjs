import { unsetValue } from '@nativescript/core';
import { getViewClass, getViewMeta, isKnownView } from './element-registry';
import { CommentNode, TextNode, isDetachedElement, isInvisibleNode, isView, isContentView, isLayout } from './views';
import { NativeScriptDebug } from './trace';
const ELEMENT_NODE_TYPE = 1;
const XML_ATTRIBUTES = Object.freeze(['style', 'rows', 'columns', 'fontAttributes']);
const whiteSpaceSplitter = /\s+/;
function printNgTree(view) {
    let parent = view;
    while (parent.parent && parent.parent.firstChild) {
        parent = parent.parent;
    }
    printChildrenRecurse(parent);
}
function printChildrenRecurse(parent) {
    const children = parent.firstChild ? [parent.firstChild, ...getChildrenSiblings(parent.firstChild).nextSiblings] : [];
    console.log(`parent: ${parent}, firstChild: ${parent.firstChild}, lastChild: ${parent.lastChild} children: ${children}`);
    if (parent.firstChild) {
        console.log(`----- start ${parent}`);
    }
    children.forEach((c) => printChildrenRecurse(c));
    if (parent.firstChild) {
        console.log(`----- end ${parent}`);
    }
}
function getChildrenSiblings(view) {
    const nextSiblings = [];
    const previousSiblings = [];
    let sibling = view.nextSibling;
    while (sibling) {
        nextSiblings.push(sibling);
        sibling = sibling.nextSibling;
    }
    sibling = view.previousSibling;
    while (sibling) {
        previousSiblings.push(sibling);
        sibling = sibling.previousSibling;
    }
    return {
        previousSiblings,
        nextSiblings,
    };
}
function printSiblingsTree(view) {
    const { previousSiblings, nextSiblings } = getChildrenSiblings(view);
    console.log(`${view} previousSiblings: ${previousSiblings} nextSiblings: ${nextSiblings}`);
}
const propertyMaps = new Map();
export class ViewUtil {
    constructor(namespaceFilters, reuseViews) {
        this.namespaceFilters = namespaceFilters;
        this.reuseViews = reuseViews;
    }
    /**
     * Inserts a child into a parrent, preferably before next.
     * @param parent parent view
     * @param child child view to be added
     * @param previous previous element. If present, insert after this.
     * @param next next element. If present, insert before this (previous is ignored).
     */
    insertChild(parent, child, previous, next) {
        if (!parent) {
            return;
        }
        const extendedParent = this.ensureNgViewExtensions(parent);
        const extendedChild = this.ensureNgViewExtensions(child);
        // if there's a next child, previous is the previousSibling of it
        if (next) {
            previous = next.previousSibling;
        }
        else if (previous) {
            // if there's a previous, next is the nextSibling of it
            next = previous.nextSibling;
        }
        else {
            // no previous or next, append to the parent
            previous = extendedParent.lastChild; // this can still be undefined if the parent has no children!
        }
        this.insertInList(extendedParent, extendedChild, previous, next);
        if (isInvisibleNode(child)) {
            extendedChild.parentNode = extendedParent;
        }
        if (!isDetachedElement(child)) {
            const nextVisual = this.findNextVisual(next);
            this.addToVisualTree(extendedParent, extendedChild, nextVisual);
        }
        // printNgTree(extendedChild);
    }
    insertBefore(parent, child, refChild) {
        const extendedRef = refChild ? this.ensureNgViewExtensions(refChild) : undefined;
        this.insertChild(parent, child, undefined, extendedRef);
    }
    insertAfter(parent, child, refChild) {
        const extendedRef = refChild ? this.ensureNgViewExtensions(refChild) : undefined;
        this.insertChild(parent, child, extendedRef);
    }
    appendChild(parent, child) {
        this.insertChild(parent, child);
    }
    /**
     * Inserts a view into the parent/sibling linked list
     * !WARNING: this method makes no checks to validate the integrity of previous/next children
     * @param parent parent view
     * @param child child view
     * @param previous previous element. null/undefined for first element
     * @param next next element. null/undefined for last element
     */
    insertInList(parent, child, previous, next) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.insertInList parent: ${parent}, view: ${child}, ` + `previous: ${previous}, next: ${next}`);
        }
        if (previous) {
            previous.nextSibling = child;
            child.previousSibling = previous;
        }
        else {
            parent.firstChild = child;
        }
        if (next) {
            child.nextSibling = next;
            next.previousSibling = child;
        }
        else {
            parent.lastChild = child;
        }
    }
    addToVisualTree(parent, child, next) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.addToVisualTree parent: ${parent}, view: ${child}, next: ${next}`);
        }
        if (parent.meta && parent.meta.insertChild) {
            parent.meta.insertChild(parent, child, next);
        }
        else if (isLayout(parent)) {
            this.insertToLayout(parent, child, next);
        }
        else if (isContentView(parent)) {
            parent.content = child;
        }
        else if (parent && parent._addChildFromBuilder) {
            parent._addChildFromBuilder(child.nodeName, child);
        }
    }
    insertToLayout(parent, child, next) {
        if (child.parent === parent) {
            this.removeLayoutChild(parent, child);
        }
        const nextVisual = this.findNextVisual(next);
        if (nextVisual) {
            const index = parent.getChildIndex(nextVisual);
            parent.insertChild(child, index);
        }
        else {
            parent.addChild(child);
        }
        // parent.eachChild((c) => {console.log(c); return true});
    }
    findNextVisual(view) {
        let next = view;
        while (next && isDetachedElement(next)) {
            next = next.nextSibling;
        }
        return next;
    }
    removeChild(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeChild parent: ${parent} child: ${child}`);
        }
        if (!parent) {
            return;
        }
        const extendedParent = this.ensureNgViewExtensions(parent);
        const extendedChild = this.ensureNgViewExtensions(child);
        this.removeFromList(extendedParent, extendedChild);
        if (!isDetachedElement(extendedChild)) {
            this.removeFromVisualTree(extendedParent, extendedChild);
        }
    }
    removeFromList(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeFromList parent: ${parent} child: ${child}`);
        }
        if (parent.firstChild === child && parent.lastChild === child) {
            parent.firstChild = null;
            parent.lastChild = null;
            child.nextSibling = null;
            child.previousSibling = null;
            return;
        }
        if (parent.firstChild === child) {
            parent.firstChild = child.nextSibling;
        }
        const previous = child.previousSibling;
        if (parent.lastChild === child) {
            parent.lastChild = previous;
        }
        if (previous) {
            previous.nextSibling = child.nextSibling;
            if (child.nextSibling) {
                child.nextSibling.previousSibling = previous;
            }
        }
        child.nextSibling = null;
        child.previousSibling = null;
    }
    // NOTE: This one is O(n) - use carefully
    findPreviousElement(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.findPreviousElement parent: ${parent} child: ${child}`);
        }
        let previousVisual;
        if (isLayout(parent)) {
            previousVisual = this.getPreviousVisualElement(parent, child);
        }
        let previous = previousVisual || parent.firstChild;
        // since detached elements are not added to the visual tree,
        // we need to find the actual previous sibling of the view,
        // which may as well be an invisible node
        while (previous && previous !== child && previous.nextSibling !== child) {
            previous = previous.nextSibling;
        }
        return previous;
    }
    getPreviousVisualElement(parent, child) {
        const elementIndex = parent.getChildIndex(child);
        if (elementIndex > 0) {
            return parent.getChildAt(elementIndex - 1);
        }
    }
    // NOTE: This one is O(n) - use carefully
    getChildIndex(parent, child) {
        if (isLayout(parent)) {
            return parent.getChildIndex(child);
        }
        else if (isContentView(parent)) {
            return child === parent.content ? 0 : -1;
        }
    }
    removeFromVisualTree(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeFromVisualTree parent: ${parent} child: ${child}`);
        }
        if (parent.meta && parent.meta.removeChild) {
            parent.meta.removeChild(parent, child);
        }
        else if (isLayout(parent)) {
            this.removeLayoutChild(parent, child);
        }
        else if (isContentView(parent) && parent.content === child) {
            parent.content = null;
        }
        else if (isView(parent)) {
            parent._removeView(child);
        }
    }
    removeLayoutChild(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeLayoutChild parent: ${parent} child: ${child}`);
        }
        const index = parent.getChildIndex(child);
        if (index !== -1) {
            parent.removeChild(child);
        }
    }
    createComment(value) {
        return new CommentNode(value);
    }
    createText(value) {
        return new TextNode(value);
    }
    createView(name) {
        const originalName = name;
        if (!isKnownView(name)) {
            name = 'ProxyViewContainer';
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Creating view: ${originalName} ${name}`);
        }
        const viewClass = getViewClass(name);
        const view = new viewClass();
        const ngView = this.setNgViewExtensions(view, name);
        ngView.reusable = !!this.reuseViews;
        return ngView;
    }
    ensureNgViewExtensions(view) {
        if (view.hasOwnProperty('meta')) {
            return view;
        }
        else {
            const name = view.cssType;
            const ngView = this.setNgViewExtensions(view, name);
            return ngView;
        }
    }
    setNgViewExtensions(view, name) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Make into a NgView view: ${view} name: "${name}"`);
        }
        const ngView = view;
        ngView.nodeName = name;
        ngView.meta = getViewMeta(name);
        // we're setting the node type of the view
        // to 'element' because of checks done in the
        // dom animation engine
        ngView.nodeType = ELEMENT_NODE_TYPE;
        return ngView;
    }
    setProperty(view, attributeName, value, namespace) {
        if (!view || (namespace && !this.runsIn(namespace))) {
            return;
        }
        if (attributeName.indexOf('.') !== -1) {
            // Handle nested properties
            const properties = attributeName.split('.');
            attributeName = properties[properties.length - 1];
            let propMap = this.getProperties(view);
            let i = 0;
            while (i < properties.length - 1 && typeof view !== 'undefined') {
                let prop = properties[i];
                if (propMap.has(prop)) {
                    prop = propMap.get(prop);
                }
                view = view[prop];
                propMap = this.getProperties(view);
                i++;
            }
        }
        if (typeof view !== 'undefined') {
            this.setPropertyInternal(view, attributeName, value);
        }
    }
    runsIn(platform) {
        let runs = true;
        const last = () => true;
        if (this.namespaceFilters) {
            let chain = (p) => true;
            for (let i = this.namespaceFilters.length - 1; i >= 0; i--) {
                const currentChain = chain;
                chain = (p) => this.namespaceFilters[i].runsIn(p, currentChain);
            }
            runs = chain(platform);
            runs = runs !== false ? true : false; // undefined means true
            // this.namespaceFilters.some((filter) => {
            // 	const runsInFilter = filter.runsIn(platform);
            // 	if (runsInFilter !== undefined) {
            // 		runs = runsInFilter;
            // 		return true;
            // 	}
            // });
        }
        return runs;
    }
    setPropertyInternal(view, attributeName, value) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Setting attribute: ${attributeName}=${value} to ${view}`);
        }
        if (attributeName === 'class') {
            this.setClasses(view, value);
            return;
        }
        if (XML_ATTRIBUTES.indexOf(attributeName) !== -1) {
            view[attributeName] = value;
            return;
        }
        const propMap = this.getProperties(view);
        const propertyName = propMap.get(attributeName);
        // Ensure the children of a collection currently have no parent set.
        if (Array.isArray(value)) {
            this.removeParentReferencesFromItems(value);
        }
        if (propertyName) {
            // We have a lower-upper case mapped property.
            view[propertyName] = value;
            return;
        }
        // Unknown attribute value -- just set it to our object as is.
        view[attributeName] = value;
    }
    removeParentReferencesFromItems(items) {
        for (const item of items) {
            if (item.parent && item.parentNode) {
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.viewUtilLog(`Unassigning parent ${item.parentNode} on value: ${item}`);
                }
                item.parent = undefined;
                item.parentNode = undefined;
            }
        }
    }
    getProperties(instance) {
        const type = instance && instance.constructor;
        if (!type) {
            return new Map();
        }
        if (!propertyMaps.has(type)) {
            let propMap = new Map();
            for (let propName in instance) {
                // tslint:disable:forin
                propMap.set(propName.toLowerCase(), propName);
            }
            propertyMaps.set(type, propMap);
        }
        return propertyMaps.get(type);
    }
    cssClasses(view) {
        if (!view.ngCssClasses) {
            view.ngCssClasses = new Map();
        }
        return view.ngCssClasses;
    }
    addClass(view, className) {
        const extendedView = this.ensureNgViewExtensions(view);
        this.cssClasses(extendedView).set(className, true);
        this.syncClasses(extendedView);
    }
    removeClass(view, className) {
        const extendedView = this.ensureNgViewExtensions(view);
        this.cssClasses(extendedView).delete(className);
        this.syncClasses(extendedView);
    }
    setClasses(view, classesValue) {
        let classes = classesValue.split(whiteSpaceSplitter);
        this.cssClasses(view).clear();
        classes.forEach((className) => this.cssClasses(view).set(className, true));
        this.syncClasses(view);
    }
    syncClasses(view) {
        let classValue = Array.from(this.cssClasses(view).keys()).join(' ');
        view.className = classValue;
    }
    setStyle(view, styleName, value) {
        view.style[styleName] = value;
    }
    removeStyle(view, styleName) {
        view.style[styleName] = unsetValue;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy11dGlsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL3ZpZXctdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQVEsVUFBVSxFQUE0RCxNQUFNLG9CQUFvQixDQUFDO0FBQ2hILE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxXQUFXLEVBQVUsUUFBUSxFQUFrQixpQkFBaUIsRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFHN0ksT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRzVDLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxDQUFDO0FBQzVCLE1BQU0sY0FBYyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7QUFDckYsTUFBTSxrQkFBa0IsR0FBRyxLQUFLLENBQUM7QUFJakMsU0FBUyxXQUFXLENBQUMsSUFBWTtJQUMvQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUM7SUFDbEIsT0FBTyxNQUFNLENBQUMsTUFBTSxJQUFLLE1BQU0sQ0FBQyxNQUFpQixDQUFDLFVBQVUsRUFBRTtRQUM1RCxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQWdCLENBQUM7S0FDbEM7SUFDRCxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMvQixDQUFDO0FBQ0QsU0FBUyxvQkFBb0IsQ0FBQyxNQUFjO0lBQzFDLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxHQUFHLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxVQUFVLENB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QUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzRSxJQUFJLENBQUMsU0FBUyxHQUFHLFVBQVUsQ0FBQztJQUM5QixDQUFDO0lBRU0sUUFBUSxDQUFDLElBQVUsRUFBRSxTQUFpQixFQUFFLEtBQVU7UUFDdkQsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxLQUFLLENBQUM7SUFDaEMsQ0FBQztJQUVNLFdBQVcsQ0FBQyxJQUFVLEVBQUUsU0FBaUI7UUFDOUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxVQUFVLENBQUM7SUFDckMsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmlldywgdW5zZXRWYWx1ZSwgUGxhY2Vob2xkZXIsIENvbnRlbnRWaWV3LCBMYXlvdXRCYXNlLCBQcm94eVZpZXdDb250YWluZXIgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuaW1wb3J0IHsgZ2V0Vmlld0NsYXNzLCBnZXRWaWV3TWV0YSwgaXNLbm93blZpZXcgfSBmcm9tICcuL2VsZW1lbnQtcmVnaXN0cnknO1xuaW1wb3J0IHsgQ29tbWVudE5vZGUsIE5nVmlldywgVGV4dE5vZGUsIFZpZXdFeHRlbnNpb25zLCBpc0RldGFjaGVkRWxlbWVudCwgaXNJbnZpc2libGVOb2RlLCBpc1ZpZXcsIGlzQ29udGVudFZpZXcsIGlzTGF5b3V0IH0gZnJvbSAnLi92aWV3cyc7XG5pbXBvcnQgeyBOYW1lc3BhY2VGaWx0ZXIgfSBmcm9tICcuL3Byb3BlcnR5LWZpbHRlcic7XG5cbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi90cmFjZSc7XG5pbXBvcnQgeyBOZ0xheW91dEJhc2UgfSBmcm9tICcuL3ZpZXdzL3ZpZXctdHlwZXMnO1xuXG5jb25zdCBFTEVNRU5UX05PREVfVFlQRSA9IDE7XG5jb25zdCBYTUxfQVRUUklCVVRFUyA9IE9iamVjdC5mcmVlemUoWydzdHlsZScsICdyb3dzJywgJ2NvbHVtbnMnLCAnZm9udEF0dHJpYnV0ZXMnXSk7XG5jb25zdCB3aGl0ZVNwYWNlU3BsaXR0ZXIgPSAvXFxzKy87XG5cbmV4cG9ydCB0eXBlIEJlZm9yZUF0dGFjaEFjdGlvbiA9ICh2aWV3OiBWaWV3KSA9PiB2b2lkO1xuXG5mdW5jdGlvbiBwcmludE5nVHJlZSh2aWV3OiBOZ1ZpZXcpIHtcbiAgbGV0IHBhcmVudCA9IHZpZXc7XG4gIHdoaWxlIChwYXJlbnQucGFyZW50ICYmIChwYXJlbnQucGFyZW50IGFzIE5nVmlldykuZmlyc3RDaGlsZCkge1xuICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQgYXMgTmdWaWV3O1xuICB9XG4gIHByaW50Q2hpbGRyZW5SZWN1cnNlKHBhcmVudCk7XG59XG5mdW5jdGlvbiBwcmludENoaWxkcmVuUmVjdXJzZShwYXJlbnQ6IE5nVmlldykge1xuICBjb25zdCBjaGlsZHJlbiA9IHBhcmVudC5maXJzdENoaWxkID8gW3BhcmVudC5maXJzdENoaWxkLCAuLi5nZXRDaGlsZHJlblNpYmxpbmdzKHBhcmVudC5maXJzdENoaWxkKS5uZXh0U2libGluZ3NdIDogW107XG4gIGNvbnNvbGUubG9nKGBwYXJlbnQ6ICR7cGFyZW50fSwgZmlyc3RDaGlsZDogJHtwYXJlbnQuZmlyc3RDaGlsZH0sIGxhc3RDaGlsZDogJHtwYXJlbnQubGFzdENoaWxkfSBjaGlsZHJlbjogJHtjaGlsZHJlbn1gKTtcbiAgaWYgKHBhcmVudC5maXJzdENoaWxkKSB7XG4gICAgY29uc29sZS5sb2coYC0tLS0tIHN0YXJ0ICR7cGFyZW50fWApO1xuICB9XG4gIGNoaWxkcmVuLmZvckVhY2goKGMpID0+IHByaW50Q2hpbGRyZW5SZWN1cnNlKGMpKTtcbiAgaWYgKHBhcmVudC5maXJzdENoaWxkKSB7XG4gICAgY29uc29sZS5sb2coYC0tLS0tIGVuZCAke3BhcmVudH1gKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRDaGlsZHJlblNpYmxpbmdzKHZpZXc6IE5nVmlldykge1xuICBjb25zdCBuZXh0U2libGluZ3MgPSBbXTtcbiAgY29uc3QgcHJldmlvdXNTaWJsaW5ncyA9IFtdO1xuICBsZXQgc2libGluZyA9IHZpZXcubmV4dFNpYmxpbmc7XG4gIHdoaWxlIChzaWJsaW5nKSB7XG4gICAgbmV4dFNpYmxpbmdzLnB1c2goc2libGluZyk7XG4gICAgc2libGluZyA9IHNpYmxpbmcubmV4dFNpYmxpbmc7XG4gIH1cbiAgc2libGluZyA9IHZpZXcucHJldmlvdXNTaWJsaW5nO1xuICB3aGlsZSAoc2libGluZykge1xuICAgIHByZXZpb3VzU2libGluZ3MucHVzaChzaWJsaW5nKTtcbiAgICBzaWJsaW5nID0gc2libGluZy5wcmV2aW91c1NpYmxpbmc7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBwcmV2aW91c1NpYmxpbmdzLFxuICAgIG5leHRTaWJsaW5ncyxcbiAgfTtcbn1cblxuZnVuY3Rpb24gcHJpbnRTaWJsaW5nc1RyZWUodmlldzogTmdWaWV3KSB7XG4gIGNvbnN0IHsgcHJldmlvdXNTaWJsaW5ncywgbmV4dFNpYmxpbmdzIH0gPSBnZXRDaGlsZHJlblNpYmxpbmdzKHZpZXcpO1xuICBjb25zb2xlLmxvZyhgJHt2aWV3fSBwcmV2aW91c1NpYmxpbmdzOiAke3ByZXZpb3VzU2libGluZ3N9IG5leHRTaWJsaW5nczogJHtuZXh0U2libGluZ3N9YCk7XG59XG5cbmNvbnN0IHByb3BlcnR5TWFwczogTWFwPEZ1bmN0aW9uLCBNYXA8c3RyaW5nLCBzdHJpbmc+PiA9IG5ldyBNYXA8RnVuY3Rpb24sIE1hcDxzdHJpbmcsIHN0cmluZz4+KCk7XG5cbmV4cG9ydCBjbGFzcyBWaWV3VXRpbCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbmFtZXNwYWNlRmlsdGVycz86IE5hbWVzcGFjZUZpbHRlcltdLCBwcml2YXRlIHJldXNlVmlld3M/OiBib29sZWFuKSB7fVxuICAvKipcbiAgICogSW5zZXJ0cyBhIGNoaWxkIGludG8gYSBwYXJyZW50LCBwcmVmZXJhYmx5IGJlZm9yZSBuZXh0LlxuICAgKiBAcGFyYW0gcGFyZW50IHBhcmVudCB2aWV3XG4gICAqIEBwYXJhbSBjaGlsZCBjaGlsZCB2aWV3IHRvIGJlIGFkZGVkXG4gICAqIEBwYXJhbSBwcmV2aW91cyBwcmV2aW91cyBlbGVtZW50LiBJZiBwcmVzZW50LCBpbnNlcnQgYWZ0ZXIgdGhpcy5cbiAgICogQHBhcmFtIG5leHQgbmV4dCBlbGVtZW50LiBJZiBwcmVzZW50LCBpbnNlcnQgYmVmb3JlIHRoaXMgKHByZXZpb3VzIGlzIGlnbm9yZWQpLlxuICAgKi9cbiAgcHJpdmF0ZSBpbnNlcnRDaGlsZChwYXJlbnQ6IFZpZXcsIGNoaWxkOiBWaWV3LCBwcmV2aW91cz86IE5nVmlldywgbmV4dD86IE5nVmlldykge1xuICAgIGlmICghcGFyZW50KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZXh0ZW5kZWRQYXJlbnQgPSB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnMocGFyZW50KTtcbiAgICBjb25zdCBleHRlbmRlZENoaWxkID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKGNoaWxkKTtcblxuICAgIC8vIGlmIHRoZXJlJ3MgYSBuZXh0IGNoaWxkLCBwcmV2aW91cyBpcyB0aGUgcHJldmlvdXNTaWJsaW5nIG9mIGl0XG4gICAgaWYgKG5leHQpIHtcbiAgICAgIHByZXZpb3VzID0gbmV4dC5wcmV2aW91c1NpYmxpbmc7XG4gICAgfSBlbHNlIGlmIChwcmV2aW91cykge1xuICAgICAgLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzLCBuZXh0IGlzIHRoZSBuZXh0U2libGluZyBvZiBpdFxuICAgICAgbmV4dCA9IHByZXZpb3VzLm5leHRTaWJsaW5nO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBubyBwcmV2aW91cyBvciBuZXh0LCBhcHBlbmQgdG8gdGhlIHBhcmVudFxuICAgICAgcHJldmlvdXMgPSBleHRlbmRlZFBhcmVudC5sYXN0Q2hpbGQ7IC8vIHRoaXMgY2FuIHN0aWxsIGJlIHVuZGVmaW5lZCBpZiB0aGUgcGFyZW50IGhhcyBubyBjaGlsZHJlbiFcbiAgICB9XG4gICAgdGhpcy5pbnNlcnRJbkxpc3QoZXh0ZW5kZWRQYXJlbnQsIGV4dGVuZGVkQ2hpbGQsIHByZXZpb3VzLCBuZXh0KTtcblxuICAgIGlmIChpc0ludmlzaWJsZU5vZGUoY2hpbGQpKSB7XG4gICAgICBleHRlbmRlZENoaWxkLnBhcmVudE5vZGUgPSBleHRlbmRlZFBhcmVudDtcbiAgICB9XG5cbiAgICBpZiAoIWlzRGV0YWNoZWRFbGVtZW50KGNoaWxkKSkge1xuICAgICAgY29uc3QgbmV4dFZpc3VhbCA9IHRoaXMuZmluZE5leHRWaXN1YWwobmV4dCk7XG4gICAgICB0aGlzLmFkZFRvVmlzdWFsVHJlZShleHRlbmRlZFBhcmVudCwgZXh0ZW5kZWRDaGlsZCwgbmV4dFZpc3VhbCk7XG4gICAgfVxuICAgIC8vIHByaW50TmdUcmVlKGV4dGVuZGVkQ2hpbGQpO1xuICB9XG5cbiAgcHVibGljIGluc2VydEJlZm9yZShwYXJlbnQ6IFZpZXcsIGNoaWxkOiBWaWV3LCByZWZDaGlsZD86IFZpZXcgfCBOZ1ZpZXcpIHtcbiAgICBjb25zdCBleHRlbmRlZFJlZiA9IHJlZkNoaWxkID8gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHJlZkNoaWxkKSA6IHVuZGVmaW5lZDtcbiAgICB0aGlzLmluc2VydENoaWxkKHBhcmVudCwgY2hpbGQsIHVuZGVmaW5lZCwgZXh0ZW5kZWRSZWYpO1xuICB9XG4gIHB1YmxpYyBpbnNlcnRBZnRlcihwYXJlbnQ6IFZpZXcsIGNoaWxkOiBWaWV3LCByZWZDaGlsZD86IFZpZXcgfCBOZ1ZpZXcpIHtcbiAgICBjb25zdCBleHRlbmRlZFJlZiA9IHJlZkNoaWxkID8gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHJlZkNoaWxkKSA6IHVuZGVmaW5lZDtcbiAgICB0aGlzLmluc2VydENoaWxkKHBhcmVudCwgY2hpbGQsIGV4dGVuZGVkUmVmKTtcbiAgfVxuXG4gIHB1YmxpYyBhcHBlbmRDaGlsZChwYXJlbnQ6IFZpZXcsIGNoaWxkOiBWaWV3KSB7XG4gICAgdGhpcy5pbnNlcnRDaGlsZChwYXJlbnQsIGNoaWxkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnNlcnRzIGEgdmlldyBpbnRvIHRoZSBwYXJlbnQvc2libGluZyBsaW5rZWQgbGlzdFxuICAgKiAhV0FSTklORzogdGhpcyBtZXRob2QgbWFrZXMgbm8gY2hlY2tzIHRvIHZhbGlkYXRlIHRoZSBpbnRlZ3JpdHkgb2YgcHJldmlvdXMvbmV4dCBjaGlsZHJlblxuICAgKiBAcGFyYW0gcGFyZW50IHBhcmVudCB2aWV3XG4gICAqIEBwYXJhbSBjaGlsZCBjaGlsZCB2aWV3XG4gICAqIEBwYXJhbSBwcmV2aW91cyBwcmV2aW91cyBlbGVtZW50LiBudWxsL3VuZGVmaW5lZCBmb3IgZmlyc3QgZWxlbWVudFxuICAgKiBAcGFyYW0gbmV4dCBuZXh0IGVsZW1lbnQuIG51bGwvdW5kZWZpbmVkIGZvciBsYXN0IGVsZW1lbnRcbiAgICovXG4gIHByaXZhdGUgaW5zZXJ0SW5MaXN0KHBhcmVudDogTmdWaWV3LCBjaGlsZDogTmdWaWV3LCBwcmV2aW91czogTmdWaWV3LCBuZXh0OiBOZ1ZpZXcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5pbnNlcnRJbkxpc3QgcGFyZW50OiAke3BhcmVudH0sIHZpZXc6ICR7Y2hpbGR9LCBgICsgYHByZXZpb3VzOiAke3ByZXZpb3VzfSwgbmV4dDogJHtuZXh0fWApO1xuICAgIH1cblxuICAgIGlmIChwcmV2aW91cykge1xuICAgICAgcHJldmlvdXMubmV4dFNpYmxpbmcgPSBjaGlsZDtcbiAgICAgIGNoaWxkLnByZXZpb3VzU2libGluZyA9IHByZXZpb3VzO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJlbnQuZmlyc3RDaGlsZCA9IGNoaWxkO1xuICAgIH1cblxuICAgIGlmIChuZXh0KSB7XG4gICAgICBjaGlsZC5uZXh0U2libGluZyA9IG5leHQ7XG4gICAgICBuZXh0LnByZXZpb3VzU2libGluZyA9IGNoaWxkO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJlbnQubGFzdENoaWxkID0gY2hpbGQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRUb1Zpc3VhbFRyZWUocGFyZW50OiBOZ1ZpZXcsIGNoaWxkOiBOZ1ZpZXcsIG5leHQ6IE5nVmlldyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLmFkZFRvVmlzdWFsVHJlZSBwYXJlbnQ6ICR7cGFyZW50fSwgdmlldzogJHtjaGlsZH0sIG5leHQ6ICR7bmV4dH1gKTtcbiAgICB9XG5cbiAgICBpZiAocGFyZW50Lm1ldGEgJiYgcGFyZW50Lm1ldGEuaW5zZXJ0Q2hpbGQpIHtcbiAgICAgIHBhcmVudC5tZXRhLmluc2VydENoaWxkKHBhcmVudCwgY2hpbGQsIG5leHQpO1xuICAgIH0gZWxzZSBpZiAoaXNMYXlvdXQocGFyZW50KSkge1xuICAgICAgdGhpcy5pbnNlcnRUb0xheW91dChwYXJlbnQsIGNoaWxkLCBuZXh0KTtcbiAgICB9IGVsc2UgaWYgKGlzQ29udGVudFZpZXcocGFyZW50KSkge1xuICAgICAgcGFyZW50LmNvbnRlbnQgPSBjaGlsZDtcbiAgICB9IGVsc2UgaWYgKHBhcmVudCAmJiAoPGFueT5wYXJlbnQpLl9hZGRDaGlsZEZyb21CdWlsZGVyKSB7XG4gICAgICAoPGFueT5wYXJlbnQpLl9hZGRDaGlsZEZyb21CdWlsZGVyKGNoaWxkLm5vZGVOYW1lLCBjaGlsZCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbnNlcnRUb0xheW91dChwYXJlbnQ6IE5nTGF5b3V0QmFzZSwgY2hpbGQ6IE5nVmlldywgbmV4dDogTmdWaWV3KTogdm9pZCB7XG4gICAgaWYgKGNoaWxkLnBhcmVudCA9PT0gcGFyZW50KSB7XG4gICAgICB0aGlzLnJlbW92ZUxheW91dENoaWxkKHBhcmVudCwgY2hpbGQpO1xuICAgIH1cblxuICAgIGNvbnN0IG5leHRWaXN1YWwgPSB0aGlzLmZpbmROZXh0VmlzdWFsKG5leHQpO1xuICAgIGlmIChuZXh0VmlzdWFsKSB7XG4gICAgICBjb25zdCBpbmRleCA9IHBhcmVudC5nZXRDaGlsZEluZGV4KG5leHRWaXN1YWwpO1xuICAgICAgcGFyZW50Lmluc2VydENoaWxkKGNoaWxkLCBpbmRleCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmVudC5hZGRDaGlsZChjaGlsZCk7XG4gICAgfVxuICAgIC8vIHBhcmVudC5lYWNoQ2hpbGQoKGMpID0+IHtjb25zb2xlLmxvZyhjKTsgcmV0dXJuIHRydWV9KTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZE5leHRWaXN1YWwodmlldzogTmdWaWV3KTogTmdWaWV3IHtcbiAgICBsZXQgbmV4dCA9IHZpZXc7XG4gICAgd2hpbGUgKG5leHQgJiYgaXNEZXRhY2hlZEVsZW1lbnQobmV4dCkpIHtcbiAgICAgIG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nO1xuICAgIH1cblxuICAgIHJldHVybiBuZXh0O1xuICB9XG5cbiAgcHVibGljIHJlbW92ZUNoaWxkKHBhcmVudDogVmlldywgY2hpbGQ6IFZpZXcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5yZW1vdmVDaGlsZCBwYXJlbnQ6ICR7cGFyZW50fSBjaGlsZDogJHtjaGlsZH1gKTtcbiAgICB9XG5cbiAgICBpZiAoIXBhcmVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGV4dGVuZGVkUGFyZW50ID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHBhcmVudCk7XG4gICAgY29uc3QgZXh0ZW5kZWRDaGlsZCA9IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhjaGlsZCk7XG5cbiAgICB0aGlzLnJlbW92ZUZyb21MaXN0KGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkKTtcbiAgICBpZiAoIWlzRGV0YWNoZWRFbGVtZW50KGV4dGVuZGVkQ2hpbGQpKSB7XG4gICAgICB0aGlzLnJlbW92ZUZyb21WaXN1YWxUcmVlKGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUZyb21MaXN0KHBhcmVudDogTmdWaWV3LCBjaGlsZDogTmdWaWV3KSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwucmVtb3ZlRnJvbUxpc3QgcGFyZW50OiAke3BhcmVudH0gY2hpbGQ6ICR7Y2hpbGR9YCk7XG4gICAgfVxuXG4gICAgaWYgKHBhcmVudC5maXJzdENoaWxkID09PSBjaGlsZCAmJiBwYXJlbnQubGFzdENoaWxkID09PSBjaGlsZCkge1xuICAgICAgcGFyZW50LmZpcnN0Q2hpbGQgPSBudWxsO1xuICAgICAgcGFyZW50Lmxhc3RDaGlsZCA9IG51bGw7XG4gICAgICBjaGlsZC5uZXh0U2libGluZyA9IG51bGw7XG4gICAgICBjaGlsZC5wcmV2aW91c1NpYmxpbmcgPSBudWxsO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChwYXJlbnQuZmlyc3RDaGlsZCA9PT0gY2hpbGQpIHtcbiAgICAgIHBhcmVudC5maXJzdENoaWxkID0gY2hpbGQubmV4dFNpYmxpbmc7XG4gICAgfVxuXG4gICAgY29uc3QgcHJldmlvdXMgPSBjaGlsZC5wcmV2aW91c1NpYmxpbmc7XG4gICAgaWYgKHBhcmVudC5sYXN0Q2hpbGQgPT09IGNoaWxkKSB7XG4gICAgICBwYXJlbnQubGFzdENoaWxkID0gcHJldmlvdXM7XG4gICAgfVxuXG4gICAgaWYgKHByZXZpb3VzKSB7XG4gICAgICBwcmV2aW91cy5uZXh0U2libGluZyA9IGNoaWxkLm5leHRTaWJsaW5nO1xuICAgICAgaWYgKGNoaWxkLm5leHRTaWJsaW5nKSB7XG4gICAgICAgIGNoaWxkLm5leHRTaWJsaW5nLnByZXZpb3VzU2libGluZyA9IHByZXZpb3VzO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNoaWxkLm5leHRTaWJsaW5nID0gbnVsbDtcbiAgICBjaGlsZC5wcmV2aW91c1NpYmxpbmcgPSBudWxsO1xuICB9XG5cbiAgLy8gTk9URTogVGhpcyBvbmUgaXMgTyhuKSAtIHVzZSBjYXJlZnVsbHlcbiAgcHJpdmF0ZSBmaW5kUHJldmlvdXNFbGVtZW50KHBhcmVudDogTmdWaWV3LCBjaGlsZDogTmdWaWV3KTogTmdWaWV3IHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5maW5kUHJldmlvdXNFbGVtZW50IHBhcmVudDogJHtwYXJlbnR9IGNoaWxkOiAke2NoaWxkfWApO1xuICAgIH1cblxuICAgIGxldCBwcmV2aW91c1Zpc3VhbDtcbiAgICBpZiAoaXNMYXlvdXQocGFyZW50KSkge1xuICAgICAgcHJldmlvdXNWaXN1YWwgPSB0aGlzLmdldFByZXZpb3VzVmlzdWFsRWxlbWVudChwYXJlbnQsIGNoaWxkKTtcbiAgICB9XG5cbiAgICBsZXQgcHJldmlvdXMgPSBwcmV2aW91c1Zpc3VhbCB8fCBwYXJlbnQuZmlyc3RDaGlsZDtcblxuICAgIC8vIHNpbmNlIGRldGFjaGVkIGVsZW1lbnRzIGFyZSBub3QgYWRkZWQgdG8gdGhlIHZpc3VhbCB0cmVlLFxuICAgIC8vIHdlIG5lZWQgdG8gZmluZCB0aGUgYWN0dWFsIHByZXZpb3VzIHNpYmxpbmcgb2YgdGhlIHZpZXcsXG4gICAgLy8gd2hpY2ggbWF5IGFzIHdlbGwgYmUgYW4gaW52aXNpYmxlIG5vZGVcbiAgICB3aGlsZSAocHJldmlvdXMgJiYgcHJldmlvdXMgIT09IGNoaWxkICYmIHByZXZpb3VzLm5leHRTaWJsaW5nICE9PSBjaGlsZCkge1xuICAgICAgcHJldmlvdXMgPSBwcmV2aW91cy5uZXh0U2libGluZztcbiAgICB9XG5cbiAgICByZXR1cm4gcHJldmlvdXM7XG4gIH1cblxuICBwcml2YXRlIGdldFByZXZpb3VzVmlzdWFsRWxlbWVudChwYXJlbnQ6IE5nTGF5b3V0QmFzZSwgY2hpbGQ6IE5nVmlldyk6IE5nVmlldyB7XG4gICAgY29uc3QgZWxlbWVudEluZGV4ID0gcGFyZW50LmdldENoaWxkSW5kZXgoY2hpbGQpO1xuXG4gICAgaWYgKGVsZW1lbnRJbmRleCA+IDApIHtcbiAgICAgIHJldHVybiBwYXJlbnQuZ2V0Q2hpbGRBdChlbGVtZW50SW5kZXggLSAxKSBhcyBOZ1ZpZXc7XG4gICAgfVxuICB9XG5cbiAgLy8gTk9URTogVGhpcyBvbmUgaXMgTyhuKSAtIHVzZSBjYXJlZnVsbHlcbiAgcHVibGljIGdldENoaWxkSW5kZXgocGFyZW50OiBhbnksIGNoaWxkOiBOZ1ZpZXcpIHtcbiAgICBpZiAoaXNMYXlvdXQocGFyZW50KSkge1xuICAgICAgcmV0dXJuIHBhcmVudC5nZXRDaGlsZEluZGV4KGNoaWxkKTtcbiAgICB9IGVsc2UgaWYgKGlzQ29udGVudFZpZXcocGFyZW50KSkge1xuICAgICAgcmV0dXJuIGNoaWxkID09PSBwYXJlbnQuY29udGVudCA/IDAgOiAtMTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUZyb21WaXN1YWxUcmVlKHBhcmVudDogTmdWaWV3LCBjaGlsZDogTmdWaWV3KSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwucmVtb3ZlRnJvbVZpc3VhbFRyZWUgcGFyZW50OiAke3BhcmVudH0gY2hpbGQ6ICR7Y2hpbGR9YCk7XG4gICAgfVxuXG4gICAgaWYgKHBhcmVudC5tZXRhICYmIHBhcmVudC5tZXRhLnJlbW92ZUNoaWxkKSB7XG4gICAgICBwYXJlbnQubWV0YS5yZW1vdmVDaGlsZChwYXJlbnQsIGNoaWxkKTtcbiAgICB9IGVsc2UgaWYgKGlzTGF5b3V0KHBhcmVudCkpIHtcbiAgICAgIHRoaXMucmVtb3ZlTGF5b3V0Q2hpbGQocGFyZW50LCBjaGlsZCk7XG4gICAgfSBlbHNlIGlmIChpc0NvbnRlbnRWaWV3KHBhcmVudCkgJiYgcGFyZW50LmNvbnRlbnQgPT09IGNoaWxkKSB7XG4gICAgICBwYXJlbnQuY29udGVudCA9IG51bGw7XG4gICAgfSBlbHNlIGlmIChpc1ZpZXcocGFyZW50KSkge1xuICAgICAgcGFyZW50Ll9yZW1vdmVWaWV3KGNoaWxkKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUxheW91dENoaWxkKHBhcmVudDogTmdMYXlvdXRCYXNlLCBjaGlsZDogTmdWaWV3KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwucmVtb3ZlTGF5b3V0Q2hpbGQgcGFyZW50OiAke3BhcmVudH0gY2hpbGQ6ICR7Y2hpbGR9YCk7XG4gICAgfVxuXG4gICAgY29uc3QgaW5kZXggPSBwYXJlbnQuZ2V0Q2hpbGRJbmRleChjaGlsZCk7XG5cbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICBwYXJlbnQucmVtb3ZlQ2hpbGQoY2hpbGQpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVDb21tZW50KHZhbHVlOiBzdHJpbmcpOiBDb21tZW50Tm9kZSB7XG4gICAgcmV0dXJuIG5ldyBDb21tZW50Tm9kZSh2YWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVGV4dCh2YWx1ZTogc3RyaW5nKTogVGV4dE5vZGUge1xuICAgIHJldHVybiBuZXcgVGV4dE5vZGUodmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVZpZXcobmFtZTogc3RyaW5nKTogTmdWaWV3IHtcbiAgICBjb25zdCBvcmlnaW5hbE5hbWUgPSBuYW1lO1xuICAgIGlmICghaXNLbm93blZpZXcobmFtZSkpIHtcbiAgICAgIG5hbWUgPSAnUHJveHlWaWV3Q29udGFpbmVyJztcbiAgICB9XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBDcmVhdGluZyB2aWV3OiAke29yaWdpbmFsTmFtZX0gJHtuYW1lfWApO1xuICAgIH1cblxuICAgIGNvbnN0IHZpZXdDbGFzcyA9IGdldFZpZXdDbGFzcyhuYW1lKTtcbiAgICBjb25zdCB2aWV3ID0gPE5nVmlldz5uZXcgdmlld0NsYXNzKCk7XG4gICAgY29uc3QgbmdWaWV3ID0gdGhpcy5zZXROZ1ZpZXdFeHRlbnNpb25zKHZpZXcsIG5hbWUpO1xuICAgIG5nVmlldy5yZXVzYWJsZSA9ICEhdGhpcy5yZXVzZVZpZXdzO1xuXG4gICAgcmV0dXJuIG5nVmlldztcbiAgfVxuXG4gIHByaXZhdGUgZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyh2aWV3OiBWaWV3KTogTmdWaWV3IHtcbiAgICBpZiAodmlldy5oYXNPd25Qcm9wZXJ0eSgnbWV0YScpKSB7XG4gICAgICByZXR1cm4gdmlldyBhcyBOZ1ZpZXc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5hbWUgPSB2aWV3LmNzc1R5cGU7XG4gICAgICBjb25zdCBuZ1ZpZXcgPSB0aGlzLnNldE5nVmlld0V4dGVuc2lvbnModmlldywgbmFtZSk7XG5cbiAgICAgIHJldHVybiBuZ1ZpZXc7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXROZ1ZpZXdFeHRlbnNpb25zKHZpZXc6IFZpZXcsIG5hbWU6IHN0cmluZyk6IE5nVmlldyB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgTWFrZSBpbnRvIGEgTmdWaWV3IHZpZXc6ICR7dmlld30gbmFtZTogXCIke25hbWV9XCJgKTtcbiAgICB9XG5cbiAgICBjb25zdCBuZ1ZpZXcgPSB2aWV3IGFzIE5nVmlldztcbiAgICBuZ1ZpZXcubm9kZU5hbWUgPSBuYW1lO1xuICAgIG5nVmlldy5tZXRhID0gZ2V0Vmlld01ldGEobmFtZSk7XG5cbiAgICAvLyB3ZSdyZSBzZXR0aW5nIHRoZSBub2RlIHR5cGUgb2YgdGhlIHZpZXdcbiAgICAvLyB0byAnZWxlbWVudCcgYmVjYXVzZSBvZiBjaGVja3MgZG9uZSBpbiB0aGVcbiAgICAvLyBkb20gYW5pbWF0aW9uIGVuZ2luZVxuICAgIG5nVmlldy5ub2RlVHlwZSA9IEVMRU1FTlRfTk9ERV9UWVBFO1xuXG4gICAgcmV0dXJuIG5nVmlldztcbiAgfVxuXG4gIHB1YmxpYyBzZXRQcm9wZXJ0eSh2aWV3OiBOZ1ZpZXcsIGF0dHJpYnV0ZU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSwgbmFtZXNwYWNlPzogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKCF2aWV3IHx8IChuYW1lc3BhY2UgJiYgIXRoaXMucnVuc0luKG5hbWVzcGFjZSkpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGF0dHJpYnV0ZU5hbWUuaW5kZXhPZignLicpICE9PSAtMSkge1xuICAgICAgLy8gSGFuZGxlIG5lc3RlZCBwcm9wZXJ0aWVzXG4gICAgICBjb25zdCBwcm9wZXJ0aWVzID0gYXR0cmlidXRlTmFtZS5zcGxpdCgnLicpO1xuICAgICAgYXR0cmlidXRlTmFtZSA9IHByb3BlcnRpZXNbcHJvcGVydGllcy5sZW5ndGggLSAxXTtcblxuICAgICAgbGV0IHByb3BNYXAgPSB0aGlzLmdldFByb3BlcnRpZXModmlldyk7XG4gICAgICBsZXQgaSA9IDA7XG4gICAgICB3aGlsZSAoaSA8IHByb3BlcnRpZXMubGVuZ3RoIC0gMSAmJiB0eXBlb2YgdmlldyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgbGV0IHByb3AgPSBwcm9wZXJ0aWVzW2ldO1xuICAgICAgICBpZiAocHJvcE1hcC5oYXMocHJvcCkpIHtcbiAgICAgICAgICBwcm9wID0gcHJvcE1hcC5nZXQocHJvcCk7XG4gICAgICAgIH1cblxuICAgICAgICB2aWV3ID0gdmlld1twcm9wXTtcbiAgICAgICAgcHJvcE1hcCA9IHRoaXMuZ2V0UHJvcGVydGllcyh2aWV3KTtcbiAgICAgICAgaSsrO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0eXBlb2YgdmlldyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMuc2V0UHJvcGVydHlJbnRlcm5hbCh2aWV3LCBhdHRyaWJ1dGVOYW1lLCB2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBydW5zSW4ocGxhdGZvcm06IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGxldCBydW5zID0gdHJ1ZTtcbiAgICBjb25zdCBsYXN0ID0gKCkgPT4gdHJ1ZTtcbiAgICBpZiAodGhpcy5uYW1lc3BhY2VGaWx0ZXJzKSB7XG4gICAgICBsZXQgY2hhaW4gPSAocDogc3RyaW5nKSA9PiB0cnVlO1xuICAgICAgZm9yIChsZXQgaSA9IHRoaXMubmFtZXNwYWNlRmlsdGVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICBjb25zdCBjdXJyZW50Q2hhaW4gPSBjaGFpbjtcbiAgICAgICAgY2hhaW4gPSAocCkgPT4gdGhpcy5uYW1lc3BhY2VGaWx0ZXJzW2ldLnJ1bnNJbihwLCBjdXJyZW50Q2hhaW4pO1xuICAgICAgfVxuICAgICAgcnVucyA9IGNoYWluKHBsYXRmb3JtKTtcbiAgICAgIHJ1bnMgPSBydW5zICE9PSBmYWxzZSA/IHRydWUgOiBmYWxzZTsgLy8gdW5kZWZpbmVkIG1lYW5zIHRydWVcbiAgICAgIC8vIHRoaXMubmFtZXNwYWNlRmlsdGVycy5zb21lKChmaWx0ZXIpID0+IHtcbiAgICAgIC8vIFx0Y29uc3QgcnVuc0luRmlsdGVyID0gZmlsdGVyLnJ1bnNJbihwbGF0Zm9ybSk7XG4gICAgICAvLyBcdGlmIChydW5zSW5GaWx0ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gXHRcdHJ1bnMgPSBydW5zSW5GaWx0ZXI7XG4gICAgICAvLyBcdFx0cmV0dXJuIHRydWU7XG4gICAgICAvLyBcdH1cbiAgICAgIC8vIH0pO1xuICAgIH1cbiAgICByZXR1cm4gcnVucztcbiAgfVxuXG4gIHByaXZhdGUgc2V0UHJvcGVydHlJbnRlcm5hbCh2aWV3OiBOZ1ZpZXcsIGF0dHJpYnV0ZU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFNldHRpbmcgYXR0cmlidXRlOiAke2F0dHJpYnV0ZU5hbWV9PSR7dmFsdWV9IHRvICR7dmlld31gKTtcbiAgICB9XG5cbiAgICBpZiAoYXR0cmlidXRlTmFtZSA9PT0gJ2NsYXNzJykge1xuICAgICAgdGhpcy5zZXRDbGFzc2VzKHZpZXcsIHZhbHVlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoWE1MX0FUVFJJQlVURVMuaW5kZXhPZihhdHRyaWJ1dGVOYW1lKSAhPT0gLTEpIHtcbiAgICAgIHZpZXdbYXR0cmlidXRlTmFtZV0gPSB2YWx1ZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwcm9wTWFwID0gdGhpcy5nZXRQcm9wZXJ0aWVzKHZpZXcpO1xuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BNYXAuZ2V0KGF0dHJpYnV0ZU5hbWUpO1xuXG4gICAgLy8gRW5zdXJlIHRoZSBjaGlsZHJlbiBvZiBhIGNvbGxlY3Rpb24gY3VycmVudGx5IGhhdmUgbm8gcGFyZW50IHNldC5cbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIHRoaXMucmVtb3ZlUGFyZW50UmVmZXJlbmNlc0Zyb21JdGVtcyh2YWx1ZSk7XG4gICAgfVxuXG4gICAgaWYgKHByb3BlcnR5TmFtZSkge1xuICAgICAgLy8gV2UgaGF2ZSBhIGxvd2VyLXVwcGVyIGNhc2UgbWFwcGVkIHByb3BlcnR5LlxuICAgICAgdmlld1twcm9wZXJ0eU5hbWVdID0gdmFsdWU7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gVW5rbm93biBhdHRyaWJ1dGUgdmFsdWUgLS0ganVzdCBzZXQgaXQgdG8gb3VyIG9iamVjdCBhcyBpcy5cbiAgICB2aWV3W2F0dHJpYnV0ZU5hbWVdID0gdmFsdWU7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZVBhcmVudFJlZmVyZW5jZXNGcm9tSXRlbXMoaXRlbXM6IGFueVtdKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKSB7XG4gICAgICBpZiAoaXRlbS5wYXJlbnQgJiYgaXRlbS5wYXJlbnROb2RlKSB7XG4gICAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBVbmFzc2lnbmluZyBwYXJlbnQgJHtpdGVtLnBhcmVudE5vZGV9IG9uIHZhbHVlOiAke2l0ZW19YCk7XG4gICAgICAgIH1cbiAgICAgICAgaXRlbS5wYXJlbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgIGl0ZW0ucGFyZW50Tm9kZSA9IHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFByb3BlcnRpZXMoaW5zdGFuY2U6IGFueSk6IE1hcDxzdHJpbmcsIHN0cmluZz4ge1xuICAgIGNvbnN0IHR5cGUgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5jb25zdHJ1Y3RvcjtcbiAgICBpZiAoIXR5cGUpIHtcbiAgICAgIHJldHVybiBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICAgIH1cblxuICAgIGlmICghcHJvcGVydHlNYXBzLmhhcyh0eXBlKSkge1xuICAgICAgbGV0IHByb3BNYXAgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICAgICAgZm9yIChsZXQgcHJvcE5hbWUgaW4gaW5zdGFuY2UpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGU6Zm9yaW5cbiAgICAgICAgcHJvcE1hcC5zZXQocHJvcE5hbWUudG9Mb3dlckNhc2UoKSwgcHJvcE5hbWUpO1xuICAgICAgfVxuICAgICAgcHJvcGVydHlNYXBzLnNldCh0eXBlLCBwcm9wTWFwKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJvcGVydHlNYXBzLmdldCh0eXBlKTtcbiAgfVxuXG4gIHByaXZhdGUgY3NzQ2xhc3Nlcyh2aWV3OiBOZ1ZpZXcpIHtcbiAgICBpZiAoIXZpZXcubmdDc3NDbGFzc2VzKSB7XG4gICAgICB2aWV3Lm5nQ3NzQ2xhc3NlcyA9IG5ldyBNYXA8c3RyaW5nLCBib29sZWFuPigpO1xuICAgIH1cbiAgICByZXR1cm4gdmlldy5uZ0Nzc0NsYXNzZXM7XG4gIH1cblxuICBwdWJsaWMgYWRkQ2xhc3ModmlldzogVmlldyB8IE5nVmlldywgY2xhc3NOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBleHRlbmRlZFZpZXcgPSB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnModmlldyk7XG4gICAgdGhpcy5jc3NDbGFzc2VzKGV4dGVuZGVkVmlldykuc2V0KGNsYXNzTmFtZSwgdHJ1ZSk7XG4gICAgdGhpcy5zeW5jQ2xhc3NlcyhleHRlbmRlZFZpZXcpO1xuICB9XG5cbiAgcHVibGljIHJlbW92ZUNsYXNzKHZpZXc6IFZpZXcsIGNsYXNzTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgZXh0ZW5kZWRWaWV3ID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHZpZXcpO1xuICAgIHRoaXMuY3NzQ2xhc3NlcyhleHRlbmRlZFZpZXcpLmRlbGV0ZShjbGFzc05hbWUpO1xuICAgIHRoaXMuc3luY0NsYXNzZXMoZXh0ZW5kZWRWaWV3KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q2xhc3Nlcyh2aWV3OiBOZ1ZpZXcsIGNsYXNzZXNWYWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgbGV0IGNsYXNzZXMgPSBjbGFzc2VzVmFsdWUuc3BsaXQod2hpdGVTcGFjZVNwbGl0dGVyKTtcbiAgICB0aGlzLmNzc0NsYXNzZXModmlldykuY2xlYXIoKTtcbiAgICBjbGFzc2VzLmZvckVhY2goKGNsYXNzTmFtZSkgPT4gdGhpcy5jc3NDbGFzc2VzKHZpZXcpLnNldChjbGFzc05hbWUsIHRydWUpKTtcbiAgICB0aGlzLnN5bmNDbGFzc2VzKHZpZXcpO1xuICB9XG5cbiAgcHJpdmF0ZSBzeW5jQ2xhc3Nlcyh2aWV3OiBOZ1ZpZXcpOiB2b2lkIHtcbiAgICBsZXQgY2xhc3NWYWx1ZSA9ICg8YW55PkFycmF5KS5mcm9tKHRoaXMuY3NzQ2xhc3Nlcyh2aWV3KS5rZXlzKCkpLmpvaW4oJyAnKTtcbiAgICB2aWV3LmNsYXNzTmFtZSA9IGNsYXNzVmFsdWU7XG4gIH1cblxuICBwdWJsaWMgc2V0U3R5bGUodmlldzogVmlldywgc3R5bGVOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICB2aWV3LnN0eWxlW3N0eWxlTmFtZV0gPSB2YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVTdHlsZSh2aWV3OiBWaWV3LCBzdHlsZU5hbWU6IHN0cmluZykge1xuICAgIHZpZXcuc3R5bGVbc3R5bGVOYW1lXSA9IHVuc2V0VmFsdWU7XG4gIH1cbn1cbiJdfQ==