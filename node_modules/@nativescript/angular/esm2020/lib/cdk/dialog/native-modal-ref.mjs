import { __decorate, __metadata, __param } from "tslib";
import { ApplicationRef, ComponentFactoryResolver, Injector, Optional, ɵmarkDirty } from '@angular/core';
import { ContentView, Application, Frame } from '@nativescript/core';
import { fromEvent, Subject } from 'rxjs';
import { take } from 'rxjs/operators';
import { AppHostAsyncView, AppHostView } from '../../app-host-view';
import { NSLocationStrategy } from '../../legacy/router/ns-location-strategy';
import { once } from '../../utils/general';
import { DetachedLoader } from '../detached-loader';
import { NativeScriptDomPortalOutlet } from '../portal/nsdom-portal-outlet';
import { NativeDialogConfig } from './dialog-config';
import { NgViewRef } from '../../view-refs';
let NativeModalRef = class NativeModalRef {
    constructor(_config, _injector, location) {
        this._config = _config;
        this._injector = _injector;
        this.location = location;
        this.stateChanged = new Subject();
        this.onDismiss = new Subject();
        let parentView = this._config.viewContainerRef?.element.nativeElement || Application.getRootView();
        if ((parentView instanceof AppHostView || parentView instanceof AppHostAsyncView) && parentView.ngAppRoot) {
            parentView = parentView.ngAppRoot;
        }
        // _ngDialogRoot is the first child of the previously detached proxy.
        // It should have 'viewController' (iOS) or '_dialogFragment' (Android) available for
        // presenting future modal views.
        if (parentView._ngDialogRoot) {
            parentView = parentView._ngDialogRoot;
        }
        this.parentView = parentView;
        this._closeCallback = once(() => {
            this.stateChanged.next({ state: 'closing' });
            this.modalViewRef.firstNativeLikeView?.closeModal();
            this.location?._closeModalNavigation();
            // this.detachedLoaderRef?.destroy();
            if (this.modalViewRef?.firstNativeLikeView.isLoaded) {
                fromEvent(this.modalViewRef.firstNativeLikeView, 'unloaded')
                    .pipe(take(1))
                    .subscribe(() => this.stateChanged.next({ state: 'closed' }));
            }
            else {
                this.stateChanged.next({ state: 'closed' });
            }
        });
    }
    _generateDetachedContainer(vcRef) {
        const detachedFactory = (this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver)).resolveComponentFactory(DetachedLoader);
        if (vcRef) {
            this.detachedLoaderRef = vcRef.createComponent(detachedFactory);
        }
        else {
            this.detachedLoaderRef = detachedFactory.create(this._config.viewContainerRef?.injector || this._injector);
            this._injector.get(ApplicationRef).attachView(this.detachedLoaderRef.hostView);
        }
        this.detachedLoaderRef.changeDetectorRef.detectChanges();
    }
    attachTemplatePortal(portal) {
        this.startModalNavigation();
        const vcRef = portal.viewContainerRef || this._config.viewContainerRef;
        this._generateDetachedContainer(vcRef);
        portal.viewContainerRef = this.detachedLoaderRef.instance.vc;
        const targetView = new ContentView();
        this.portalOutlet = new NativeScriptDomPortalOutlet(targetView, this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver), this._injector.get(ApplicationRef), this._injector);
        const templateRef = this.portalOutlet.attach(portal);
        this.modalViewRef = new NgViewRef(templateRef);
        this.modalViewRef.firstNativeLikeView['__ng_modal_id__'] = this._id;
        // if we don't detach the view from its parent, ios gets mad
        this.modalViewRef.detachNativeLikeView();
        const userOptions = this._config.nativeOptions || {};
        this.parentView.showModal(this.modalViewRef.firstNativeLikeView, {
            context: null,
            ...userOptions,
            closeCallback: () => {
                this.location?._closeModalNavigation();
                this.onDismiss.next();
                this.onDismiss.complete();
            },
            cancelable: !this._config.disableClose,
        });
        //   if (this.modalView !== templateRef.rootNodes[0]) {
        //     componentRef.location.nativeElement._ngDialogRoot = this.modalView;
        //   }
        return templateRef;
    }
    attachComponentPortal(portal) {
        this.startModalNavigation();
        const targetView = new ContentView();
        this.portalOutlet = new NativeScriptDomPortalOutlet(targetView, this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver), this._injector.get(ApplicationRef), this._injector);
        const componentRef = this.portalOutlet.attach(portal);
        ɵmarkDirty(componentRef.instance);
        this.modalViewRef = new NgViewRef(componentRef);
        if (this.modalViewRef.firstNativeLikeView !== this.modalViewRef.view) {
            this.modalViewRef.view._ngDialogRoot = this.modalViewRef.firstNativeLikeView;
        }
        this.modalViewRef.firstNativeLikeView['__ng_modal_id__'] = this._id;
        // if we don't detach the view from its parent, ios gets mad
        this.modalViewRef.detachNativeLikeView();
        const userOptions = this._config.nativeOptions || {};
        this.parentView.showModal(this.modalViewRef.firstNativeLikeView, {
            context: null,
            ...userOptions,
            closeCallback: () => {
                this.location?._closeModalNavigation();
                this.onDismiss.next();
                this.onDismiss.complete();
            },
            cancelable: !this._config.disableClose,
        });
        return componentRef;
    }
    _startExitAnimation() {
        this._closeCallback();
    }
    dispose() {
        this.portalOutlet.dispose();
    }
    startModalNavigation() {
        const frame = this.parentView instanceof Frame ? this.parentView : this.parentView?.page?.frame || Frame.topmost();
        this.location?._beginModalNavigation(frame);
    }
};
NativeModalRef = __decorate([
    __param(2, Optional()),
    __metadata("design:paramtypes", [NativeDialogConfig, Injector, NSLocationStrategy])
], NativeModalRef);
export { NativeModalRef };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlLW1vZGFsLXJlZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2FuZ3VsYXIvc3JjL2xpYi9jZGsvZGlhbG9nL25hdGl2ZS1tb2RhbC1yZWYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsd0JBQXdCLEVBQWlDLFFBQVEsRUFBRSxRQUFRLEVBQW9CLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxSixPQUFPLEVBQUUsV0FBVyxFQUFRLFdBQVcsRUFBRSxLQUFLLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMzRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBQzlFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFcEQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDNUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDckQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTVDLElBQWEsY0FBYyxHQUEzQixNQUFhLGNBQWM7SUFZekIsWUFBb0IsT0FBMkIsRUFBVSxTQUFtQixFQUFzQixRQUE2QjtRQUEzRyxZQUFPLEdBQVAsT0FBTyxDQUFvQjtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQVU7UUFBc0IsYUFBUSxHQUFSLFFBQVEsQ0FBcUI7UUFWL0gsaUJBQVksR0FB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QVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLG1CQUFtQixFQUFFO1lBQy9ELE9BQU8sRUFBRSxJQUFJO1lBQ2IsR0FBRyxXQUFXO1lBQ2QsYUFBYSxFQUFFLEdBQUcsRUFBRTtnQkFDbEIsSUFBSSxDQUFDLFFBQVEsRUFBRSxxQkFBcUIsRUFBRSxDQUFDO2dCQUN2QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUN0QixJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzVCLENBQUM7WUFDRCxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVk7U0FDdkMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUVELG1CQUFtQjtRQUNqQixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVELE9BQU87UUFDTCxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFDTyxvQkFBb0I7UUFDMUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLEtBQUssSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFbkgsSUFBSSxDQUFDLFFBQVEsRUFBRSxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM5QyxDQUFDO0NBQ0YsQ0FBQTtBQTVIWSxjQUFjO0lBWXNELFdBQUEsUUFBUSxFQUFFLENBQUE7cUNBQTVELGtCQUFrQixFQUFxQixRQUFRLEVBQWlDLGtCQUFrQjtHQVpwSCxjQUFjLENBNEgxQjtTQTVIWSxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwbGljYXRpb25SZWYsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBFbWJlZGRlZFZpZXdSZWYsIEluamVjdG9yLCBPcHRpb25hbCwgVmlld0NvbnRhaW5lclJlZiwgybVtYXJrRGlydHkgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbnRlbnRWaWV3LCBWaWV3LCBBcHBsaWNhdGlvbiwgRnJhbWUgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuaW1wb3J0IHsgZnJvbUV2ZW50LCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQXBwSG9zdEFzeW5jVmlldywgQXBwSG9zdFZpZXcgfSBmcm9tICcuLi8uLi9hcHAtaG9zdC12aWV3JztcbmltcG9ydCB7IE5TTG9jYXRpb25TdHJhdGVneSB9IGZyb20gJy4uLy4uL2xlZ2FjeS9yb3V0ZXIvbnMtbG9jYXRpb24tc3RyYXRlZ3knO1xuaW1wb3J0IHsgb25jZSB9IGZyb20gJy4uLy4uL3V0aWxzL2dlbmVyYWwnO1xuaW1wb3J0IHsgRGV0YWNoZWRMb2FkZXIgfSBmcm9tICcuLi9kZXRhY2hlZC1sb2FkZXInO1xuaW1wb3J0IHsgQ29tcG9uZW50UG9ydGFsLCBUZW1wbGF0ZVBvcnRhbCB9IGZyb20gJy4uL3BvcnRhbC9jb21tb24nO1xuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RG9tUG9ydGFsT3V0bGV0IH0gZnJvbSAnLi4vcG9ydGFsL25zZG9tLXBvcnRhbC1vdXRsZXQnO1xuaW1wb3J0IHsgTmF0aXZlRGlhbG9nQ29uZmlnIH0gZnJvbSAnLi9kaWFsb2ctY29uZmlnJztcbmltcG9ydCB7IE5nVmlld1JlZiB9IGZyb20gJy4uLy4uL3ZpZXctcmVmcyc7XG5cbmV4cG9ydCBjbGFzcyBOYXRpdmVNb2RhbFJlZiB7XG4gIF9pZDogc3RyaW5nO1xuICBzdGF0ZUNoYW5nZWQgPSBuZXcgU3ViamVjdDx7IHN0YXRlOiAnb3BlbmVkJyB8ICdjbG9zZWQnIHwgJ2Nsb3NpbmcnIH0+KCk7XG4gIG9uRGlzbWlzcyA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgcGFyZW50VmlldzogVmlldztcbiAgcG9ydGFsT3V0bGV0OiBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQ7XG4gIGRldGFjaGVkTG9hZGVyUmVmOiBDb21wb25lbnRSZWY8RGV0YWNoZWRMb2FkZXI+O1xuICBtb2RhbFZpZXdSZWY6IE5nVmlld1JlZjxhbnk+O1xuXG4gIHByaXZhdGUgX2Nsb3NlQ2FsbGJhY2s6ICgpID0+IHZvaWQ7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfY29uZmlnOiBOYXRpdmVEaWFsb2dDb25maWcsIHByaXZhdGUgX2luamVjdG9yOiBJbmplY3RvciwgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsb2NhdGlvbj86IE5TTG9jYXRpb25TdHJhdGVneSkge1xuICAgIGxldCBwYXJlbnRWaWV3ID0gdGhpcy5fY29uZmlnLnZpZXdDb250YWluZXJSZWY/LmVsZW1lbnQubmF0aXZlRWxlbWVudCB8fCBBcHBsaWNhdGlvbi5nZXRSb290VmlldygpO1xuXG4gICAgaWYgKChwYXJlbnRWaWV3IGluc3RhbmNlb2YgQXBwSG9zdFZpZXcgfHwgcGFyZW50VmlldyBpbnN0YW5jZW9mIEFwcEhvc3RBc3luY1ZpZXcpICYmIHBhcmVudFZpZXcubmdBcHBSb290KSB7XG4gICAgICBwYXJlbnRWaWV3ID0gcGFyZW50Vmlldy5uZ0FwcFJvb3Q7XG4gICAgfVxuXG4gICAgLy8gX25nRGlhbG9nUm9vdCBpcyB0aGUgZmlyc3QgY2hpbGQgb2YgdGhlIHByZXZpb3VzbHkgZGV0YWNoZWQgcHJveHkuXG4gICAgLy8gSXQgc2hvdWxkIGhhdmUgJ3ZpZXdDb250cm9sbGVyJyAoaU9TKSBvciAnX2RpYWxvZ0ZyYWdtZW50JyAoQW5kcm9pZCkgYXZhaWxhYmxlIGZvclxuICAgIC8vIHByZXNlbnRpbmcgZnV0dXJlIG1vZGFsIHZpZXdzLlxuICAgIGlmIChwYXJlbnRWaWV3Ll9uZ0RpYWxvZ1Jvb3QpIHtcbiAgICAgIHBhcmVudFZpZXcgPSBwYXJlbnRWaWV3Ll9uZ0RpYWxvZ1Jvb3Q7XG4gICAgfVxuICAgIHRoaXMucGFyZW50VmlldyA9IHBhcmVudFZpZXc7XG5cbiAgICB0aGlzLl9jbG9zZUNhbGxiYWNrID0gb25jZSgoKSA9PiB7XG4gICAgICB0aGlzLnN0YXRlQ2hhbmdlZC5uZXh0KHsgc3RhdGU6ICdjbG9zaW5nJyB9KTtcbiAgICAgIHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXc/LmNsb3NlTW9kYWwoKTtcbiAgICAgIHRoaXMubG9jYXRpb24/Ll9jbG9zZU1vZGFsTmF2aWdhdGlvbigpO1xuICAgICAgLy8gdGhpcy5kZXRhY2hlZExvYWRlclJlZj8uZGVzdHJveSgpO1xuICAgICAgaWYgKHRoaXMubW9kYWxWaWV3UmVmPy5maXJzdE5hdGl2ZUxpa2VWaWV3LmlzTG9hZGVkKSB7XG4gICAgICAgIGZyb21FdmVudCh0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3LCAndW5sb2FkZWQnKVxuICAgICAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLnN0YXRlQ2hhbmdlZC5uZXh0KHsgc3RhdGU6ICdjbG9zZWQnIH0pKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc3RhdGVDaGFuZ2VkLm5leHQoeyBzdGF0ZTogJ2Nsb3NlZCcgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBfZ2VuZXJhdGVEZXRhY2hlZENvbnRhaW5lcih2Y1JlZj86IFZpZXdDb250YWluZXJSZWYpIHtcbiAgICBjb25zdCBkZXRhY2hlZEZhY3RvcnkgPSAodGhpcy5fY29uZmlnLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlciB8fCB0aGlzLl9pbmplY3Rvci5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKSkucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRGV0YWNoZWRMb2FkZXIpO1xuICAgIGlmICh2Y1JlZikge1xuICAgICAgdGhpcy5kZXRhY2hlZExvYWRlclJlZiA9IHZjUmVmLmNyZWF0ZUNvbXBvbmVudChkZXRhY2hlZEZhY3RvcnkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRldGFjaGVkTG9hZGVyUmVmID0gZGV0YWNoZWRGYWN0b3J5LmNyZWF0ZSh0aGlzLl9jb25maWcudmlld0NvbnRhaW5lclJlZj8uaW5qZWN0b3IgfHwgdGhpcy5faW5qZWN0b3IpO1xuICAgICAgdGhpcy5faW5qZWN0b3IuZ2V0KEFwcGxpY2F0aW9uUmVmKS5hdHRhY2hWaWV3KHRoaXMuZGV0YWNoZWRMb2FkZXJSZWYuaG9zdFZpZXcpO1xuICAgIH1cbiAgICB0aGlzLmRldGFjaGVkTG9hZGVyUmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIGF0dGFjaFRlbXBsYXRlUG9ydGFsPFQ+KHBvcnRhbDogVGVtcGxhdGVQb3J0YWw8VD4pOiBFbWJlZGRlZFZpZXdSZWY8VD4ge1xuICAgIHRoaXMuc3RhcnRNb2RhbE5hdmlnYXRpb24oKTtcbiAgICBjb25zdCB2Y1JlZiA9IHBvcnRhbC52aWV3Q29udGFpbmVyUmVmIHx8IHRoaXMuX2NvbmZpZy52aWV3Q29udGFpbmVyUmVmO1xuICAgIHRoaXMuX2dlbmVyYXRlRGV0YWNoZWRDb250YWluZXIodmNSZWYpO1xuICAgIHBvcnRhbC52aWV3Q29udGFpbmVyUmVmID0gdGhpcy5kZXRhY2hlZExvYWRlclJlZi5pbnN0YW5jZS52YztcbiAgICBjb25zdCB0YXJnZXRWaWV3ID0gbmV3IENvbnRlbnRWaWV3KCk7XG4gICAgdGhpcy5wb3J0YWxPdXRsZXQgPSBuZXcgTmF0aXZlU2NyaXB0RG9tUG9ydGFsT3V0bGV0KHRhcmdldFZpZXcsIHRoaXMuX2NvbmZpZy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfHwgdGhpcy5faW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciksIHRoaXMuX2luamVjdG9yLmdldChBcHBsaWNhdGlvblJlZiksIHRoaXMuX2luamVjdG9yKTtcbiAgICBjb25zdCB0ZW1wbGF0ZVJlZiA9IHRoaXMucG9ydGFsT3V0bGV0LmF0dGFjaChwb3J0YWwpO1xuICAgIHRoaXMubW9kYWxWaWV3UmVmID0gbmV3IE5nVmlld1JlZih0ZW1wbGF0ZVJlZik7XG4gICAgdGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlld1snX19uZ19tb2RhbF9pZF9fJ10gPSB0aGlzLl9pZDtcbiAgICAvLyBpZiB3ZSBkb24ndCBkZXRhY2ggdGhlIHZpZXcgZnJvbSBpdHMgcGFyZW50LCBpb3MgZ2V0cyBtYWRcbiAgICB0aGlzLm1vZGFsVmlld1JlZi5kZXRhY2hOYXRpdmVMaWtlVmlldygpO1xuXG4gICAgY29uc3QgdXNlck9wdGlvbnMgPSB0aGlzLl9jb25maWcubmF0aXZlT3B0aW9ucyB8fCB7fTtcbiAgICB0aGlzLnBhcmVudFZpZXcuc2hvd01vZGFsKHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXcsIHtcbiAgICAgIGNvbnRleHQ6IG51bGwsXG4gICAgICAuLi51c2VyT3B0aW9ucyxcbiAgICAgIGNsb3NlQ2FsbGJhY2s6ICgpID0+IHtcbiAgICAgICAgdGhpcy5sb2NhdGlvbj8uX2Nsb3NlTW9kYWxOYXZpZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMub25EaXNtaXNzLm5leHQoKTtcbiAgICAgICAgdGhpcy5vbkRpc21pc3MuY29tcGxldGUoKTtcbiAgICAgIH0sXG4gICAgICBjYW5jZWxhYmxlOiAhdGhpcy5fY29uZmlnLmRpc2FibGVDbG9zZSxcbiAgICB9KTtcbiAgICAvLyAgIGlmICh0aGlzLm1vZGFsVmlldyAhPT0gdGVtcGxhdGVSZWYucm9vdE5vZGVzWzBdKSB7XG4gICAgLy8gICAgIGNvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50Ll9uZ0RpYWxvZ1Jvb3QgPSB0aGlzLm1vZGFsVmlldztcbiAgICAvLyAgIH1cbiAgICByZXR1cm4gdGVtcGxhdGVSZWY7XG4gIH1cblxuICBhdHRhY2hDb21wb25lbnRQb3J0YWw8VD4ocG9ydGFsOiBDb21wb25lbnRQb3J0YWw8VD4pOiBDb21wb25lbnRSZWY8VD4ge1xuICAgIHRoaXMuc3RhcnRNb2RhbE5hdmlnYXRpb24oKTtcblxuICAgIGNvbnN0IHRhcmdldFZpZXcgPSBuZXcgQ29udGVudFZpZXcoKTtcbiAgICB0aGlzLnBvcnRhbE91dGxldCA9IG5ldyBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQodGFyZ2V0VmlldywgdGhpcy5fY29uZmlnLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlciB8fCB0aGlzLl9pbmplY3Rvci5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKSwgdGhpcy5faW5qZWN0b3IuZ2V0KEFwcGxpY2F0aW9uUmVmKSwgdGhpcy5faW5qZWN0b3IpO1xuICAgIGNvbnN0IGNvbXBvbmVudFJlZiA9IHRoaXMucG9ydGFsT3V0bGV0LmF0dGFjaChwb3J0YWwpO1xuICAgIMm1bWFya0RpcnR5KGNvbXBvbmVudFJlZi5pbnN0YW5jZSk7XG4gICAgdGhpcy5tb2RhbFZpZXdSZWYgPSBuZXcgTmdWaWV3UmVmKGNvbXBvbmVudFJlZik7XG4gICAgaWYgKHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXcgIT09IHRoaXMubW9kYWxWaWV3UmVmLnZpZXcpIHtcbiAgICAgICg8YW55PnRoaXMubW9kYWxWaWV3UmVmLnZpZXcpLl9uZ0RpYWxvZ1Jvb3QgPSB0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3O1xuICAgIH1cbiAgICB0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3WydfX25nX21vZGFsX2lkX18nXSA9IHRoaXMuX2lkO1xuICAgIC8vIGlmIHdlIGRvbid0IGRldGFjaCB0aGUgdmlldyBmcm9tIGl0cyBwYXJlbnQsIGlvcyBnZXRzIG1hZFxuICAgIHRoaXMubW9kYWxWaWV3UmVmLmRldGFjaE5hdGl2ZUxpa2VWaWV3KCk7XG5cbiAgICBjb25zdCB1c2VyT3B0aW9ucyA9IHRoaXMuX2NvbmZpZy5uYXRpdmVPcHRpb25zIHx8IHt9O1xuICAgIHRoaXMucGFyZW50Vmlldy5zaG93TW9kYWwodGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldywge1xuICAgICAgY29udGV4dDogbnVsbCxcbiAgICAgIC4uLnVzZXJPcHRpb25zLFxuICAgICAgY2xvc2VDYWxsYmFjazogKCkgPT4ge1xuICAgICAgICB0aGlzLmxvY2F0aW9uPy5fY2xvc2VNb2RhbE5hdmlnYXRpb24oKTtcbiAgICAgICAgdGhpcy5vbkRpc21pc3MubmV4dCgpO1xuICAgICAgICB0aGlzLm9uRGlzbWlzcy5jb21wbGV0ZSgpO1xuICAgICAgfSxcbiAgICAgIGNhbmNlbGFibGU6ICF0aGlzLl9jb25maWcuZGlzYWJsZUNsb3NlLFxuICAgIH0pO1xuICAgIHJldHVybiBjb21wb25lbnRSZWY7XG4gIH1cblxuICBfc3RhcnRFeGl0QW5pbWF0aW9uKCkge1xuICAgIHRoaXMuX2Nsb3NlQ2FsbGJhY2soKTtcbiAgfVxuXG4gIGRpc3Bvc2UoKSB7XG4gICAgdGhpcy5wb3J0YWxPdXRsZXQuZGlzcG9zZSgpO1xuICB9XG4gIHByaXZhdGUgc3RhcnRNb2RhbE5hdmlnYXRpb24oKSB7XG4gICAgY29uc3QgZnJhbWUgPSB0aGlzLnBhcmVudFZpZXcgaW5zdGFuY2VvZiBGcmFtZSA/IHRoaXMucGFyZW50VmlldyA6IHRoaXMucGFyZW50Vmlldz8ucGFnZT8uZnJhbWUgfHwgRnJhbWUudG9wbW9zdCgpO1xuXG4gICAgdGhpcy5sb2NhdGlvbj8uX2JlZ2luTW9kYWxOYXZpZ2F0aW9uKGZyYW1lKTtcbiAgfVxufVxuIl19