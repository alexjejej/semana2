import { ViewContainerRef, Component, ComponentFactoryResolver, ChangeDetectorRef, ApplicationRef, ViewChild } from '@angular/core';
import { ProxyViewContainer, Trace } from '@nativescript/core';
import { ComponentPortal, TemplatePortal } from './portal';
import { registerElement } from '../element-registry';
import * as i0 from "@angular/core";
registerElement('DetachedContainer', () => ProxyViewContainer, {
    skipAddToDom: true,
});
/**
 * Wrapper component used for loading components when navigating
 * It uses DetachedContainer as selector so that it is containerRef is not attached to
 * the visual tree.
 */
// eslint-disable-next-line @angular-eslint/component-class-suffix
export class DetachedLoader {
    // tslint:disable-line:component-class-suffix
    constructor(resolver, changeDetector, containerRef, appRef) {
        this.resolver = resolver;
        this.changeDetector = changeDetector;
        this.containerRef = containerRef;
        this.appRef = appRef;
        this.disposeFunctions = [];
    }
    createComponentPortal(componentType, customInjector) {
        return new ComponentPortal(componentType, this.vc, customInjector || this.vc.injector);
    }
    createTemplatePortal(templateRef, context) {
        return new TemplatePortal(templateRef, this.vc, context);
    }
    loadInLocation(componentType) {
        const factory = this.resolver.resolveComponentFactory(componentType);
        const componentRef = factory.create(this.containerRef.injector);
        this.appRef.attachView(componentRef.hostView);
        this.disposeFunctions.push(() => {
            this.appRef.detachView(componentRef.hostView);
            componentRef.destroy();
        });
        // Component is created, built may not be checked if we are loading
        // inside component with OnPush CD strategy. Mark us for check to be sure CD will reach us.
        // We are inside a promise here so no need for setTimeout - CD should trigger
        // after the promise.
        Trace.write('DetachedLoader.loadInLocation component loaded -> markForCheck', 'detached-loader');
        return componentRef;
    }
    ngOnDestroy() {
        this.disposeFunctions.forEach((fn) => fn());
    }
    detectChanges() {
        this.changeDetector.markForCheck();
    }
    /**
     * @deprecated use Portals
     */
    loadComponent(componentType) {
        Trace.write('DetachedLoader.loadComponent', 'detached-loader');
        return Promise.resolve(this.loadInLocation(componentType));
    }
    /**
     * @deprecated use Portals
     */
    loadComponentSync(componentType) {
        Trace.write('DetachedLoader.loadComponent', 'detached-loader');
        return this.loadInLocation(componentType);
    }
    /**
     * @deprecated use Portals
     */
    loadWithFactory(factory) {
        const componentRef = factory.create(this.containerRef.injector);
        this.appRef.attachView(componentRef.hostView);
        this.disposeFunctions.push(() => {
            this.appRef.detachView(componentRef.hostView);
            componentRef.destroy();
        });
        return componentRef;
    }
}
DetachedLoader.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: DetachedLoader, deps: [{ token: i0.ComponentFactoryResolver }, { token: i0.ChangeDetectorRef }, { token: i0.ViewContainerRef }, { token: i0.ApplicationRef }], target: i0.ɵɵFactoryTarget.Component });
DetachedLoader.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.1.1", type: DetachedLoader, selector: "DetachedContainer", viewQueries: [{ propertyName: "vc", first: true, predicate: ["vc"], descendants: true, read: ViewContainerRef, static: true }], ngImport: i0, template: `<Placeholder #loader></Placeholder><ng-container #vc></ng-container><ng-content></ng-content>`, isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.1", ngImport: i0, type: DetachedLoader, decorators: [{
            type: Component,
            args: [{
                    // eslint-disable-next-line @angular-eslint/component-selector
                    selector: 'DetachedContainer',
                    template: `<Placeholder #loader></Placeholder><ng-container #vc></ng-container><ng-content></ng-content>`,
                }]
        }], ctorParameters: function () { return [{ type: i0.ComponentFactoryResolver }, { type: i0.ChangeDetectorRef }, { type: i0.ViewContainerRef }, { type: i0.ApplicationRef }]; }, propDecorators: { vc: [{
                type: ViewChild,
                args: ['vc', { read: ViewContainerRef, static: true }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0YWNoZWQtbG9hZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL2Nkay9kZXRhY2hlZC1sb2FkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFrQyxnQkFBZ0IsRUFBRSxTQUFTLEVBQVEsd0JBQXdCLEVBQUUsaUJBQWlCLEVBQUUsY0FBYyxFQUEwQixTQUFTLEVBQVksTUFBTSxlQUFlLENBQUM7QUFDNU0sT0FBTyxFQUFFLGtCQUFrQixFQUFFLEtBQUssRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRTNELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7QUFFdEQsZUFBZSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRSxDQUFDLGtCQUFrQixFQUFFO0lBQzdELFlBQVksRUFBRSxJQUFJO0NBQ25CLENBQUMsQ0FBQztBQUVIOzs7O0dBSUc7QUFNSCxrRUFBa0U7QUFDbEUsTUFBTSxPQUFPLGNBQWM7SUFHekIsNkNBQTZDO0lBQzdDLFlBQW9CLFFBQWtDLEVBQVUsY0FBaUMsRUFBVSxZQUE4QixFQUFVLE1BQXNCO1FBQXJKLGFBQVEsR0FBUixRQUFRLENBQTBCO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQW1CO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWtCO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7UUFGaksscUJBQWdCLEdBQXNCLEVBQUUsQ0FBQztJQUUySCxDQUFDO0lBRXRLLHFCQUFxQixDQUFJLGFBQStCLEVBQUUsY0FBeUI7UUFDeEYsT0FBTyxJQUFJLGVBQWUsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxjQUFjLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN6RixDQUFDO0lBRU0sb0JBQW9CLENBQUksV0FBMkIsRUFBRSxPQUFXO1FBQ3JFLE9BQU8sSUFBSSxjQUFjLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVPLGNBQWMsQ0FBQyxhQUF3QjtRQUM3QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLHVCQUF1QixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3JFLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFOUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzlDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztRQUVILG1FQUFtRTtRQUNuRSwyRkFBMkY7UUFDM0YsNkVBQTZFO1FBQzdFLHFCQUFxQjtRQUNyQixLQUFLLENBQUMsS0FBSyxDQUFDLGdFQUFnRSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFFakcsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUVNLFdBQVc7UUFDaEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRU0sYUFBYTtRQUNsQixJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFFRDs7T0FFRztJQUNJLGFBQWEsQ0FBQyxhQUF3QjtRQUMzQyxLQUFLLENBQUMsS0FBSyxDQUFDLDhCQUE4QixFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDL0QsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxpQkFBaUIsQ0FBQyxhQUF3QjtRQUMvQyxLQUFLLENBQUMsS0FBSyxDQUFDLDhCQUE4QixFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDL0QsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRDs7T0FFRztJQUNJLGVBQWUsQ0FBSSxPQUE0QjtRQUNwRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTlDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQzlCLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM5QyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDOzsyR0FyRVUsY0FBYzsrRkFBZCxjQUFjLDhIQUNBLGdCQUFnQiwyQ0FKL0IsK0ZBQStGOzJGQUc5RixjQUFjO2tCQU4xQixTQUFTO21CQUFDO29CQUNULDhEQUE4RDtvQkFDOUQsUUFBUSxFQUFFLG1CQUFtQjtvQkFDN0IsUUFBUSxFQUFFLCtGQUErRjtpQkFDMUc7Mk1BRzRELEVBQUU7c0JBQTVELFNBQVM7dUJBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRSZWYsIENvbXBvbmVudEZhY3RvcnksIFZpZXdDb250YWluZXJSZWYsIENvbXBvbmVudCwgVHlwZSwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBDaGFuZ2VEZXRlY3RvclJlZiwgQXBwbGljYXRpb25SZWYsIE9uRGVzdHJveSwgVGVtcGxhdGVSZWYsIFZpZXdDaGlsZCwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFByb3h5Vmlld0NvbnRhaW5lciwgVHJhY2UgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuaW1wb3J0IHsgQ29tcG9uZW50UG9ydGFsLCBUZW1wbGF0ZVBvcnRhbCB9IGZyb20gJy4vcG9ydGFsJztcbmltcG9ydCB0eXBlIHsgQ29tcG9uZW50VHlwZSB9IGZyb20gJy4uL3V0aWxzL2dlbmVyYWwnO1xuaW1wb3J0IHsgcmVnaXN0ZXJFbGVtZW50IH0gZnJvbSAnLi4vZWxlbWVudC1yZWdpc3RyeSc7XG5cbnJlZ2lzdGVyRWxlbWVudCgnRGV0YWNoZWRDb250YWluZXInLCAoKSA9PiBQcm94eVZpZXdDb250YWluZXIsIHtcbiAgc2tpcEFkZFRvRG9tOiB0cnVlLFxufSk7XG5cbi8qKlxuICogV3JhcHBlciBjb21wb25lbnQgdXNlZCBmb3IgbG9hZGluZyBjb21wb25lbnRzIHdoZW4gbmF2aWdhdGluZ1xuICogSXQgdXNlcyBEZXRhY2hlZENvbnRhaW5lciBhcyBzZWxlY3RvciBzbyB0aGF0IGl0IGlzIGNvbnRhaW5lclJlZiBpcyBub3QgYXR0YWNoZWQgdG9cbiAqIHRoZSB2aXN1YWwgdHJlZS5cbiAqL1xuQENvbXBvbmVudCh7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvY29tcG9uZW50LXNlbGVjdG9yXG4gIHNlbGVjdG9yOiAnRGV0YWNoZWRDb250YWluZXInLFxuICB0ZW1wbGF0ZTogYDxQbGFjZWhvbGRlciAjbG9hZGVyPjwvUGxhY2Vob2xkZXI+PG5nLWNvbnRhaW5lciAjdmM+PC9uZy1jb250YWluZXI+PG5nLWNvbnRlbnQ+PC9uZy1jb250ZW50PmAsXG59KVxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9jb21wb25lbnQtY2xhc3Mtc3VmZml4XG5leHBvcnQgY2xhc3MgRGV0YWNoZWRMb2FkZXIgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBAVmlld0NoaWxkKCd2YycsIHsgcmVhZDogVmlld0NvbnRhaW5lclJlZiwgc3RhdGljOiB0cnVlIH0pIHZjOiBWaWV3Q29udGFpbmVyUmVmO1xuICBwcml2YXRlIGRpc3Bvc2VGdW5jdGlvbnM6IEFycmF5PCgpID0+IHZvaWQ+ID0gW107XG4gIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6Y29tcG9uZW50LWNsYXNzLXN1ZmZpeFxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIHByaXZhdGUgY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmLCBwcml2YXRlIGNvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZiwgcHJpdmF0ZSBhcHBSZWY6IEFwcGxpY2F0aW9uUmVmKSB7fVxuXG4gIHB1YmxpYyBjcmVhdGVDb21wb25lbnRQb3J0YWw8VD4oY29tcG9uZW50VHlwZTogQ29tcG9uZW50VHlwZTxUPiwgY3VzdG9tSW5qZWN0b3I/OiBJbmplY3Rvcikge1xuICAgIHJldHVybiBuZXcgQ29tcG9uZW50UG9ydGFsKGNvbXBvbmVudFR5cGUsIHRoaXMudmMsIGN1c3RvbUluamVjdG9yIHx8IHRoaXMudmMuaW5qZWN0b3IpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVRlbXBsYXRlUG9ydGFsPFQ+KHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxUPiwgY29udGV4dD86IFQpIHtcbiAgICByZXR1cm4gbmV3IFRlbXBsYXRlUG9ydGFsKHRlbXBsYXRlUmVmLCB0aGlzLnZjLCBjb250ZXh0KTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZEluTG9jYXRpb24oY29tcG9uZW50VHlwZTogVHlwZTxhbnk+KTogQ29tcG9uZW50UmVmPGFueT4ge1xuICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLnJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudFR5cGUpO1xuICAgIGNvbnN0IGNvbXBvbmVudFJlZiA9IGZhY3RvcnkuY3JlYXRlKHRoaXMuY29udGFpbmVyUmVmLmluamVjdG9yKTtcbiAgICB0aGlzLmFwcFJlZi5hdHRhY2hWaWV3KGNvbXBvbmVudFJlZi5ob3N0Vmlldyk7XG5cbiAgICB0aGlzLmRpc3Bvc2VGdW5jdGlvbnMucHVzaCgoKSA9PiB7XG4gICAgICB0aGlzLmFwcFJlZi5kZXRhY2hWaWV3KGNvbXBvbmVudFJlZi5ob3N0Vmlldyk7XG4gICAgICBjb21wb25lbnRSZWYuZGVzdHJveSgpO1xuICAgIH0pO1xuXG4gICAgLy8gQ29tcG9uZW50IGlzIGNyZWF0ZWQsIGJ1aWx0IG1heSBub3QgYmUgY2hlY2tlZCBpZiB3ZSBhcmUgbG9hZGluZ1xuICAgIC8vIGluc2lkZSBjb21wb25lbnQgd2l0aCBPblB1c2ggQ0Qgc3RyYXRlZ3kuIE1hcmsgdXMgZm9yIGNoZWNrIHRvIGJlIHN1cmUgQ0Qgd2lsbCByZWFjaCB1cy5cbiAgICAvLyBXZSBhcmUgaW5zaWRlIGEgcHJvbWlzZSBoZXJlIHNvIG5vIG5lZWQgZm9yIHNldFRpbWVvdXQgLSBDRCBzaG91bGQgdHJpZ2dlclxuICAgIC8vIGFmdGVyIHRoZSBwcm9taXNlLlxuICAgIFRyYWNlLndyaXRlKCdEZXRhY2hlZExvYWRlci5sb2FkSW5Mb2NhdGlvbiBjb21wb25lbnQgbG9hZGVkIC0+IG1hcmtGb3JDaGVjaycsICdkZXRhY2hlZC1sb2FkZXInKTtcblxuICAgIHJldHVybiBjb21wb25lbnRSZWY7XG4gIH1cblxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kaXNwb3NlRnVuY3Rpb25zLmZvckVhY2goKGZuKSA9PiBmbigpKTtcbiAgfVxuXG4gIHB1YmxpYyBkZXRlY3RDaGFuZ2VzKCkge1xuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IubWFya0ZvckNoZWNrKCk7XG4gIH1cblxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgdXNlIFBvcnRhbHNcbiAgICovXG4gIHB1YmxpYyBsb2FkQ29tcG9uZW50KGNvbXBvbmVudFR5cGU6IFR5cGU8YW55Pik6IFByb21pc2U8Q29tcG9uZW50UmVmPGFueT4+IHtcbiAgICBUcmFjZS53cml0ZSgnRGV0YWNoZWRMb2FkZXIubG9hZENvbXBvbmVudCcsICdkZXRhY2hlZC1sb2FkZXInKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMubG9hZEluTG9jYXRpb24oY29tcG9uZW50VHlwZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIHVzZSBQb3J0YWxzXG4gICAqL1xuICBwdWJsaWMgbG9hZENvbXBvbmVudFN5bmMoY29tcG9uZW50VHlwZTogVHlwZTxhbnk+KTogQ29tcG9uZW50UmVmPGFueT4ge1xuICAgIFRyYWNlLndyaXRlKCdEZXRhY2hlZExvYWRlci5sb2FkQ29tcG9uZW50JywgJ2RldGFjaGVkLWxvYWRlcicpO1xuICAgIHJldHVybiB0aGlzLmxvYWRJbkxvY2F0aW9uKGNvbXBvbmVudFR5cGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIHVzZSBQb3J0YWxzXG4gICAqL1xuICBwdWJsaWMgbG9hZFdpdGhGYWN0b3J5PFQ+KGZhY3Rvcnk6IENvbXBvbmVudEZhY3Rvcnk8VD4pOiBDb21wb25lbnRSZWY8VD4ge1xuICAgIGNvbnN0IGNvbXBvbmVudFJlZiA9IGZhY3RvcnkuY3JlYXRlKHRoaXMuY29udGFpbmVyUmVmLmluamVjdG9yKTtcbiAgICB0aGlzLmFwcFJlZi5hdHRhY2hWaWV3KGNvbXBvbmVudFJlZi5ob3N0Vmlldyk7XG5cbiAgICB0aGlzLmRpc3Bvc2VGdW5jdGlvbnMucHVzaCgoKSA9PiB7XG4gICAgICB0aGlzLmFwcFJlZi5kZXRhY2hWaWV3KGNvbXBvbmVudFJlZi5ob3N0Vmlldyk7XG4gICAgICBjb21wb25lbnRSZWYuZGVzdHJveSgpO1xuICAgIH0pO1xuICAgIHJldHVybiBjb21wb25lbnRSZWY7XG4gIH1cbn1cbiJdfQ==